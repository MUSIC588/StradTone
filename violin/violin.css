// ===== æ ¸å¿ƒä¿®æ”¹é‚è¼¯ =====

// éœ€æ±‚ 4: è¦–çª—æ›é è‡ªå‹•æš«åœå½±éŸ³
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    const iframe = document.getElementById("video-iframe");
    const audio = document.getElementById("audio-player");
    if (audio) audio.pause();
    // iframe (YouTube) éœ€é€é postMessage æš«åœï¼Œæˆ–ç›´æ¥æ¸…é™¤ src
    if (iframe && iframe.src) {
        const currentSrc = iframe.src;
        iframe.src = ""; // å¼·åˆ¶åœæ­¢
        iframe.setAttribute('data-last-src', currentSrc); // æš«å­˜ä½ç½®
    }
  }
});

// éœ€æ±‚ 1 & 2: å–æ¶ˆè¼ªæ’­ï¼Œæ”¹ç‚ºè‡ªå‹•é–‹å•Ÿç¬¬ä¸€ç­†å½±ç‰‡
async function loadComments() {
  const res = await fetch(API_URL + "?action=list", { cache: "no-cache" });
  const data = await res.json();
  commentsCache = data.posts || [];
  renderCommentsTable();
  
  // æ‰¾å°‹ç¬¬ä¸€ç­†æœ‰å½±ç‰‡æˆ–éŒ„éŸ³çš„é …ç›®
  const firstMedia = commentsCache.slice().reverse().find(row => 
    row.type === 'youtube' || row.type === 'upload' || row.type === 'audio');
  if (firstMedia) {
    selectRowForReply(firstMedia);
  }
}

// éœ€æ±‚ 3 & 7: è™•ç†ä¸­ç‹€æ…‹é–å®š
function setProcessingMode(isProcessing) {
  const submitBtn = document.getElementById("submit-btn");
  const saveBtn = document.getElementById("reply-save-btn");
  const replyBox = document.getElementById("admin-reply");
  
  if (isProcessing) {
    if (submitBtn) submitBtn.textContent = "è™•ç†ä¸­..";
    if (saveBtn) saveBtn.textContent = "è™•ç†ä¸­..";
    document.body.classList.add("no-interact");
    if (replyBox) replyBox.blur(); 
  } else {
    if (submitBtn) submitBtn.textContent = "ç™¼è¡¨";
    if (saveBtn) saveBtn.textContent = "å„²å­˜";
    document.body.classList.remove("no-interact");
  }
}

// éœ€æ±‚ 10 & 8: Back éµåªè·³è½‰ä¸é‡æ–°æ•´ç†
function setupBackButton() {
  const btn = document.getElementById("back-button");
  if (!btn) return;
  btn.addEventListener("click", (e) => {
    e.preventDefault(); // ç¦æ­¢é‡æ–°æ•´ç†
    window.scrollTo(0, 0); // å¼·åˆ¶è·³åˆ°é é ­
    document.body.scrollTop = 0; // é‡å°èˆŠç‰ˆ Safari/Chrome
  });
}

// éœ€æ±‚ 12: ä¿®æ­£éŒ„éŸ³é€²å…¥è³‡æ–™åº«çš„ Action (éŒ„éŸ³åœ–ç¤º)
// åœ¨ renderCommentsTable ç¢ºä¿ icons.push('ğŸµ') è¢«è§¸ç™¼

// éœ€æ±‚ 5: éŒ„éŸ³æ§åˆ¶é‚è¼¯ä¿®æ­£
btnPause.addEventListener("click", () => {
    if (!audioRecPaused) {
      audioRecPaused = true;
      btnPause.classList.add("paused-state");
      btnStart.classList.add("no-blink"); // åœ“é»ä¸é–ƒçˆ
      audioRecRecorder.pause();
    } else {
      audioRecPaused = false;
      btnPause.classList.remove("paused-state");
      btnStart.classList.remove("no-blink"); // æ¢å¾©é–ƒçˆ
      audioRecRecorder.resume();
    }
});

// éœ€æ±‚ 11: é©—è­‰å®Œæˆå¾Œçš„æ¨£å¼è™•ç†
function tryUnlockEditByName() {
  // ... åŸæœ‰é‚è¼¯
  if (typed === target) {
      nickEl.classList.add("verified"); // è§¸ç™¼æš—åº•èˆ‡ç¦æ­¢é»é¸
      nickEl.disabled = true;
      textEl.disabled = false;
      // ...
  }
}

// éœ€æ±‚ 9: äº’æ–¥æ¨£å¼ä¿®æ­£
function setMediaMode(mode) {
    const btnYt = document.getElementById("btn-media-youtube");
    if (mode && mode !== 'youtube') {
        btnYt.classList.add('inactive-style');
    } else {
        btnYt.classList.remove('inactive-style');
    }
    // ... åŸæœ‰ setMediaMode é‚è¼¯
}

// (å…¶é¤˜ JS ä»£ç¢¼è«‹æ¥çºŒæ‚¨åŸæœ¬çš„å…§å®¹ï¼Œå°‡ä¸Šè¿°è®Šå‹•é»æ›´æ–°è‡³å°æ‡‰ function å…§å³å¯)

