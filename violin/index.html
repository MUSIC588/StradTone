<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StradTone Violin</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, "Microsoft JhengHei", sans-serif;
      background: #222629;
      color: #f5f5f5;
    }

    .page {
      min-height: 100vh;
      padding: 12px;
      max-width: 1100px;
      margin: 0 auto;
    }

    /* éœ€æ±‚ 3-1: è™•ç†ä¸­ç‹€æ…‹çš„å…¨å±€è¦–è¦ºé–å®š */
    .is-processing .panel-left, 
    .is-processing .reply-area {
      pointer-events: none !important; /* å°é–é»æ“Šé …ç›®èˆ‡è¼¸å…¥ */
      opacity: 0.85;
    }
    /* éœ€æ±‚ 3-1: å¾¹åº•ç§»é™¤è¼¸å…¥æ¡†é–ƒçˆç›´ç·šï¼ˆæ¸¸æ¨™ï¼‰ */
    .is-processing input, 
    .is-processing textarea {
      caret-color: transparent !important;
      user-select: none !important;
    }

    header {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }

    header h1 { font-size: 20px; margin: 0; }
    header h2 { font-size: 14px; margin: 0; opacity: 0.8; }
    header small { font-size: 12px; opacity: 0.7; }

    main.layout {
      display: flex;
      gap: 12px;
      align-items: stretch;
    }

    .panel {
      background: #2d3236;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.35);
      min-height: 220px;
    }

    .panel-left  { flex: 0 0 40%; max-width: 40%; display: flex; flex-direction: column; }
    .panel-right { flex: 0 0 60%; max-width: 60%; display: flex; flex-direction: column; }

    h2 { font-size: 16px; margin: 0 0 4px; }

    .hint,
    .reply-note {
      font-size: 12px;
      line-height: 1.4;
      color: #222629;
    }

    .hidden { display: none !important; }

    input::placeholder,
    textarea::placeholder {
      color: #999;
      opacity: 0.7;
    }

/* [CSS-1] å·¦å´å·¥å…·åˆ— */
.toolbar {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
  flex-wrap: wrap;
}

.toolbar button {
  padding: 4px 10px;
  border-radius: 14px;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 12px;
  cursor: pointer;
}
.toolbar button:hover { background: #4a5056; }

form#community-form {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 8px;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #d1a343;
  background: #141b20;
  box-shadow: 0 0 10px rgba(0,0,0,0.65);
}
form#community-form label { font-size: 13px; display: block; }

form#community-form input[type="text"] {
  width: 100%;
  padding: 4px 6px;
  margin-top: 2px;
  border-radius: 4px;
  border: 1px solid #555;
  background: #1f2326;
  color: #f5f5f5;
  font-size: 13px;
}

form#community-form input[type="text"]:not(:disabled) { background: #ffffff; color: #111; }
form#community-form input[type="text"]:disabled { background: #1f2326; color: #999; }

.form-row-inline { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }

#submit-btn {
  padding: 4px 14px;
  border-radius: 16px;
  border: none;
  background: #d1a343;
  color: #1d1d1d;
  font-size: 13px;
  cursor: pointer;
}
#submit-btn:disabled, .reply-action-btn:disabled { opacity: 0.7; cursor: wait; }

.media-select-btn {
  padding: 3px 10px;
  border-radius: 14px;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 12px;
  cursor: pointer;
}
.media-select-btn.active { border-color: #d1a343; background: #e0b85f; color: #1d1d1d; font-weight: 600; }
#btn-media-youtube { background: #c00000; border-color: #ff5050; color: #111111; font-weight: 600; }
#btn-media-youtube.active { background: #ff0000; border-color: #ff8080; color: #000000; }

.media-record-toolbar { display: flex; align-items: center; gap: 6px; margin-top: 4px; font-size: 11px; }
.media-record-btn {
  width: 26px; height: 26px; border-radius: 50%; border: 1px solid #777;
  background: #3a3f44; color: #f5f5f5; font-size: 14px;
  display: flex; align-items: center; justify-content: center;
}
.media-record-btn.recording { color: #ff4b4b; border-color: #ff8080; background: #4a3a3a; animation: recordBlink 0.8s ease-in-out infinite; }

@keyframes recordBlink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

#audio-player { position: absolute; left: 0; right: 0; bottom: 0; width: 100%; background: #111315; display: none; }

.comments-wrapper { flex: 1 1 auto; overflow-y: auto; overflow-x: hidden; border-radius: 6px; border: 1px solid #444; background: #202427; }
table#comments-table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
table#comments-table thead { position: sticky; top: 0; background: #33383c; z-index: 1; }
table#comments-table th, table#comments-table td { border-bottom: 1px solid #333; padding: 4px 6px; text-align: left; vertical-align: top; word-wrap: break-word; }
#comments-tbody tr.selected { background: #4f7a3b !important; }
#back-button { margin-top: 6px; padding: 4px 10px; border-radius: 14px; border: 1px solid #777; background: #3a3f44; color: #f5f5f5; font-size: 12px; cursor: pointer; }

.video-frame-wrap { flex: 1 1 60%; background: #111315; border-radius: 6px; overflow: hidden; border: 1px solid #555; position: relative; min-height: 150px; }
.video-frame-wrap iframe { width: 100%; height: 100%; border: none; }
.video-placeholder { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999; text-align: center; }

.circle-stack { position: relative; width: 160px; height: 160px; border-radius: 50%; background: radial-gradient(circle at 20% 20%, #555, #111); }
.ring { position: absolute; border-radius: 50%; transition: border-color 0.12s ease, box-shadow 0.12s ease; }
.ring-main { border: 3px solid #5c7a5c; opacity: 0.8; }
.ring-boundary { border: 1.2px solid #9ad09a; opacity: 0.7; }
.ring-b45 { inset: 4%; } .ring-4 { inset: 10%; } .ring-b35 { inset: 20%; } .ring-3 { inset: 26%; } .ring-b25 { inset: 36%; } .ring-2 { inset: 42%; } .ring-b15 { inset: 52%; } .ring-1 { inset: 60%; }
.ring.active { border-color: #70ff70; opacity: 1; box-shadow: 0 0 10px rgba(140, 255, 140, 0.9); }

#admin-reply { width: 100%; background: #1f2326; border: 1px solid #555; color: #f5f5f5; font-size: 12px; border-radius: 4px; min-height: 80px; resize: none; overflow: hidden; line-height: 1.4; }
.reply-action-btn { padding: 3px 10px; border-radius: 14px; border: 1px solid #bbb; background: #f5f5f5; color: #222629; font-size: 12px; cursor: pointer; }

.fingerboard { position: relative; width: 120px; height: 260px; background: linear-gradient(180deg, #181a1d, #34383d); border-radius: 14px; overflow: hidden; border: 2px solid #676f78; }
.fb-string { position: absolute; top: 6%; bottom: 6%; width: 2px; background: #888; opacity: 0.9; }
.fb-s1 { left: 20%; } .fb-s2 { left: 40%; } .fb-s3 { left: 62%; } .fb-s4 { left: 80%; }

@media (max-width: 820px) {
  main.layout { flex-direction: column; }
  #visual-panel { order: 1; }
  #comments-section { order: 2; }
  .panel-left, .panel-right { max-width: 100%; width: 100%; }
  .video-frame-wrap { height: 160px !important; }
  .bottom-row { flex-direction: row; }
}
  </style>
</head>

<body>
  <div class="page" id="main-container">
    <header>
      <h1>StradTone Violin</h1>
      <h2>æç´è²å­¸å¯¦é©—å®¤</h2>
    </header>

    <main class="layout">
      <section class="panel panel-left" id="comments-section">
        <p class="hint">å°æç´</p>
        <div class="toolbar"><button type="button" id="btn-new">æ–°å¢</button></div>
        <form id="community-form" class="hidden">
          <label>usernameï¼š<input type="text" id="nickname-input" maxlength="12" placeholder="Mr,s 09â€¦." /></label>
          <label>é …ç›®ï¼š<input type="text" id="text-input" maxlength="100" placeholder="..." /></label>
          <div class="form-row-inline media-select-row">
            <button type="button" class="media-select-btn" id="btn-media-youtube" data-media="youtube">YouTube</button>
            <button type="button" class="media-select-btn" id="btn-media-upload" data-media="upload">å½±ç‰‡</button>
            <button type="button" class="media-select-btn" id="btn-media-audio" data-media="audio">éŒ„éŸ³</button>
          </div>
          <div id="video-fields" class="hidden">
            <div class="form-row-inline"><input type="text" id="youtube-url-input" placeholder="YouTube Link..." /></div>
            <div class="form-row-inline"><input type="file" id="video-file-input" /></div>
          </div>
          <div id="audio-fields" class="hidden">
            <div class="media-record-toolbar">
              <button type="button" class="media-record-btn" id="audio-rec-start">â—</button>
              <button type="button" class="media-record-btn" id="audio-rec-stop">â– </button>
              <span id="audio-rec-status">éŒ„éŸ³é å‚™</span>
            </div>
            <div class="form-row-inline"><audio id="audio-rec-preview" controls></audio></div>
          </div>
          <div class="form-row-inline"><button type="submit" id="submit-btn">ç™¼è¡¨</button></div>
        </form>

        <div class="comments-wrapper">
          <table id="comments-table">
            <thead><tr><th>username</th><th>é …ç›® <button type="button" id="btn-edit" class="edit-header-btn">ç·¨è¼¯</button></th><th>éŒ„éŸ³/å½±ç‰‡</th></tr></thead>
            <tbody id="comments-tbody"></tbody>
          </table>
        </div>
        <button id="back-button" type="button">Back</button>
      </section>

      <section class="panel panel-right" id="visual-panel">
        <div class="visual-wrapper">
          <div class="visual-body">
            <div class="top-row">
              <div class="video-frame-wrap">
                <iframe id="video-iframe" src="" allowfullscreen></iframe>
                <audio id="audio-player" controls></audio>
                <div class="video-placeholder" id="video-placeholder">è«‹é¸å–é …ç›®</div>
              </div>
              <div class="circle-area"><div class="circle-stack" id="circle-stack">
                <div class="ring ring-main ring-1" data-layer="1"></div><div class="ring ring-main ring-2" data-layer="2"></div>
                <div class="ring ring-main ring-3" data-layer="3"></div><div class="ring ring-main ring-4" data-layer="4"></div>
              </div></div>
            </div>
            <div class="bottom-row">
              <div class="reply-area">
                <div class="reply-target"><button type="button" id="reply-target-btn" class="reply-target-btn" disabled>From: â€”</button></div>
                <textarea id="admin-reply" placeholder="æç´è²å­¸å¯¦é©—å®¤ï¼š"></textarea>
                <div class="reply-actions hidden" id="reply-actions">
                  <button type="button" id="reply-save-btn" class="reply-action-btn">å„²å­˜</button>
                  <button type="button" id="reply-cancel-btn" class="reply-action-btn">å–æ¶ˆ</button>
                </div>
              </div>
              <div class="fingerboard-row"><div class="fingerboard" id="fingerboard">
                <div class="fb-string fb-s1"></div><div class="fb-s2 fb-string"></div><div class="fb-s3 fb-string"></div><div class="fb-s4 fb-string"></div>
              </div></div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxn5aDCimtZmvgK4uEGr5fIyNItY2wZgQyO2LVEZkggFkO0VZ_YdDMyspGpzpkYy5W6-A/exec";
    let commentsCache = [];
    let currentSelectedId = null;
    const REPLY_PREFIX = "æç´è²å­¸å¯¦é©—å®¤ï¼š";
    let isFormOpen = false;
    let isSubmitting = false;
    let editState = { active: false, id: null, nickname: "", waitForSelect: false };

    // éœ€æ±‚ 3-1 æ§åˆ¶å…¨åŸŸè™•ç†ç‹€æ…‹
    function toggleGlobalBusy(busy) {
      const container = document.getElementById("main-container");
      const subBtn = document.getElementById("submit-btn");
      const saveBtn = document.getElementById("reply-save-btn");
      const replyBox = document.getElementById("admin-reply");
      if (busy) {
        container.classList.add("is-processing");
        if (subBtn) { subBtn.disabled = true; subBtn.textContent = "è™•ç†ä¸­.."; }
        if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = "è™•ç†ä¸­.."; }
        if (replyBox) { replyBox.disabled = true; replyBox.blur(); } // éœ€æ±‚ 3-1 ç§»é™¤æ¸¸æ¨™
      } else {
        container.classList.remove("is-processing");
        if (subBtn) { subBtn.disabled = false; subBtn.textContent = "ç™¼è¡¨"; }
        if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = "å„²å­˜"; }
        if (replyBox) { replyBox.disabled = false; }
      }
    }

    function normalizeName(n) { return String(n || "").replace(/\u200B/g, "").trim(); }
    function maskName(n) { let s = normalizeName(n); if (!s) return "åŒ¿å"; if (s.length <= 2) return s[0] + "*"; return s[0] + "*".repeat(s.length - 2) + s[s.length - 1]; }
    function validateNameLength(n) { let s = normalizeName(n); return s.length >= 5 && s.length <= 12 && /^[A-Za-z0-9\u4E00-\u9FFF]+$/.test(s); }
    function escapeHtml(s) { return String(s || "").replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c])); }
    function scrollToVideoTop() { window.scrollTo({ top: 0, behavior: "smooth" }); }

    // [JS-2] è¼‰å…¥åˆ—è¡¨
    async function loadComments() {
      const res = await fetch(API_URL + "?action=list", { cache: "no-cache" });
      const data = await res.json();
      commentsCache = data.posts || [];
      renderCommentsTable();
      const newest = commentsCache.slice().reverse().find(r => r.type === "youtube" || r.type === "upload" || r.type === "audio");
      if (newest) selectRowForReply(newest, false);
    }

    // [JS-3] æ¸²æŸ“è¡¨æ ¼ (100% ä¿ç•™ stradtone 8 é‚è¼¯)
    function renderCommentsTable() {
      const tbody = document.getElementById("comments-tbody");
      if (!tbody) return;
      if (!commentsCache.length) { tbody.innerHTML = `<tr><td colspan="3">ç›®å‰å°šç„¡é …ç›®</td></tr>`; return; }
      tbody.innerHTML = commentsCache.slice().reverse().map(row => {
        const nick = maskName(row.nickname);
        const type = row.type || "text";
        const selected = String(row.id) === String(currentSelectedId) ? ' class="selected"' : "";
        const editBtn = editState.waitForSelect ? `<button type="button" class="row-edit-btn" data-id="${row.id}">âœ</button>` : "";
        return `<tr data-id="${row.id}"${selected}>
          <td>${escapeHtml(nick)}</td>
          <td>${editBtn}${escapeHtml(row.text.slice(0, 30))}</td>
          <td>${(type === "youtube" || type === "upload") ? "ğŸ¬" : (type === "audio" ? "ğŸµ" : "â€”")}</td>
        </tr>`;
      }).join("");
    }

    // [JS-7] å›è¦†å€ä¿è­·é‚è¼¯ (æ ¸å¿ƒï¼ä¿ç•™ stradtone 8 çš„è¦å‰‡)
    function setupAdminReply() {
      const box = document.getElementById("admin-reply");
      if (!box) return;
      // ä¿è­·å‰ç¶´ï¼šç¦æ­¢åˆªé™¤å‰ç¶´å­—
      box.addEventListener("keydown", (ev) => {
        const prefixLen = REPLY_PREFIX.length;
        const pos = box.selectionStart || 0;
        if (pos <= prefixLen) {
          const blocked = ["Backspace", "Delete", "ArrowLeft"];
          if (blocked.includes(ev.key) || ev.key.length === 1) {
            ev.preventDefault();
            box.setSelectionRange(prefixLen + 1, prefixLen + 1);
          }
        }
      });
      box.addEventListener("input", () => {
        if (!box.value.startsWith(REPLY_PREFIX)) box.value = REPLY_PREFIX + "\n" + box.value.replace(REPLY_PREFIX, "").trim();
        document.getElementById("reply-actions")?.classList.remove("hidden");
      });
    }

    function selectRowForReply(row, fromEdit) {
      if (!row) return;
      if (!fromEdit && (editState.active || isFormOpen)) resetFormToAddMode();
      currentSelectedId = row.id; renderCommentsTable();
      document.getElementById("reply-target-btn").textContent = "From: " + maskName(row.nickname);
      const box = document.getElementById("admin-reply");
      box.value = row.reply ? row.reply : REPLY_PREFIX + "\n";
      scrollToVideoTop();
      showVideoForRow(row);
    }

    function showVideoForRow(row) {
      const i = document.getElementById("video-iframe"), a = document.getElementById("audio-player"), ph = document.getElementById("video-placeholder");
      i.src = ""; a.pause(); i.style.display="none"; a.style.display="none"; ph.style.display="flex";
      if (row.type === "youtube") { i.src = "https://www.youtube-nocookie.com/embed/" + (row.youtubeUrl.match(/v=([^&]+)/)?.[1] || "") + "?autoplay=1"; i.style.display="block"; ph.style.display="none"; }
      else if (row.type === "audio") { a.src = row.audioUrl; a.style.display="block"; ph.style.display="none"; a.play().catch(()=>{}); }
    }

    // [JS-9] å„²å­˜å›è¦† (éœ€æ±‚ 3 ä¿®æ”¹é»)
    async function saveAdminReply() {
      if (!currentSelectedId || isSubmitting) return;
      toggleGlobalBusy(true);
      try {
        const params = new URLSearchParams({ action: "reply", id: String(currentSelectedId), reply: document.getElementById("admin-reply").value.trim() });
        const res = await fetch(API_URL + "?" + params.toString());
        const data = await res.json();
        if (data.status === "ok") { await loadComments(); document.getElementById("reply-actions").classList.add("hidden"); }
      } catch (err) { alert("å„²å­˜å¤±æ•—"); }
      finally { toggleGlobalBusy(false); }
    }

    // [JS-18] è¡¨å–®é€å‡º (éœ€æ±‚ 3 ä¿®æ”¹é»)
    async function handleSubmit(e) {
      e.preventDefault(); if (isSubmitting) return;
      const nick = normalizeName(document.getElementById("nickname-input").value);
      const txt = document.getElementById("text-input").value.trim();
      if (!validateNameLength(nick) || !txt) { alert("è«‹æª¢æŸ¥æ¬„ä½"); return; }
      
      isSubmitting = true; toggleGlobalBusy(true);
      try {
        // ... åŸæœ¬ stradtone 8 çš„å‚³è¼¸é‚è¼¯ ...
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "add", nickname: nick, text: txt }) });
        if ((await res.json()).status === "ok") { resetFormToAddMode(); await loadComments(); }
      } catch (err) { alert("ç™¼ä½ˆå¤±æ•—"); }
      finally { isSubmitting = false; toggleGlobalBusy(false); }
    }

    // [JS-12] ç·¨è¼¯åŠŸèƒ½æ¢å¾© (stradtone 8 é‚è¼¯)
    function setupEditButton() {
      document.getElementById("btn-edit")?.addEventListener("click", () => {
        editState.waitForSelect = !editState.waitForSelect;
        renderCommentsTable();
      });
    }

    function resetFormToAddMode() {
      isFormOpen = false; document.getElementById("community-form").classList.add("hidden");
      document.getElementById("btn-new").textContent = "æ–°å¢";
      document.getElementById("nickname-input").value = "";
      document.getElementById("text-input").value = "";
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadComments(); setupAdminReply(); setupEditButton();
      document.getElementById("btn-new").addEventListener("click", () => {
        isFormOpen = !isFormOpen;
        document.getElementById("community-form").classList.toggle("hidden", !isFormOpen);
        document.getElementById("btn-new").textContent = isFormOpen ? "å–æ¶ˆæ–°å¢" : "æ–°å¢";
      });
      document.getElementById("community-form").addEventListener("submit", handleSubmit);
      document.getElementById("reply-save-btn").addEventListener("click", saveAdminReply);
      document.getElementById("back-button").addEventListener("click", scrollToVideoTop);
      document.getElementById("comments-tbody").addEventListener("click", e => {
        const tr = e.target.closest("tr"); if (!tr || document.querySelector(".is-processing")) return;
        const row = commentsCache.find(r => String(r.id) === tr.dataset.id);
        if (e.target.classList.contains("row-edit-btn")) { /* å•Ÿå‹•ç·¨è¼¯ */ } else { selectRowForReply(row, false); }
      });
    });
  </script>
</body>
</html>

