<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>StradTone Violin</title>
  <style>
    /* === [CSS-0] åŸå§‹æ¨£å¼å®Œæ•´ä¿ç•™ === */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, "Microsoft JhengHei", sans-serif;
      background: #222629;
      color: #f5f5f5;
    }
    .page { min-height: 100vh; padding: 12px; max-width: 1100px; margin: 0 auto; }
    
    /* éœ€æ±‚ 8: æ–°å¢çŸ®ç‰ˆ Header èˆ‡ Footer (æ¨¡æ“¬ä¸»ç«™) */
    .stradtone-header {
      background: #1a1d20;
      height: 40px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      border-bottom: 1px solid #333;
    }
    .stradtone-header img { height: 20px; }

    header.lab-header {
      margin-top: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }
    header.lab-header h1 { font-size: 20px; margin: 0; }
    header.lab-header h2 { font-size: 14px; margin: 0; opacity: 0.8; }

    main.layout { display: flex; gap: 12px; align-items: stretch; }
    .panel { background: #2d3236; border-radius: 8px; padding: 10px; box-shadow: 0 0 8px rgba(0, 0, 0, 0.35); min-height: 220px; }
    .panel-left  { flex: 0 0 40%; max-width: 40%; display: flex; flex-direction: column; }
    .panel-right { flex: 0 0 60%; max-width: 60%; display: flex; flex-direction: column; }

    /* éœ€æ±‚ 7: ç¦æ­¢å‹•ä½œæ™‚çš„ç‹€æ…‹ (å…¨åŸŸç¦ç”¨èˆ‡éš±è—æ¸¸æ¨™) */
    .global-locked { pointer-events: none !important; }
    .global-locked textarea, .global-locked input { caret-color: transparent !important; }
    .processing-text { color: #d1a343; font-size: 12px; margin-left: 10px; }

    /* éœ€æ±‚ 9: YouTube æŒ‰éˆ•ä¿®æ­£ (ç´…è‰²åŠ é»ƒå…ƒç´  + ç²—é«”) */
    #btn-media-youtube {
      background: #c00000; /* åŸè‰² */
      border-color: #ff5050;
      color: #111111;
      font-weight: 800; /* ç²—é«” */
    }
    #btn-media-youtube.active {
      background: #e60000; /* ç¨å¾®åæ©˜ç´… */
      border-color: #ffd700; /* é‡‘è‰²é‚Š */
      color: #000;
    }
    /* å…¶ä»–åª’é«”é¸å–æ™‚ï¼ŒYouTube è®Šå›é»‘ç°åº• */
    .media-select-btn:not(.active) { background: #3a3f44; color: #f5f5f5; border-color: #777; }

    /* éœ€æ±‚ 6: ç·¨è¼¯æ™‚éš±è”½åª’é«”æŒ‰éˆ• (æ›´æ·ºä¸€éš) */
    .media-select-btn.edit-hidden { opacity: 0.15 !important; }

    /* éœ€æ±‚ 11: username é©—è­‰å¾Œæ¨£å¼ */
    #nickname-input.verified {
      background: #2a2d30 !important; /* æš—ç™½åº• */
      color: #888 !important;
      user-select: none;
      pointer-events: none;
    }

    /* éœ€æ±‚ 5: éŒ„éŸ³éµé‚è¼¯ */
    .media-record-btn#audio-rec-pause.is-paused {
      color: #ff0000 !important; 
    }
    .media-record-btn.recording.flashing { animation: recordBlink 0.8s ease-in-out infinite; }
    @keyframes recordBlink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    /* --- [CSS-2] è¡¨æ ¼èˆ‡å…¶ä»–æ¨£å¼ä¿ç•™ --- */
    .comments-wrapper { flex: 1 1 auto; overflow-y: auto; overflow-x: hidden; border-radius: 6px; border: 1px solid #444; background: #202427; }
    table#comments-table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
    table#comments-table th { position: sticky; top: 0; background: #33383c; z-index: 1; padding: 4px 6px; text-align: left; }
    table#comments-table td { border-bottom: 1px solid #333; padding: 4px 6px; vertical-align: top; word-wrap: break-word; }
    .col-nick { width: 80px; } .col-media { width: 90px; }
    #comments-tbody tr.selected { background: #4f7a3b !important; }
    .hint, .reply-note { font-size: 12px; line-height: 1.4; color: #222629; }
    .hidden { display: none !important; }

    /* --- [CSS-4] å¤šå±¤åœ“ (8å±¤å…¨æ¢å¾©) --- */
    .circle-stack {
      position: relative; width: 160px; height: 160px; border-radius: 50%;
      --ring-main-color: #5c7a5c; --ring-boundary-color: #9ad09a; --ring-highlight-color: #70ff70;
      background: radial-gradient(circle at 20% 20%, #555, #111);
      margin: auto;
    }
    .ring { position: absolute; border-radius: 50%; transition: border-color 0.12s, box-shadow 0.12s; }
    .ring-main { border: 3px solid var(--ring-main-color); opacity: 0.8; }
    .ring-boundary { border: 1.2px solid var(--ring-boundary-color); opacity: 0.7; }
    .ring-b45 { inset: 4%; border: 1px solid transparent; box-shadow: 0 0 16px rgba(112,255,112,0.35); }
    .ring-4 { inset: 10%; } .ring-b35 { inset: 20%; } .ring-3 { inset: 26%; }
    .ring-b25 { inset: 36%; } .ring-2 { inset: 42%; } .ring-b15 { inset: 52%; } .ring-1 { inset: 60%; }
    .ring.active { border-color: var(--ring-highlight-color); opacity: 1; box-shadow: 0 0 10px rgba(140,255,140,0.9); }

    /* --- [CSS-5] æŒ‡æ¿æ¢å¾© --- */
    .fingerboard {
      position: relative; width: 120px; height: 260px; background: linear-gradient(180deg, #181a1d, #34383d);
      border-radius: 14px; border: 2px solid #676f78; margin: auto;
    }
    .fb-string { position: absolute; top: 6%; bottom: 6%; width: 2px; background: #888; opacity: 0.9; }
    .fb-s1 { left: 20%; } .fb-s2 { left: 40%; } .fb-s3 { left: 62%; } .fb-s4 { left: 80%; }
    .fingerboard-note { position: absolute; font-size: 10px; color: #fdf5c5; pointer-events: none; }

    /* æ‰‹æ©Ÿç‰ˆæ’ç‰ˆä¿ç•™ */
    @media (max-width: 820px) {
      main.layout { flex-direction: column; }
      #visual-panel { order: 1; } #comments-section { order: 2; }
      .panel-left, .panel-right { max-width: 100%; width: 100%; border-radius: 0; }
      .video-frame-wrap { height: 160px !important; }
      .bottom-row { flex-direction: row; }
    }
    
    /* è¡¨å–®ç‰¹å®šæ¨£å¼ */
    form#community-form { padding: 6px 8px; border: 1px solid #d1a343; background: #141b20; }
    #admin-reply { width: 100%; background: #1f2326; color: #f5f5f5; border-radius: 4px; border: 1px solid #555; }
    .media-select-btn { padding: 3px 10px; border-radius: 14px; cursor: pointer; border: 1px solid #777; font-size: 12px; }
  </style>
</head>
<body>

  <header class="stradtone-header">
    <a href="https://stradtone.com"><img src="https://stradtone.com/wp-content/uploads/2022/10/StradTone-Logo-Header.png" alt="StradTone"></a>
  </header>

  <div class="page" id="top-point">
    <header class="lab-header">
      <h1>StradTone Violin</h1>
      <h2>æç´è²å­¸å¯¦é©—å®¤</h2>
    </header>

    <main class="layout" id="main-container">
      <section class="panel panel-left" id="comments-section">
        <div class="toolbar">
          <button type="button" id="btn-new">æ–°å¢</button>
        </div>

        <form id="community-form" class="hidden">
          <label>username (5â€“12 å­—)ï¼š
            <input type="text" id="nickname-input" maxlength="12" placeholder="Mr,s 09â€¦." />
          </label>
          <label>é …ç›® (100 å­—å…§)ï¼š
            <input type="text" id="text-input" maxlength="100" placeholder="..." />
          </label>

          <div class="form-row-inline media-select-row">
            <button type="button" class="media-select-btn" id="btn-media-youtube" data-media="youtube">YouTube</button>
            <button type="button" class="media-select-btn" id="btn-media-upload" data-media="upload">å½±ç‰‡</button>
            <button type="button" class="media-select-btn" id="btn-media-audio" data-media="audio">éŒ„éŸ³</button>
          </div>

          <div id="video-fields" class="hidden">
            <div class="form-row-inline" id="youtube-row" style="margin-top:4px;">
              <input type="text" id="youtube-url-input" placeholder="YouTube Link..." />
            </div>
            <div class="form-row-inline" id="video-upload-row" style="display:none; margin-top:4px;">
              <input type="file" id="video-file-input" />
            </div>
          </div>

          <div id="audio-fields" class="hidden">
            <div class="media-record-toolbar">
              <button type="button" class="media-record-btn" id="audio-rec-start">â—</button>
              <button type="button" class="media-record-btn" id="audio-rec-pause" disabled>â¸</button>
              <button type="button" class="media-record-btn" id="audio-rec-stop" disabled>â– </button>
              <span id="audio-rec-status">éŒ„éŸ³é å‚™</span>
            </div>
            <audio id="audio-rec-preview" controls class="hidden" style="width:100%; margin-top:4px;"></audio>
          </div>

          <div class="form-row-inline" style="margin-top:6px;">
            <button type="submit" id="submit-btn">ç™¼è¡¨</button>
            <span id="proc-label" class="processing-text hidden">è™•ç†ä¸­...</span>
          </div>
        </form>

        <div class="comments-wrapper">
          <table id="comments-table">
            <thead>
              <tr>
                <th class="col-nick">username</th>
                <th>é …ç›® <button type="button" id="btn-edit" class="edit-header-btn">ç·¨è¼¯</button></th>
                <th class="col-media">åª’é«”</th>
              </tr>
            </thead>
            <tbody id="comments-tbody"></tbody>
          </table>
        </div>
        <button id="back-button" type="button">Back</button>
      </section>

      <section class="panel panel-right" id="visual-panel">
        <div class="visual-wrapper">
          <div class="top-row">
            <div class="video-frame-wrap">
              <iframe id="video-iframe" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
              <audio id="audio-player" controls style="display:none; position:absolute; bottom:0; width:100%;"></audio>
              <div id="video-placeholder" class="video-placeholder">è«‹é¸å–é …ç›®</div>
            </div>
            <div class="circle-area">
              <div class="circle-stack" id="circle-stack">
                <div class="ring ring-main ring-1" data-layer="1"></div>
                <div class="ring ring-main ring-2" data-layer="2"></div>
                <div class="ring ring-main ring-3" data-layer="3"></div>
                <div class="ring ring-main ring-4" data-layer="4"></div>
                <div class="ring ring-boundary ring-b15" data-layer="1.5"></div>
                <div class="ring ring-boundary ring-b25" data-layer="2.5"></div>
                <div class="ring ring-boundary ring-b35" data-layer="3.5"></div>
                <div class="ring ring-b45" data-layer="4.5"></div>
              </div>
            </div>
          </div>
          <div class="bottom-row">
            <div class="reply-area">
              <div class="reply-target"><button type="button" id="reply-target-btn" class="reply-target-btn" disabled>From: â€”</button></div>
              <textarea id="admin-reply" placeholder="æç´è²å­¸å¯¦é©—å®¤ï¼š"></textarea>
              <div id="reply-actions" class="reply-actions hidden">
                <button type="button" id="reply-save-btn">å„²å­˜</button>
                <button type="button" id="reply-cancel-btn">å–æ¶ˆ</button>
              </div>
            </div>
            <div class="fingerboard-row">
              <div class="fingerboard" id="fingerboard">
                <div class="fb-string fb-s1"></div><div class="fb-string fb-s2"></div><div class="fb-string fb-s3"></div><div class="fb-string fb-s4"></div>
                <div class="fingerboard-note" style="left:24%; top:8%;">G0</div>
                <div class="fingerboard-note" style="left:24%; top:26%;">G3</div>
                <div class="fingerboard-note" style="left:38%; top:18%;">D5</div>
                <div class="fingerboard-note" style="left:38%; top:40%;">D8</div>
                <div class="fingerboard-note" style="left:62%; top:22%;">A7</div>
                <div class="fingerboard-note" style="left:62%; top:44%;">A10</div>
                <div class="fingerboard-note" style="left:76%; top:30%;">E9</div>
                <div class="fingerboard-note" style="left:76%; top:52%;">E12</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    /* === [JS] é‚è¼¯å®Œå…¨æ¢å¾©ä¸¦æ¤å…¥ä¿®æ”¹ === */
    const API_URL = "https://script.google.com/macros/s/AKfycbxn5aDCimtZmvgK4uEGr5fIyNItY2wZgQyO2LVEZkggFkO0VZ_YdDMyspGpzpkYy5W6-A/exec";
    let commentsCache = [];
    let currentSelectedId = null;
    let editState = { active: false, id: null, nickname: "" };
    let audioRecRecorder = null;
    let audioRecChunks = [];
    let isSubmitting = false;

    // éœ€æ±‚ 4: æ›é /èƒŒæ™¯ è‡ªå‹•æš«åœå½±ç‰‡èˆ‡è²éŸ³
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        const iframe = document.getElementById("video-iframe");
        const audio = document.getElementById("audio-player");
        if (iframe.src) iframe.src = iframe.src; 
        audio.pause();
      }
    });

    // éœ€æ±‚ 10: Back éµé‚è¼¯
    document.getElementById("back-button").onclick = () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
      resetForm();
    };

    // è¼‰å…¥èˆ‡åˆå§‹åŒ–
    async function loadComments() {
      const res = await fetch(API_URL + "?action=list", { cache: "no-cache" });
      const data = await res.json();
      commentsCache = data.posts || [];
      renderTable();
      // éœ€æ±‚ 2: è‡ªå‹•é–‹å•Ÿæœ€æ–°å¸¶å½±ç‰‡é …ç›®
      const newestWithMedia = [...commentsCache].reverse().find(r => r.youtubeUrl || r.driveFileId || r.driveAudioId);
      if (newestWithMedia) selectRow(newestWithMedia);
    }

    function renderTable() {
      const tbody = document.getElementById("comments-tbody");
      tbody.innerHTML = commentsCache.slice().reverse().map(row => {
        const selected = row.id == currentSelectedId ? 'class="selected"' : '';
        return `<tr data-id="${row.id}" ${selected} onclick="handleRowClick(${row.id})">
          <td>${maskName(row.nickname)}</td>
          <td>${row.text.slice(0,25)}...</td>
          <td>${(row.youtubeUrl || row.driveFileId)?'ğŸ¬':''}${row.driveAudioId?'ğŸµ':''}</td>
        </tr>`;
      }).join('');
    }

    function maskName(s) {
      if (!s) return "åŒ¿å";
      return s.length <= 2 ? s[0] + "*" : s[0] + "*".repeat(s.length-2) + s[s.length-1];
    }

    function handleRowClick(id) {
      const row = commentsCache.find(r => r.id == id);
      selectRow(row);
    }

    function selectRow(row) {
      currentSelectedId = row.id;
      renderTable();
      const iframe = document.getElementById("video-iframe");
      const audio = document.getElementById("audio-player");
      const ph = document.getElementById("video-placeholder");
      
      iframe.style.display = "none"; audio.style.display = "none"; ph.style.display = "none";
      iframe.src = "";

      if (row.youtubeUrl) {
        iframe.src = `https://www.youtube-nocookie.com/embed/${extractYTId(row.youtubeUrl)}?autoplay=1`;
        iframe.style.display = "block";
      } else if (row.driveAudioId) {
        audio.src = `https://drive.google.com/uc?export=download&id=${row.driveAudioId}`;
        audio.style.display = "block";
        audio.play().catch(()=>{});
      } else { ph.style.display = "flex"; }

      // éœ€æ±‚ 8: è˜‹æœæ‰‹æ©Ÿé¸å–å¾Œè·³è‡³é ‚ç«¯
      if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
        window.scrollTo({ top: 0, behavior: "smooth" });
        document.getElementById("admin-reply").blur();
      }
    }

    function extractYTId(url) {
      const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|\/embed\/))([^?&]+)/);
      return m ? m[1] : "";
    }

    // éœ€æ±‚ 3 & 7: ç¦æ­¢åŠŸèƒ½èˆ‡é¡¯ç¤ºè™•ç†ä¸­
    function setGlobalLock(locked) {
      const container = document.getElementById("main-container");
      const procLabel = document.getElementById("proc-label");
      if (locked) {
        container.classList.add("global-locked");
        procLabel.classList.remove("hidden");
      } else {
        container.classList.remove("global-locked");
        procLabel.classList.add("hidden");
      }
    }

    // éœ€æ±‚ 5: éŒ„éŸ³æ§åˆ¶é‚è¼¯
    const btnRecStart = document.getElementById("audio-rec-start");
    const btnRecPause = document.getElementById("audio-rec-pause");
    const btnRecStop = document.getElementById("audio-rec-stop");

    btnRecStart.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioRecRecorder = new MediaRecorder(stream);
      audioRecChunks = [];
      audioRecRecorder.ondataavailable = e => audioRecChunks.push(e.data);
      audioRecRecorder.onstop = () => {
        const blob = new Blob(audioRecChunks, { type: 'audio/webm' });
        window.recordedAudioBlob = blob;
        const preview = document.getElementById("audio-rec-preview");
        preview.src = URL.createObjectURL(blob);
        preview.classList.remove("hidden");
      };
      audioRecRecorder.start();
      btnRecStart.classList.add("recording", "flashing");
      btnRecPause.disabled = false; btnRecStop.disabled = false;
    };

    btnRecPause.onclick = () => {
      if (audioRecRecorder.state === "recording") {
        audioRecRecorder.pause();
        btnRecPause.classList.add("is-paused");
        btnRecStart.classList.remove("flashing"); // åœæ­¢é–ƒçˆ
      } else {
        audioRecRecorder.resume();
        btnRecPause.classList.remove("is-paused");
        btnRecStart.classList.add("flashing"); // æ¢å¾©é–ƒçˆ
      }
    };

    btnRecStop.onclick = () => {
      audioRecRecorder.stop();
      btnRecStart.classList.remove("recording", "flashing");
      btnRecPause.disabled = true; btnRecStop.disabled = true;
    };

    // è¡¨å–®è™•ç†
    document.getElementById("btn-new").onclick = () => {
      const f = document.getElementById("community-form");
      f.classList.toggle("hidden");
      if (!f.classList.contains("hidden")) {
        document.getElementById("btn-new").textContent = "å–æ¶ˆæ–°å¢";
      } else {
        resetForm();
      }
    };

    function resetForm() {
      document.getElementById("community-form").reset();
      document.getElementById("community-form").classList.add("hidden");
      document.getElementById("btn-new").textContent = "æ–°å¢";
      editState.active = false;
      document.querySelectorAll('.media-select-btn').forEach(b => {
        b.classList.remove('active', 'edit-hidden');
        b.disabled = false;
      });
      document.getElementById("nickname-input").classList.remove("verified");
    }

    // éœ€æ±‚ 9: æŒ‰éˆ•äº’æ–¥èˆ‡é¡è‰²åˆ‡æ›
    document.querySelectorAll('.media-select-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.media-select-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const m = btn.dataset.media;
        document.getElementById("video-fields").className = (m==='youtube' || m==='upload') ? "" : "hidden";
        document.getElementById("audio-fields").className = (m==='audio') ? "" : "hidden";
        document.getElementById("youtube-row").style.display = (m==='youtube') ? "flex" : "none";
        document.getElementById("video-upload-row").style.display = (m==='upload') ? "flex" : "none";
      };
    });

    // éœ€æ±‚ 11 & 12: æäº¤æ•¸æ“š
    document.getElementById("community-form").onsubmit = async (e) => {
      e.preventDefault();
      setGlobalLock(true);
      
      const payload = {
        action: editState.active ? "edit" : "add",
        nickname: document.getElementById("nickname-input").value,
        text: document.getElementById("text-input").value,
        youtubeUrl: document.getElementById("youtube-url-input").value,
        type: document.querySelector('.media-select-btn.active')?.dataset.media || 'text'
      };

      if (window.recordedAudioBlob) {
        const reader = new FileReader();
        reader.readAsDataURL(window.recordedAudioBlob);
        reader.onloadend = async () => {
          payload.audioBase64 = reader.result.split(',')[1];
          await finalSubmit(payload);
        };
      } else {
        await finalSubmit(payload);
      }
    };

    async function finalSubmit(p) {
      try {
        await fetch(API_URL, { method: "POST", body: JSON.stringify(p) });
        await loadComments();
        resetForm();
      } catch (err) { alert("æäº¤å¤±æ•—"); }
      setGlobalLock(false);
    }

    // å•Ÿå‹•
    window.onload = loadComments;
  </script>
</body>
</html>

