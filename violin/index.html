<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StradTone Violin</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, "Microsoft JhengHei", sans-serif;
      background: #222629;
      color: #f5f5f5;
    }

    /* æ•´å€‹é é¢çš„å®¹å™¨ï¼šæ¡Œæ©Ÿç½®ä¸­ã€å›ºå®šå¯¬åº¦ï¼Œé¿å…ç¸®æ”¾æ™‚æ•´å¡Šäº‚é£„ */
    .page {
      min-height: 100vh;
      padding: 12px;
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }

    header h1 { font-size: 20px; margin: 0; }
    header h2 { font-size: 14px; margin: 0; opacity: 0.8; }
    header small { font-size: 12px; opacity: 0.7; }

    main.layout {
      display: flex;
      gap: 12px;
      align-items: stretch;
    }

    .panel {
      background: #2d3236;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.35);
      min-height: 220px;
    }

    /* å·¦ 40%ã€å³ 60%ï¼ˆæ¡Œæ©Ÿï¼‰ */
    .panel-left  { flex: 0 0 40%; max-width: 40%; display: flex; flex-direction: column; }
    .panel-right { flex: 0 0 60%; max-width: 60%; display: flex; flex-direction: column; }

    h2 { font-size: 16px; margin: 0 0 4px; }

    /* ã€Œçµ¦ç«™ä¸»çœ‹çš„èªªæ˜ã€æ–‡å­— â†’ æ”¹æˆè·ŸèƒŒæ™¯ä¸€æ¨£è‰²ï¼Œç­‰æ–¼éš±è— */
    .hint,
    .reply-note {
      font-size: 12px;
      line-height: 1.4;
      color: #222629;  /* å’Œ body èƒŒæ™¯ä¸€æ¨£ */
    }

    .hidden { display: none !important; }

    /* placeholder é¡è‰²å†æ·¡ä¸€é» */
    input::placeholder,
    textarea::placeholder {
      color: #999;
      opacity: 0.7;
    }
    input::-webkit-input-placeholder,
    textarea::-webkit-input-placeholder {
      color: #999;
      opacity: 0.7;
    }


/* =====================================================
 * [CSS-1] å·¦å´ï¼šå·¥å…·åˆ— + è¡¨å–®
 * ===================================================== */

.toolbar {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
  flex-wrap: wrap;
}

.toolbar button {
  padding: 4px 10px;
  border-radius: 14px;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 12px;
  cursor: pointer;
}
.toolbar button:hover { background: #4a5056; }

form#community-form {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 8px;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #d1a343;        /* é‚Šæ¡†æ”¹æˆé‡‘è‰²ä¸€é» */
  background: #141b20;               /* åº•è‰²åŠ æ·±ï¼Œèˆ‡è¡¨æ ¼å€æ‹‰é–‹ */
  box-shadow: 0 0 10px rgba(0,0,0,0.65);
}
form#community-form label {
  font-size: 13px;
  display: block;
}

form#community-form input[type="text"] {
  width: 100%;
  padding: 4px 6px;
  margin-top: 2px;
  border-radius: 4px;
  border: 1px solid #555;
  background: #1f2326;
  color: #f5f5f5;
  font-size: 13px;
}

/* ç·¨è¼¯ / ç™¼è¡¨æ™‚å¯è¼¸å…¥ â†’ ç™½åº• */
form#community-form input[type="text"]:not(:disabled) {
  background: #ffffff;
  color: #111;
}

/* é–å®šç‹€æ…‹ï¼ˆç­‰åç¨±é©—è­‰ï¼‰â†’ æ·±åº• */
form#community-form input[type="text"]:disabled {
  background: #1f2326;
  color: #999;
}

#record-btn {
  padding: 4px 10px;
  border-radius: 16px;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 12px;
  cursor: not-allowed; /* é ç•™éŒ„éŸ³ */
  opacity: 0.6;
}

.form-row-inline {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}

#video-file-input {
  font-size: 11px;
}

#video-file-label {
  font-size: 11px;
  opacity: 0.8;
}

#submit-btn {
  padding: 4px 14px;
  border-radius: 16px;
  border: none;
  background: #d1a343;
  color: #1d1d1d;
  font-size: 13px;
  cursor: pointer;
}
#submit-btn:hover { background: #e0b85f; }

/* é˜²æ­¢é€£é»æ™‚çš„è¦–è¦ºåé¥‹ */
#submit-btn:disabled, .reply-action-btn:disabled {
  opacity: 0.7;
  cursor: wait;
}

.sub-hint {
  font-size: 11px;
  opacity: 0.8;
}

/* ä¸‰é¡†åª’é«”é¸æ“‡æŒ‰éˆ• */
.media-select-row {
  margin: 4px 0 2px;
  gap: 6px;
}

.media-select-btn {
  padding: 3px 10px;
  border-radius: 14px;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 12px;
  cursor: pointer;
  opacity: 0.9;
}
.media-select-btn.active {
  border-color: #d1a343;
  background: #e0b85f;
  color: #1d1d1d;
  font-weight: 600;
}

.media-select-btn:disabled {
  opacity: 0.2;
  filter: grayscale(0.8);
  cursor: default;
}

/* [éœ€æ±‚ 6 è£œå¼·] YouTube å®˜æ–¹è‰²å¡æ ¡æ­£ */
#btn-media-youtube {
  background: #FF0000;           /* å®˜æ–¹æ¨™èªŒç´… */
  border-color: #FF4D4D;        /* äº®è‰²é‚Šæ¡† */
  color: #FFFFFF;               /* æ”¹ç‚ºç™½å­—æ›´é¡¯çœ¼ */
  font-weight: 600;
}
#btn-media-youtube:hover:not(:disabled) {
  background: #CC0000;           /* æ‡¸åœæ™‚æ·±ç´… */
}
#btn-media-youtube.active {
  background: #FF0000;
  border-color: #FFFFFF;
  color: #FFFFFF;
  box-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
}
#btn-media-youtube:disabled {
  background: #4a2a2a;
  border-color: #774444;
  color: #888;
}



/* è¡¨å–®å…§ï¼šéŒ„å½±/éŒ„éŸ³æ§åˆ¶åˆ—ï¼ˆç›®å‰åªçµ¦éŒ„éŸ³ç”¨ï¼‰ */
.media-record-toolbar {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 4px;
  font-size: 11px;
}
.media-record-btn {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease, opacity 0.15s ease;
}
.media-record-btn[disabled] {
  opacity: 0.4;
  cursor: default;
}

/* éŒ„éŸ³ä¸­ï¼šç™½é»è®Šç´…ã€å¤–è§€ç¨äº®ä¸¦é–ƒçˆ */
.media-record-btn.recording {
  color: #ff4b4b;
  border-color: #ff8080;
  background: #4a3a3a;
  animation: recordBlink 0.8s ease-in-out infinite;
}

@keyframes recordBlink {
  0%   { opacity: 1; }
  50%  { opacity: 0.3; }
  100% { opacity: 1; }
}
/* å³ä¸Šå½±éŸ³å€çš„ audio æ’­æ”¾å™¨ï¼ˆæœ‰éŒ„éŸ³æ™‚ä½¿ç”¨ï¼‰ */
#audio-player {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  background: #111315;
  display: none; /* é è¨­éš±è—ï¼Œéœ€è¦æ™‚ç”± JS é¡¯ç¤º */
}

.media-record-status {
  font-size: 11px;
  opacity: 0.8;
}

/* éŒ„å½± / éŒ„éŸ³é è¦½å€ */
.rec-preview {
  width: 100%;
  max-height: 140px;
  border-radius: 4px;
  border: 1px solid #444;
  background: #111;
}


  /* =====================================================
 * [CSS-2] å·¦å´ï¼šç•™è¨€åˆ—è¡¨è¡¨æ ¼
 * ===================================================== */

.comments-wrapper {
  flex: 1 1 auto;
  overflow-y: auto;           /* åƒ…ç¸±å‘æ²å‹• */
  overflow-x: hidden;         /* ä¸è¦æ©«å‘å·è»¸ */
  border-radius: 6px;
  border: 1px solid #444;
  background: #202427;
}
table#comments-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  table-layout: fixed;        /* å›ºå®šæ¬„å¯¬ï¼Œé¿å…å·¦å³äº‚è·‘ */
}
table#comments-table thead {
  position: sticky;
  top: 0;
  background: #33383c;
  z-index: 1;
}
table#comments-table th,
table#comments-table td {
  border-bottom: 1px solid #333;
  padding: 4px 6px;
  text-align: left;
  vertical-align: top;
  word-wrap: break-word;
  word-break: break-word;     /* ä¾è£ç½®å¯¬åº¦è‡ªå‹•æŠ˜è¡Œ */
}
table#comments-table th {
  font-weight: 600;
  font-size: 12px;
}
table#comments-table tbody tr:nth-child(even) {
  background: #252a2e;
}

.col-nick  { width: 80px; white-space: nowrap; }
.col-text  { width: 50%; position: relative; }
.col-media { width: 90px; }

.media-icons {
  display: flex;
  gap: 4px;
  align-items: center;
  flex-wrap: wrap;
  font-size: 13px;
}

.media-flag {
  font-size: 16px;   /* åœ–ç¤ºç¨å¾®æ”¾å¤§ */
}

/* æ¯åˆ—å‰é¢çš„ç­†æŒ‰éˆ•ï¼ˆé€²å…¥ç·¨è¼¯ç”¨ï¼‰ */
.row-edit-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  margin-right: 4px;
  border-radius: 4px;
  border: 1px solid #888;
  background: #3a3f44;
  box-shadow: 0 0 3px rgba(0,0,0,0.5);
  font-size: 12px;
  cursor: pointer;
  flex-shrink: 0;
}
.row-edit-btn:hover {
  background: #4a5056;
}

.play-video-btn {
  padding: 2px 6px;
  border-radius: 12px;
  border: 1px solid #888;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 11px;
  cursor: pointer;
  margin-top: 2px;
}

/* è¡¨é ­çš„ã€Œç·¨è¼¯ã€å°éˆ• */
.edit-header-btn {
  margin-left: 6px;
  padding: 1px 6px;
  border-radius: 10px;
  border: 1px solid #666;
  background: #2f3438;
  color: #d0d0d0;
  font-size: 10px;
  cursor: pointer;
  opacity: 0.8;
}
.edit-header-btn:hover {
  opacity: 1;
  background: #4a5056;
}

.expand-arrow {
  font-size: 10px;
  opacity: 0.7;
  float: right;
  margin-left: 4px;
  cursor: pointer;
}

#comments-tbody tr.selected {
  background: #4f7a3b !important; /* æ¯”åŸæœ¬å†äº®ä¸€é» */
}

/* é¸åˆ°çš„åˆ—é–ƒä¸€ä¸‹ï¼ˆçµ¦å›è¦†å€åç¨±æŒ‰éˆ•ç”¨ï¼‰ */
.row-flash {
  animation: rowFlash 0.8s ease-out;
}
@keyframes rowFlash {
  0%   { background-color: #7fbf4f; }
  100% { background-color: inherit; }
}

/* å·¦å´ Back æŒ‰éˆ•ï¼ˆç§»åˆ°è¡¨æ ¼åº•ä¸‹ï¼‰ */
#back-button {
  margin-top: 6px;
  align-self: flex-start;
  padding: 4px 10px;
  border-radius: 14px;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 12px;
  cursor: pointer;
}


    /* =====================================================
     * [CSS-3] å³å´ï¼šè¦–è¦ºå€æ¡†æ¶
     * ===================================================== */

    .visual-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }
    .visual-header {
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .current-point { font-size: 12px; opacity: 0.9; }

    /* å³ä¸Šè§’ã€Œå°šæœªé¸å–ç•™è¨€ / æ’­æ”¾ä¸­â€¦ã€æš«æ™‚ä¸é¡¯ç¤º */
    .current-point {
      display: none;
    }

    .visual-body {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 260px;
    }

    .top-row {
      display: flex;
      gap: 8px;
      min-height: 170px;
    }

    /* å·¦ï¼šå½±ç‰‡ï¼éŒ„éŸ³æ ¼å­ */
    .video-frame-wrap {
      flex: 1 1 60%;
      background: #111315;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #555;
      position: relative;
      min-height: 150px;
    }
    .video-frame-wrap iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .video-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #999;
      text-align: center;
      padding: 8px;
    }

    /* =====================================================
     * [CSS-4] å³å´ï¼šå¤šå±¤åœ“
     * ===================================================== */

    .circle-area {
      flex: 1 1 40%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .circle-stack {
      position: relative;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      --ring-main-color: #5c7a5c;
      --ring-boundary-color: #9ad09a;
      --ring-highlight-color: #70ff70;
      --ring-outer-fog: rgba(112, 255, 112, 0.35);
      background: radial-gradient(circle at 20% 20%, #555, #111);
    }

    .ring {
      position: absolute;
      border-radius: 50%;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }

    .ring-main {
      border: 3px solid var(--ring-main-color);
      opacity: 0.8;
    }
    .ring-boundary {
      border: 1.2px solid var(--ring-boundary-color);
      opacity: 0.7;
    }
    .ring-b45 {
      border: 1px solid transparent;
      box-shadow: 0 0 16px var(--ring-outer-fog);
      opacity: 0.9;
    }

    .ring-b45 { inset: 4%;  } /* 4.5 */
    .ring-4   { inset: 10%; } /* 4   */
    .ring-b35 { inset: 20%; } /* 3.5 */
    .ring-3   { inset: 26%; } /* 3   */
    .ring-b25 { inset: 36%; } /* 2.5 */
    .ring-2   { inset: 42%; } /* 2   */
    .ring-b15 { inset: 52%; } /* 1.5 */
    .ring-1   { inset: 60%; } /* 1   */

    .ring.active {
      border-color: var(--ring-highlight-color);
      opacity: 1;
      box-shadow: 0 0 10px rgba(140, 255, 140, 0.9);
    }

    .layer-label {
      position: absolute;
      bottom: 6px;
      right: 8px;
      font-size: 11px;
      color: #cfe9cf;
      text-shadow: 0 0 3px #000;
    }

    /* æš«æ™‚éš±è—å±¤ç´šæ–‡å­— */
    .layer-label {
      display: none;
    }

    /* =====================================================
     * [CSS-5] å³å´ä¸‹åŠï¼šå›è¦†å€ + æŒ‡æ¿
     * ===================================================== */

    .bottom-row {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    /* å›è¦†å€å¯¬åº¦æ”¹æˆå’Œå½±ç‰‡åŒæ¨£æ¯”ä¾‹ï¼ˆç´„ 6:4ï¼‰ */
    .reply-area {
      flex: 1 1 60%;
    }

    .reply-area-header {
      font-size: 13px;
      margin: 0 0 4px;
    }

    .reply-target {
      font-size: 12px;
      margin-bottom: 4px;
      opacity: 0.85;
    }

/* å›è¦†å€ä¸‹æ–¹çš„ã€Œå„²å­˜ / å–æ¶ˆã€ */
.reply-actions {
  margin-top: 4px;
  display: flex;
  gap: 6px;
}
.reply-actions.hidden {
  display: none;
}
.reply-action-btn {
  padding: 3px 10px;
  border-radius: 14px;
  border: 1px solid #bbb;
  background: #f5f5f5;
  color: #222629;
  font-size: 12px;
  cursor: pointer;
}
.reply-action-btn.reply-cancel-btn {
  background: #3a3f44;
  color: #f5f5f5;
  border-color: #777;
}

    .reply-target-btn {
      padding: 3px 10px;
      border-radius: 14px;
      border: 1px solid #bbb;
      background: #f5f5f5;
      color: #222629;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }
    .reply-target-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* è¢«é …ç›®é€£å‹•æ™‚ï¼Œé¡è‰²è·Ÿ .selected row ä¸€è‡´ */
    .reply-target-btn.linked {
      background: #4f7a3b;
      border-color: #4f7a3b;
      color: #f5f5f5;
    }

    .reply-note {
      font-size: 11px;
      opacity: 0.75;
      margin-bottom: 4px;
    }

    #admin-reply {
      width: 100%;
      background: #1f2326;
      border: 1px solid #555;
      color: #f5f5f5;
      font-size: 12px;
      border-radius: 4px;
      min-height: 80px;
      resize: none;           /* å…ˆç”± JS æ§åˆ¶æ‹–æ‹‰ */
      overflow: hidden;       /* ç”± JS æ§åˆ¶å‡ºç¾å·è»¸ */
      line-height: 1.4;
      transition: background-color 0.2s ease;
    }

    /* é˜²å‘†é–ƒå‹•æç¤ºèƒŒæ™¯ */
    #admin-reply.reply-force-focus {
      background-color: #3e4449 !important;
      outline: 2px solid #d1a343;
    }

    .fingerboard-row {
      flex: 1 1 40%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .fingerboard {
      position: relative;
      width: 120px;
      max-width: 140px;
      height: 260px;
      background: linear-gradient(180deg, #181a1d, #34383d);
      border-radius: 14px;
      overflow: hidden;
      border: 2px solid #676f78;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.55);
    }

    .fb-string {
      position: absolute;
      top: 6%;
      bottom: 6%;
      width: 2px;
      background: linear-gradient(180deg, #cfcfcf, #888);
      opacity: 0.9;
    }
    .fb-s1 { left: 20%; transform: skewX(-3deg); }
    .fb-s2 { left: 40%; transform: skewX(-1.5deg); }
    .fb-s3 { left: 62%; transform: skewX( 1.5deg); }
    .fb-s4 { left: 80%; transform: skewX( 3deg); }

    .fingerboard-note {
      position: absolute;
      font-size: 10px;
      color: #fdf5c5;
      opacity: 0.95;
      text-shadow: 0 0 2px #000;
      pointer-events: none;
    }

    /* =====================================================
     * [CSS-6] æ‰‹æ©Ÿç‰ˆ
     * ===================================================== */

    @media (max-width: 820px) {
      .page {
        padding: 0;         /* æ‰‹æ©Ÿç‰ˆæ»¿ç‰ˆ */
        max-width: 100%;
      }

      main.layout {
        flex-direction: column;
      }

      /* æ‰‹æ©Ÿç‰ˆï¼šé †åºæ”¹æˆ å³ï¼ˆå½±ç‰‡+å¤šå±¤åœ“+å›è¦†+æŒ‡æ¿ï¼‰åœ¨ä¸Šï¼Œå·¦ï¼ˆè¡¨æ ¼ï¼‰åœ¨ä¸‹ */
      #visual-panel {
        order: 1;
      }
      #comments-section {
        order: 2;
      }

      .panel-left,
      .panel-right {
        max-width: 100%;
        width: 100%;
        border-radius: 0;
      }

      .panel-right .visual-body {
        min-height: 420px;
      }

      /* æ‰‹æ©Ÿç‰ˆï¼šä¸Šå±¤åªè¦å½±ç‰‡ï¼Œå½±ç‰‡é«˜åº¦å›ºå®š */
      .top-row {
        flex-direction: column;
        min-height: 0;
      }

      .video-frame-wrap {
        width: 100%;
        height: 160px !important;
        min-height: 160px;
      }

      .circle-area {
        justify-content: center;
        margin-top: 6px;
      }

      .circle-stack {
        width: 160px;
        height: 160px;
      }

      .fingerboard {
        height: 220px;
      }

      /* æ‰‹æ©Ÿç‰ˆï¼šä¸­å±¤ å›è¦†å€ + æŒ‡æ¿ å·¦å³ä¸¦æ’ */
      .bottom-row {
        flex-direction: row;
      }

      .reply-area {
        flex: 1 1 60%;
      }

      .fingerboard-row {
        flex: 1 1 40%;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <h1>StradTone Violin</h1>
      <h2>æç´è²å­¸å¯¦é©—å®¤</h2>
    </header>

    <main class="layout">
      <section class="panel panel-left" id="comments-section">
        <p class="hint">
          å°æç´
        </p>

        <div class="toolbar">
          <button type="button" id="btn-new">æ–°å¢</button>
        </div>

        <form id="community-form" class="hidden">
          <label>
            usernameï¼ˆ5â€“12 å­—å¿…å¡«,ä¿®æ”¹ç·¨è¼¯ç”¨ï¼‰ï¼š
            <input
              type="text"
              id="nickname-input"
              maxlength="12"
              placeholder="Mr,s 09â€¦."
            />
          </label>
          <label>
            é …ç›®ï¼ˆ100 å­—å…§ï¼‰ï¼š
            <input
              type="text"
              id="text-input"
              maxlength="100"
              placeholder="..."
            />
          </label>

          <div class="form-row-inline media-select-row">
            <button
              type="button"
              class="media-select-btn"
              id="btn-media-youtube"
              data-media="youtube"
            >
              YouTube
            </button>
            <button
              type="button"
              class="media-select-btn"
              id="btn-media-upload"
              data-media="upload"
            >
              å½±ç‰‡
            </button>
            <button
              type="button"
              class="media-select-btn"
              id="btn-media-audio"
              data-media="audio"
            >
              éŒ„éŸ³
            </button>
          </div>

          <div id="video-fields" class="hidden">
            <div class="form-row-inline" id="youtube-row" style="margin-top:4px;">
              <input
                type="text"
                id="youtube-url-input"
                placeholder="https://youtu.be/....(Link)â€¦"
              />
              <input
                type="text"
                id="start-input"
                placeholder="é–‹å§‹ mm:ss "
              />
              <input
                type="text"
                id="end-input"
                placeholder="çµæŸ mm:ss "
              />
            </div>

            <div class="form-row-inline" id="video-upload-row" style="margin-top:4px;">
              <input type="file" id="video-file-input" />
              <span id="video-file-label" class="sub-hint"></span>
            </div>
            <div class="form-row-inline" id="video-link-row" style="margin-top:4px;">
              <input
                type="text"
                id="video-link-input"
                placeholder="https://... å½±ç‰‡æˆ–ç¶²é ç¶²å€ï¼ˆé¸å¡«ï¼‰"
              />
            </div>
          </div>

          <div id="audio-fields" class="hidden">
            <div class="media-record-toolbar" id="audio-record-toolbar">
              <button type="button" class="media-record-btn" id="audio-rec-start">â—</button>
              <button type="button" class="media-record-btn" id="audio-rec-pause" disabled>â¸</button>
              <button type="button" class="media-record-btn" id="audio-rec-stop" disabled>â– </button>
              <button type="button" class="media-record-btn" id="audio-rec-cancel" disabled>âœ•</button>
              <span class="media-record-status" id="audio-rec-status">éŒ„éŸ³é å‚™</span>
            </div>

            <div class="form-row-inline" id="audio-upload-row" style="margin-top:4px;">
              <input type="file" id="audio-file-input" accept="audio/*" />
              <span id="audio-file-label" class="sub-hint"></span>
            </div>

            <div class="form-row-inline" id="audio-preview-row" style="margin-top:4px;">
              <audio id="audio-rec-preview" class="rec-preview" controls></audio>
            </div>
          </div>

          <div class="form-row-inline">
            <button type="submit" id="submit-btn">ç™¼è¡¨</button>
          </div>
        </form>

        <div class="comments-wrapper">
          <table id="comments-table">
            <thead>
              <tr>
                <th class="col-nick">username</th>
                <th class="col-text">
                  é …ç›®
                  <button
                    type="button"
                    id="btn-edit"
                    class="edit-header-btn"
                  >
                    ç·¨è¼¯
                  </button>
                </th>
                <th class="col-media">éŒ„éŸ³ / å½±ç‰‡</th>
              </tr>
            </thead>
            <tbody id="comments-tbody">
              </tbody>
          </table>
        </div>

        <button id="back-button" type="button">Back</button>
      </section>

      <section class="panel panel-right" id="visual-panel">
        <div class="visual-wrapper">
          <div class="visual-header">
            <div class="current-point" id="current-info">
              å°šæœªé¸å–ç•™è¨€
            </div>
          </div>

          <div class="visual-body">
            <div class="top-row">
              <div class="video-frame-wrap">
                <iframe
                  id="video-iframe"
                  src=""
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  referrerpolicy="origin-when-cross-origin"
                  allowfullscreen
                ></iframe>

                <audio id="audio-player" controls></audio>

                <div class="video-placeholder" id="video-placeholder">
                  è«‹å¾å·¦å´è¡¨æ ¼é¸å–ä¸€ç­†å¸¶æœ‰å½±ç‰‡æˆ–éŒ„éŸ³çš„é …ç›®
                </div>
              </div>

              <div class="circle-area">
                <div class="circle-stack" id="circle-stack">
                  <div class="ring ring-main ring-1" data-layer="1"></div>
                  <div class="ring ring-main ring-2" data-layer="2"></div>
                  <div class="ring ring-main ring-3" data-layer="3"></div>
                  <div class="ring ring-main ring-4" data-layer="4"></div>
                  <div
                    class="ring ring-boundary ring-b15"
                    data-layer="1.5"
                  ></div>
                  <div
                    class="ring ring-boundary ring-b25"
                    data-layer="2.5"
                  ></div>
                  <div
                    class="ring ring-boundary ring-b35"
                    data-layer="3.5"
                  ></div>
                  <div
                    class="ring ring-b45"
                    data-layer="4.5"
                  ></div>

                  <div class="layer-label" id="layer-label">
                    layers: â€“
                  </div>
                </div>
              </div>
            </div>

            <div class="bottom-row">
              <div class="reply-area">
                <div class="reply-target" id="reply-target">
                  <button
                    type="button"
                    id="reply-target-btn"
                    class="reply-target-btn"
                    disabled
                  >
                    From: â€”
                  </button>
                </div>
                <p class="reply-note">
                  </p>
                <textarea
                  id="admin-reply"
                  placeholder="æç´è²å­¸å¯¦é©—å®¤ï¼š"
                ></textarea>

                <div class="reply-actions hidden" id="reply-actions">
                  <button type="button" id="reply-save-btn" class="reply-action-btn">å„²å­˜</button>
                  <button type="button" id="reply-cancel-btn" class="reply-action-btn reply-cancel-btn">å–æ¶ˆ</button>
                </div>
              </div>

              <div class="fingerboard-row">
                <div class="fingerboard" id="fingerboard">
                  <div class="fb-string fb-s1"></div>
                  <div class="fb-string fb-s2"></div>
                  <div class="fb-string fb-s3"></div>
                  <div class="fb-string fb-s4"></div>

                  <div
                    class="fingerboard-note"
                    style="left:24%; top:8%;"
                  >
                    G0
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:24%; top:26%;"
                  >
                    G3
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:38%; top:18%;"
                  >
                    D5
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:38%; top:40%;"
                  >
                    D8
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:62%; top:22%;"
                  >
                    A7
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:62%; top:44%;"
                  >
                    A10
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:76%; top:30%;"
                  >
                    E9
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:76%; top:52%;"
                  >
                    E12
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== [JS-0] å…¨åŸŸç‹€æ…‹ =====
    const API_URL =
      "https://script.google.com/macros/s/AKfycbxn5aDCimtZmvgK4uEGr5fIyNItY2wZgQyO2LVEZkggFkO0VZ_YdDMyspGpzpkYy5W6-A/exec";

    let commentsCache = [];
    let currentSelectedId = null;

    // ç®¡ç†å“¡å›è¦†å‰ç¶´ & ç‹€æ…‹
    const REPLY_PREFIX = "æç´è²å­¸å¯¦é©—å®¤ï¼š";
    let currentReplyOriginalRaw = "";
    let replyDirty = false;

    // æ–°å¢ / ç·¨è¼¯æ¬„æ˜¯å¦å±•é–‹
    let isFormOpen = false;
    // è¡¨å–®æ¨¡å¼ï¼š'add' / 'edit'ï¼ˆåªç”¨ä¾†æ±ºå®šæŒ‰éˆ•å­—æ¨£ï¼‰
    let formMode = "add";

    // é€å‡ºé˜²é€£é»
    let isSubmitting = false;

    // ç·¨è¼¯ç‹€æ…‹ï¼šæŒ‰ä¸‹ã€Œç·¨è¼¯ã€å¾Œæ‰æœƒå•Ÿå‹•
    let editState = {
      active: false,
      id: null,
      nickname: "",
      originalText: "",
      waitForSelect: false,
    };

    // éŒ„éŸ³ / éŒ„å½± blobï¼ˆé ç•™ï¼‰
    window.recordedAudioBlob = null;
    window.recordedVideoBlob = null;

    // å·¦å´ã€ŒéŒ„éŸ³ã€é¢æ¿ç”¨çš„éŒ„éŸ³æ§åˆ¶
    let audioRecStream = null;
    let audioRecRecorder = null;
    let audioRecChunks = [];
    let audioRecActive = false;
    let audioRecPaused = false;
    let audioRecTimerId = null;
    let audioRecStartTime = 0;
    let audioRecAccumulated = 0;
    let audioRecCancelling = false;

    // ===== [JS-1] å°å·¥å…· =====

    // çµ±ä¸€è™•ç†åç¨±å­—ä¸²ï¼ˆå»æ‰é›¶å¯¬å­—å…ƒã€å‰å¾Œç©ºç™½ï¼‰
    function normalizeName(name) {
      return String(name || "").replace(/\u200B/g, "").trim();
    }

    // é®è”½åç¨±
    function maskName(name) {
      const s = normalizeName(name);
      if (!s) return "åŒ¿å";
      if (s.length <= 2) return s[0] + "*";
      const first = s[0];
      const last = s[s.length - 1];
      const middle = "*".repeat(s.length - 2);
      return first + middle + last;
    }

    // åç¨±éœ€ 5ï½12 å­— & ç¦æ­¢ç‰¹æ®Šç¬¦è™Ÿï¼ˆå…è¨±ç´”æ•¸å­—ã€è‹±æ–‡ã€ä¸­æ–‡å­—ï¼‰
    function validateNameLength(name) {
      const s = normalizeName(name);
      if (s.length < 5 || s.length > 12) return false;
      if (!/^[A-Za-z0-9\u4E00-\u9FFF]+$/.test(s)) return false;
      return true;
    }

    // æ™‚é–“å­—ä¸² â†’ ç§’æ•¸
    function parseTimeToSec(str) {
      if (!str) return "";
      const s = String(str).trim();

      let m = s.match(/^(\d+):(\d{1,2})$/);
      if (m) {
        const min = Number(m[1]);
        const sec = Number(m[2]);
        if (!isNaN(min) && !isNaN(sec)) return min * 60 + sec;
      }

      m = s.match(/^(\d{3,4})$/);
      if (m) {
        const digits = m[1];
        const sec = Number(digits.slice(-2));
        const min = Number(digits.slice(0, -2));
        if (!isNaN(min) && !isNaN(sec)) return min * 60 + sec;
      }
      return "";
    }

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"']/g, (c) => {
        return (
          {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[c] || c
        );
      });
    }

    // YouTube ID
    function extractYoutubeId(url) {
      if (!url) return "";
      const m1 = url.match(/youtu\.be\/([^?]+)/);
      if (m1) return m1[1];
      const m2 = url.match(/[?&]v=([^&]+)/);
      if (m2) return m2[1];
      return "";
    }

    // YouTube embed
    function buildYoutubeEmbedUrl(url, startSec, endSec) {
      const id = extractYoutubeId(url);
      if (!id) return "";
      const base = "https://www.youtube-nocookie.com/embed/" + id;
      const params = [];

      params.push("autoplay=1");
      params.push("rel=0", "modestbranding=1", "playsinline=1");

      if (startSec !== "" && !isNaN(startSec)) {
        params.push("start=" + startSec);
      }
      if (endSec !== "" && !isNaN(endSec)) {
        params.push("end=" + endSec);
      }

      return params.length ? base + "?" + params.join("&") : base;
    }

    // Google Drive embedï¼ˆå½±ç‰‡ï¼‰
    function buildDriveEmbedUrl(fid) {
      return fid ? "https://drive.google.com/file/d/" + fid + "/preview" : "";
    }

    // Google Drive ç›´é€£ï¼ˆéŸ³è¨Šï¼‰
    function buildDriveDownloadUrl(fid) {
      return fid ? "https://drive.google.com/uc?export=download&id=" + fid : "";
    }

    // å·è»¸å›åˆ°é é¢é ‚ç«¯ï¼ˆè®“æ‰‹æ©Ÿä¸æœƒè·³åˆ°å›è¦†æ¬„ï¼‰
    function scrollToVideoTop() {
      window.scrollTo({
        top: 0,
        behavior: "smooth",
      });
    }

    // Base64
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
          const result = r.result || "";
          const idx = String(result).indexOf(",");
          resolve(idx >= 0 ? result.slice(idx + 1) : result);
        };
        r.onerror = () => reject(r.error);
        r.readAsDataURL(file);
      });
    }

    // åœæ­¢å³ä¸Šè§’å½±ç‰‡ & éŸ³è¨Šæ’­æ”¾
    function stopAllPlayback() {
      const iframe = document.getElementById("video-iframe");
      const audio = document.getElementById("audio-player");
      const ph = document.getElementById("video-placeholder");
      if (iframe) iframe.src = "";
      if (audio) {
        try {
          audio.pause();
        } catch (e) {}
        audio.removeAttribute("src");
        audio.load();
        audio.style.display = "none";
      }
      if (ph) {
        ph.style.display = "flex";
      }
    }

    // éŒ„éŸ³æ™‚é–“æ ¼å¼åŒ–ï¼ˆmm:ssï¼‰
    function formatDuration(sec) {
      const s = Math.max(0, sec | 0);
      const m = (s / 60) | 0;
      const r = s % 60;
      const mm = m < 10 ? "0" + m : "" + m;
      const ss = r < 10 ? "0" + r : "" + r;
      return mm + ":" + ss;
    }

    function clearAudioRecTimer() {
      if (audioRecTimerId) {
        clearInterval(audioRecTimerId);
        audioRecTimerId = null;
      }
    }

    // ===== [JS-2] è¼‰å…¥èˆ‡è¡¨æ ¼åˆ—è¡¨ ======

    async function loadComments(targetId) {
      const res = await fetch(API_URL + "?action=list", { cache: "no-cache" });
      const data = await res.json();
      commentsCache = data.posts || [];
      renderCommentsTable();
      
      // 12. ä¿®æ”¹é»ï¼šå¦‚æœæŒ‡å®šäº† targetIdï¼Œå‰‡è·³è½‰åˆ°è©²é …ç›®
      if (targetId) {
        const row = findRowById(targetId);
        if (row) {
          selectRowForReply(row, false);
          return;
        }
      }

      // 2. ä¿®æ”¹é»ï¼šè¼‰å…¥å¾Œè‡ªå‹•é–‹å•Ÿæœ€æ–°ä¸€ç­†å¸¶å½±éŸ³æˆ–éŒ„éŸ³é …ç›®ï¼ˆæ­¤è™•ä¸å±¬æ–¼è¼ªæ’­åŠŸèƒ½ï¼Œåƒ…ä¾›é¦–æ¬¡é€²å…¥å±•ç¤ºç”¨ï¼‰
      const newestWithMedia = commentsCache.slice().reverse().find(row => {
        const type = row.type || "text";
        return (type === "youtube" && row.youtubeUrl) || 
               (type === "upload" && (row.driveFileId || row.externalUrl || row.linkUrl)) ||
               (type === "audio");
      });
      
      if (newestWithMedia) {
        selectRowForReply(newestWithMedia, false);
      }
    }

    // ===== [JS-3] æ¸²æŸ“è¡¨æ ¼ ======

    function renderCommentsTable() {
      const tbody = document.getElementById("comments-tbody");
      if (!tbody) return;

      if (!commentsCache.length) {
        tbody.innerHTML = `<tr><td colspan="3">ç›®å‰å°šç„¡é …ç›®</td></tr>`;
        return;
      }

      const rows = commentsCache.slice().reverse();

      const html = rows
        .map((row) => {
          const nick = maskName(row.nickname);
          const full = String(row.text || "");
          const long = full.length > 30;
          const shortText = long
            ? escapeHtml(full.slice(0, 30)) + "â€¦"
            : escapeHtml(full);

          const type = row.type || "text";

          const hasYoutube = type === "youtube" && row.youtubeUrl;
          const hasDrive = type === "upload" && row.driveFileId;
          const hasExternal = type === "upload" && (row.externalUrl || row.linkUrl);
          const hasAudio =
            type === "audio" || row.hasAudio || row.driveAudioId;

          let mediaHtml = `<span style="opacity:.5">â€”</span>`;
          const icons = [];

          if (hasAudio) {
            icons.push(
              `<span class="media-flag" title="éŒ„éŸ³">ğŸµ</span>`
            );
          }

          if (hasYoutube || hasDrive || hasExternal) {
            icons.push(
              `<span class="media-flag" title="å½±ç‰‡ / ç¶²é ">ğŸ¬</span>`
            );
          }

          const replyRaw = String(row.reply || "").trim();
          let hasRealReply = false;
          if (replyRaw) {
            const withoutPrefix = replyRaw.replace(REPLY_PREFIX, "").trim();
            hasRealReply = !!withoutPrefix;
          }

          if (hasRealReply) {
            icons.push(
              `<span class="media-flag" title="å·²æœ‰å›è¦†">ğŸ’¬</span>`
            );
          }

          if (icons.length) {
            mediaHtml = `<div class="media-icons">${icons.join("")}</div>`;
          }

          const selected =
            String(row.id) === String(currentSelectedId) ? ` class="selected"` : "";

          const needEditButton = !!editState.waitForSelect;
          const editBtnHtml = needEditButton
            ? `<button type="button" class="row-edit-btn" data-id="${row.id}">âœ</button>`
            : "";

          return `
            <tr data-id="${row.id}"${selected}>
              <td class="col-nick">${escapeHtml(nick)}</td>
              <td class="col-text" data-long="${long ? "1" : "0"}">
                ${editBtnHtml}${shortText}${
        long
          ? `<span class="expand-arrow" title="å±•é–‹">â–¼</span>`
          : ""
      }
              </td>
              <td class="col-media">${mediaHtml}</td>
            </tr>
          `;
        })
        .join("");

      tbody.innerHTML = html;
    }

    // ===== [JS-4] é¡¯ç¤ºå½±ç‰‡ã€éŸ³è¨Š ======

    function clearVideo() {
      stopAllPlayback();
    }

    function showVideoForRow(row) {
      const iframe = document.getElementById("video-iframe");
      const audio = document.getElementById("audio-player");
      const ph = document.getElementById("video-placeholder");
      if (!iframe || !audio || !ph) return;

      stopAllPlayback();
      iframe.style.display = "none";
      audio.style.display = "none";

      if (!row) return;

      let url = "";

      if (row.type === "youtube" && row.youtubeUrl) {
        url = buildYoutubeEmbedUrl(row.youtubeUrl, row.startSec, row.endSec);
        if (url) {
          iframe.src = url;
          iframe.style.display = "block";
          ph.style.display = "none";
        }
        return;
      }

      if (row.type === "upload") {
        // å…ˆçœ‹æ˜¯å¦æœ‰ä¸€èˆ¬ç¶²å€ï¼ˆé Driveï¼‰
        if (row.externalUrl || row.linkUrl) {
          url = row.externalUrl || row.linkUrl;
          if (url) {
            iframe.src = url;
            iframe.style.display = "block";
            ph.style.display = "none";
            return;
          }
        }

        if (row.driveFileId) {
          url = buildDriveEmbedUrl(row.driveFileId);
          if (url) {
            iframe.src = url;
            iframe.style.display = "block";
            ph.style.display = "none";
          }
          return;
        }
      }

      if (row.type === "audio") {
        if (row.driveAudioId) {
          url = buildDriveDownloadUrl(row.driveAudioId);
        } else if (row.audioUrl) {
          url = row.audioUrl;
        }

        if (url) {
          audio.src = url;
          audio.style.display = "block";
          ph.style.display = "none";
          try {
            audio.currentTime = 0;
            audio.play().catch(() => {});
          } catch (e) {}
        }
      }
    }

    // ===== [JS-5] å¤šå±¤åœ“ï¼ˆé ç•™ï¼‰ ======
    function highlightLayers(layerStr) {
      const rings = document.querySelectorAll(".ring");
      rings.forEach((r) => r.classList.remove("active"));

      if (!layerStr) return;

      const parts = String(layerStr)
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);

      rings.forEach((r) => {
        const v = r.getAttribute("data-layer");
        if (parts.includes(v)) r.classList.add("active");
      });
    }

    // ===== [JS-6] æŸ¥æ‰¾ row ======
    function findRowById(id) {
      return commentsCache.find((r) => String(r.id) === String(id));
    }

    // ===== [JS-7] ç®¡ç†å“¡å›è¦†å€å‰ç¶´ & è‡ªå‹•é«˜åº¦ ======

    function ensureReplyPrefix() {
      const box = document.getElementById("admin-reply");
      if (!box) return;
      const prefix = REPLY_PREFIX;
      let val = box.value || "";
      const oldStart = box.selectionStart || 0;

      if (!val) {
        box.value = prefix + "\n";
        try {
          box.setSelectionRange(box.value.length, box.value.length);
        } catch (e) {}
        return;
      }

      if (!val.startsWith(prefix)) {
        const withoutPrefix = val
          .replace(new RegExp(prefix, "g"), "")
          .replace(/^\s+/, "");
        box.value = prefix + "\n" + withoutPrefix;
      }

      let rest = box.value.slice(prefix.length);
      if (!rest.startsWith("\n")) {
        rest = "\n" + rest.replace(/^\s+/, "");
        box.value = prefix + rest;
      }

      const minPos = prefix.length + 1;
      let newPos = oldStart;
      if (newPos < minPos) newPos = minPos;
      try {
        box.setSelectionRange(newPos, newPos);
      } catch (e) {}
    }

    function autoResizeReply() {
      const box = document.getElementById("admin-reply");
      if (!box) return;

      let maxH = 260;
      const fb = document.getElementById("fingerboard");
      if (fb) {
        const rect = fb.getBoundingClientRect();
        if (rect.height > 0) maxH = rect.height;
      }

      box.style.height = "auto";
      const scrollH = box.scrollHeight;
      if (scrollH <= maxH) {
        box.style.height = scrollH + "px";
        box.style.overflowY = "hidden";
        box.style.resize = "none";
      } else {
        box.style.height = maxH + "px";
        box.style.overflowY = "auto";
        box.style.resize = "vertical";
      }
    }

    function showReplyActions() {
      const wrap = document.getElementById("reply-actions");
      if (wrap) wrap.classList.remove("hidden");
      replyDirty = true;
    }

    function hideReplyActions() {
      const wrap = document.getElementById("reply-actions");
      if (wrap) wrap.classList.add("hidden");
      replyDirty = false;
    }

    // ===== [JS-8] é¸å–é …ç›®ï¼ˆè‡ªå‹•å±•é–‹ + å›è¦†é€£å‹•ï¼‰ ======
    function resetReplyTargetButton() {
      const btn = document.getElementById("reply-target-btn");
      if (!btn) return;
      btn.textContent = "From: â€”";
      btn.disabled = true;
      btn.removeAttribute("data-id");
      btn.classList.remove("linked");
    }

    function selectRowForReply(row, fromEditStart) {
      if (!row) return;

      // åˆ‡æ›é …ç›®å‰å…ˆæŠŠéŒ„éŸ³ï¼ˆéº¥å…‹é¢¨ï¼‰é—œæ‰
      if (typeof stopAudioRecordingInternal === "function") {
        stopAudioRecordingInternal(true);
      }

      if (!fromEditStart) {
        if (editState.active) {
          resetFormToAddMode();
        } else if (isFormOpen) {
          resetFormToAddMode();
        }
      }

      currentSelectedId = row.id;

      renderCommentsTable();

      const tbody = document.getElementById("comments-tbody");
      if (tbody) {
        Array.from(tbody.querySelectorAll("tr[data-id]")).forEach((tr) => {
          tr.classList.toggle(
            "selected",
            tr.getAttribute("data-id") === String(row.id)
          );
        });

        const tr = tbody.querySelector(`tr[data-id="${row.id}"]`);
        if (tr) {
          const cell = tr.querySelector("td.col-text");
          if (cell && String(row.text || "").length > 30) {
            cell.innerHTML =
              escapeHtml(row.text) +
              '<span class="expand-arrow" title="æ”¶åˆ">â–²</span>';
            cell.setAttribute("data-expanded", "1");
          }
        }
      }

      const btn = document.getElementById("reply-target-btn");
      if (btn) {
        btn.textContent = "From: " + maskName(row.nickname);
        btn.disabled = false;
        btn.setAttribute("data-id", String(row.id));
        btn.classList.add("linked");
      }

      const box = document.getElementById("admin-reply");
      if (box) {
        const raw = row.reply || "";
        currentReplyOriginalRaw = raw;

        if (!raw) {
          box.value = REPLY_PREFIX + "\n";
        } else if (raw.startsWith(REPLY_PREFIX)) {
          box.value = raw;
        } else {
          box.value = REPLY_PREFIX + "\n" + raw;
        }
        ensureReplyPrefix();
        autoResizeReply();
        hideReplyActions();
      }

      showVideoForRow(row);
      scrollToVideoTop();
    }

    // ===== [JS-9] å„²å­˜å›è¦† (éœ€æ±‚ 3 ä¿®æ”¹é») ======
    async function saveAdminReply() {
      const box = document.getElementById("admin-reply");
      const btnSave = document.getElementById("reply-save-btn");
      if (!box || !currentSelectedId) return;

      // éœ€æ±‚ 3: æŒ‰ä¸‹å„²å­˜å¾Œé¡¯ç¤ºè™•ç†ä¸­
      const originalText = btnSave.textContent;
      btnSave.disabled = true;
      btnSave.textContent = "è™•ç†ä¸­..";
      isSubmitting = true; // [è™•ç†ä¸­é˜²å‘†] å•Ÿå‹•æ——æ¨™

      ensureReplyPrefix();
      autoResizeReply();

      const full = String(box.value || "").trim();

      let toSend = "";
      if (full) {
        let afterPrefix = full;
        if (full.startsWith(REPLY_PREFIX)) {
          afterPrefix = full.slice(REPLY_PREFIX.length);
        }
        if (afterPrefix.trim()) {
          toSend = full;
        }
      }

      try {
        const targetId = currentSelectedId; // 12. é–å®šç•¶å‰ ID
        const params = new URLSearchParams({
          action: "reply",
          id: String(targetId),
          reply: toSend,
        });

        const res = await fetch(API_URL + "?" + params.toString());
        const data = await res.json();

        if (!data || data.status !== "ok") {
          throw new Error(data.error || "reply å¤±æ•—");
        }

        // 12. ä¿®æ”¹é»ï¼šå„²å­˜å¾Œå¸¶å…¥ targetId é‡æ–°è¼‰å…¥ä¸¦è·³è½‰
        await loadComments(targetId);

        hideReplyActions();
        try {
          box.blur(); 
        } catch (e) {}
        scrollToVideoTop();
      } catch (err) {
        console.error(err);
        alert("å„²å­˜å›è¦†å¤±æ•—ï¼š" + err.message);
      } finally {
        // æ¢å¾©ç‹€æ…‹
        btnSave.disabled = false;
        btnSave.textContent = "å„²å­˜";
        isSubmitting = false; // [è™•ç†ä¸­é˜²å‘†] è§£é™¤æ——æ¨™
      }
    }

    function cancelAdminReply() {
      const row = findRowById(currentSelectedId);
      const box = document.getElementById("admin-reply");
      if (!box) return;

      if (row) {
        const raw = row.reply || "";
        if (!raw) {
          box.value = REPLY_PREFIX + "\n";
        } else if (raw.startsWith(REPLY_PREFIX)) {
          box.value = raw;
        } else {
          box.value = REPLY_PREFIX + "\n" + raw;
        }
      } else {
        box.value = REPLY_PREFIX + "\n";
      }
      ensureReplyPrefix();
      autoResizeReply();
      hideReplyActions();
    }

    // ===== [JS-10] åª’é«”æ¨¡å¼åˆ‡æ›ï¼ˆYouTube / å½±ç‰‡ / éŒ„éŸ³ äº’æ–¥ï¼‰ ======
    function clearRecordedMediaState() {
      if (typeof stopAudioRecordingInternal === "function") {
        stopAudioRecordingInternal(true);
      } else {
        window.recordedAudioBlob = null;
        window.recordedVideoBlob = null;
        const aStatus = document.getElementById("audio-rec-status");
        const previewEl = document.getElementById("audio-rec-preview");
        if (aStatus) aStatus.textContent = "éŒ„éŸ³é å‚™";
        if (previewEl) {
          try {
            previewEl.pause();
          } catch (e) {}
          previewEl.removeAttribute("src");
          previewEl.load();
        }
      }
    }

    // ===== [JS-A] å·¦å´è¡¨å–®ï¼šéŒ„éŸ³é¢æ¿æ§åˆ¶ï¼ˆMediaRecorderï¼‰ ======
    function stopAudioRecordingInternal(cancelOnly) {
      const statusEl = document.getElementById("audio-rec-status");
      const previewEl = document.getElementById("audio-rec-preview");
      const btnStart = document.getElementById("audio-rec-start");
      const btnStop = document.getElementById("audio-rec-stop");
      const btnPause = document.getElementById("audio-rec-pause");
      const btnCancel = document.getElementById("audio-rec-cancel");

      clearAudioRecTimer();
      audioRecActive = false;
      audioRecPaused = false;
      audioRecAccumulated = 0;

      if (audioRecRecorder && audioRecRecorder.state !== "inactive") {
        if (cancelOnly) {
          audioRecCancelling = true;
        }
        try {
          audioRecRecorder.stop();
        } catch (e) {}
      }
      audioRecRecorder = null;

      if (audioRecStream) {
        audioRecStream.getTracks().forEach((t) => t.stop());
      }
      audioRecStream = null;

      if (cancelOnly) {
        audioRecChunks = [];
        window.recordedAudioBlob = null;
        if (previewEl) {
          previewEl.removeAttribute("src");
          previewEl.load();
        }
        if (statusEl) statusEl.textContent = "éŒ„éŸ³é å‚™";
      }

      if (btnStart) btnStart.disabled = false;
      if (btnStop) btnStop.disabled = true;
      if (btnCancel) btnCancel.disabled = false;
      if (btnPause) {
        btnPause.disabled = true;
        btnPause.classList.remove("recording");
        btnPause.textContent = "â¸";
      }

      const btnStart2 = document.getElementById("audio-rec-start");
      if (btnStart2) {
        btnStart2.classList.remove("recording");
      }
    }

    function setupAudioRecording() {
      const btnStart = document.getElementById("audio-rec-start");
      const btnStop = document.getElementById("audio-rec-stop");
      const btnPause = document.getElementById("audio-rec-pause");
      const btnCancel = document.getElementById("audio-rec-cancel");
      const statusEl = document.getElementById("audio-rec-status");
      const previewEl = document.getElementById("audio-rec-preview");

      if (!btnStart || !btnStop || !btnCancel || !statusEl || !previewEl || !btnPause) {
        return;
      }

      btnStart.disabled = false;
      btnStop.disabled = true;
      btnPause.disabled = true;
      btnCancel.disabled = true;

      btnStart.addEventListener("click", async () => {
        if (audioRecActive) return;
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          statusEl.textContent = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´éº¥å…‹é¢¨éŒ„éŸ³ã€‚";
          return;
        }

        try {
          stopAudioRecordingInternal(true);

          btnStart.disabled = true;
          btnStop.disabled = true;
          btnPause.disabled = true;
          btnCancel.disabled = true;
          statusEl.textContent = "æ­£åœ¨å•Ÿç”¨éº¥å…‹é¢¨â€¦";

          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioRecStream = stream;
          audioRecChunks = [];
          window.recordedAudioBlob = null;

          const mimeType =
            MediaRecorder.isTypeSupported &&
            MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
              ? "audio/webm;codecs=opus"
              : "audio/webm";

          const recorder = new MediaRecorder(stream, { mimeType });
          audioRecRecorder = recorder;
          audioRecActive = true;
          audioRecPaused = false;
          audioRecAccumulated = 0;
          audioRecCancelling = false;

          recorder.addEventListener("dataavailable", (ev) => {
            if (ev.data && ev.data.size > 0) {
              audioRecChunks.push(ev.data);
            }
          });

          recorder.addEventListener("stop", () => {
            clearAudioRecTimer();
            audioRecActive = false;

            if (audioRecStream) {
              audioRecStream.getTracks().forEach((t) => t.stop());
            }
            audioRecStream = null;

            if (audioRecCancelling) {
              audioRecCancelling = false;
              audioRecChunks = [];
              window.recordedAudioBlob = null;
              if (previewEl) {
                previewEl.removeAttribute("src");
                previewEl.load();
              }
              if (statusEl) statusEl.textContent = "éŒ„éŸ³å·²å–æ¶ˆã€‚";
              btnStart.disabled = false;
              btnStop.disabled = true;
              btnPause.disabled = true;
              btnPause.classList.remove("recording");
              btnPause.textContent = "â¸";
              btnCancel.disabled = false;
              btnStart.classList.remove("recording");
              return;
            }

            if (!audioRecChunks.length) return;

            const blob = new Blob(audioRecChunks, { type: mimeType });
            window.recordedAudioBlob = blob;

            const url = URL.createObjectURL(blob);
            previewEl.src = url;
            previewEl.play().catch(() => {});

            statusEl.textContent = "éŒ„éŸ³å®Œæˆï¼Œå¯æŒ‰ã€Œç™¼è¡¨ã€å„²å­˜ã€‚";

            btnStart.disabled = false;
            btnStop.disabled = true;
            btnPause.disabled = true;
            btnPause.classList.remove("recording");
            btnPause.textContent = "â¸";
            btnCancel.disabled = false;

            btnStart.classList.remove("recording");
          });

          audioRecStartTime = Date.now();
          clearAudioRecTimer();
          statusEl.textContent = "éŒ„éŸ³ä¸­â€¦ 00:00";
          audioRecTimerId = setInterval(() => {
            if (!audioRecActive || audioRecPaused) return;
            const elapsedSec =
              audioRecAccumulated + (Date.now() - audioRecStartTime) / 1000;
            statusEl.textContent = "éŒ„éŸ³ä¸­â€¦ " + formatDuration(elapsedSec);
          }, 500);

          btnStart.classList.add("recording");
          btnStop.disabled = false;
          btnPause.disabled = false;
          btnCancel.disabled = false;

          recorder.start();
        } catch (err) {
          console.error(err);
          statusEl.textContent = "ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨ï¼ˆå¯èƒ½è¢«æ‹’çµ•æˆ–è£ç½®ä¸æ”¯æ´ï¼‰ã€‚";
          btnStart.disabled = false;
          btnStop.disabled = true;
          btnPause.disabled = true;
          btnCancel.disabled = false;
          btnStart.classList.remove("recording");
        }
      });

      btnStop.addEventListener("click", () => {
        if (!audioRecActive || !audioRecRecorder) return;
        audioRecPaused = false;
        audioRecAccumulated = 0;
        clearAudioRecTimer();
        statusEl.textContent = "è™•ç†éŒ„éŸ³ä¸­â€¦";
        btnStop.disabled = true;
        if (btnPause) {
          btnPause.disabled = true;
          btnPause.classList.remove("recording");
          btnPause.textContent = "â¸";
        }
        audioRecRecorder.stop();
      });

      btnPause.addEventListener("click", () => {
        if (!audioRecRecorder || !audioRecActive) return;

        if (typeof audioRecRecorder.pause !== "function" ||
            typeof audioRecRecorder.resume !== "function") {
          statusEl.textContent = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´æš«åœåŠŸèƒ½ã€‚";
          btnPause.disabled = true;
          return;
        }

        if (!audioRecPaused) {
          audioRecPaused = true;
          audioRecAccumulated += (Date.now() - audioRecStartTime) / 1000;
          clearAudioRecTimer();
          audioRecRecorder.pause();
          statusEl.textContent = "éŒ„éŸ³å·²æš«åœ " + formatDuration(audioRecAccumulated);
          btnPause.textContent = "â–¶ï¸";
        } else {
          audioRecPaused = false;
          audioRecStartTime = Date.now();
          audioRecRecorder.resume();
          statusEl.textContent = "éŒ„éŸ³ä¸­â€¦ " + formatDuration(audioRecAccumulated);
          clearAudioRecTimer();
          audioRecTimerId = setInterval(() => {
            if (!audioRecActive || audioRecPaused) return;
            const elapsedSec =
              audioRecAccumulated + (Date.now() - audioRecStartTime) / 1000;
            statusEl.textContent = "éŒ„éŸ³ä¸­â€¦ " + formatDuration(elapsedSec);
          }, 500);
          btnPause.textContent = "â¸";
        }
      });

      btnCancel.addEventListener("click", () => {
        if (audioRecActive && audioRecRecorder) {
          stopAudioRecordingInternal(true);
        } else {
          stopAudioRecordingInternal(true);
        }
      });
    }

    function setMediaMode(mode) {
      window.currentMediaMode = mode || null;

      const btnYoutube = document.getElementById("btn-media-youtube");
      const btnUpload = document.getElementById("btn-media-upload");
      const btnAudio = document.getElementById("btn-media-audio");

      const videoFields = document.getElementById("video-fields");
      const audioFields = document.getElementById("audio-fields");
      const youtubeRow = document.getElementById("youtube-row");
      const videoUploadRow = document.getElementById("video-upload-row");
      const videoLinkRow = document.getElementById("video-link-row");

      [btnYoutube, btnUpload, btnAudio].forEach((b) => {
        if (b) b.classList.remove("active");
      });

      if (videoFields) videoFields.classList.add("hidden");
      if (audioFields) audioFields.classList.add("hidden");
      if (youtubeRow) youtubeRow.style.display = "none";
      if (videoUploadRow) videoUploadRow.style.display = "none";
      if (videoLinkRow) videoLinkRow.style.display = "none";

      if (!mode) return;

      if (mode === "youtube") {
        if (btnYoutube) btnYoutube.classList.add("active");
        if (videoFields) videoFields.classList.remove("hidden");
        if (youtubeRow) youtubeRow.style.display = "flex";
      } else if (mode === "upload") {
        if (btnUpload) btnUpload.classList.add("active");
        if (videoFields) videoFields.classList.remove("hidden");
        if (videoUploadRow) videoUploadRow.style.display = "flex";
        if (videoLinkRow) videoLinkRow.style.display = "flex";
      } else if (mode === "audio") {
        if (btnAudio) btnAudio.classList.add("active");
        if (audioFields) audioFields.classList.remove("hidden");
      }
    }

    // ===== [JS-11] å¾ã€Œæ–°å¢/ç·¨è¼¯ã€å¾©åŸæˆåˆå§‹ç‹€æ…‹ ======
    function resetFormToAddMode() {
      const form = document.getElementById("community-form");
      const btnNew = document.getElementById("btn-new");
      const nickEl = document.getElementById("nickname-input");
      const textEl = document.getElementById("text-input");
      const ytEl = document.getElementById("youtube-url-input");
      const startEl = document.getElementById("start-input");
      const endEl = document.getElementById("end-input");
      const videoFile = document.getElementById("video-file-input");
      const videoLabel = document.getElementById("video-file-label");
      const audioFile = document.getElementById("audio-file-input");
      const audioLabel = document.getElementById("audio-file-label");
      const videoLinkEl = document.getElementById("video-link-input");
      const submitBtn = document.getElementById("submit-btn");

      if (nickEl) {
        nickEl.value = "";
        nickEl.placeholder = "Mr,s 09â€¦.";
        nickEl.disabled = false;
      }
      if (textEl) {
        textEl.value = "";
        textEl.disabled = false;
        textEl.style.opacity = "1";
      }
      if (ytEl) ytEl.value = "";
      if (startEl) startEl.value = "";
      if (endEl) endEl.value = "";
      if (videoLinkEl) videoLinkEl.value = "";

      if (videoFile) {
        videoFile.disabled = false;
        videoFile.value = "";
      }
      if (videoLabel) videoLabel.textContent = "";

      if (audioFile) {
        audioFile.disabled = false;
        audioFile.value = "";
      }
      if (audioLabel) audioLabel.textContent = "";

      const btnYoutube = document.getElementById("btn-media-youtube");
      const btnUpload = document.getElementById("btn-media-upload");
      const btnAudio = document.getElementById("btn-media-audio");
      [btnYoutube, btnUpload, btnAudio].forEach((b) => {
        if (b) b.disabled = false;
      });

      setMediaMode(null);
      clearRecordedMediaState();

      if (form) {
        form.classList.add("hidden");
        form.style.display = "none";
      }
      if (btnNew) {
        btnNew.textContent = "æ–°å¢";
      }

      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = "ç™¼è¡¨"; 
      }
      isSubmitting = false;
      isFormOpen = false;
      formMode = "add";

      editState.active = false;
      editState.id = null;
      editState.nickname = "";
      editState.originalText = "";
      editState.waitForSelect = false;

      resetReplyTargetButton();
    }

    // ===== [JS-12] ç·¨è¼¯æµç¨‹ï¼šæŒ‰ã€Œç·¨è¼¯ã€â†’ é¸åˆ— â†’ è¼¸å…¥åŸ username ======
    function startEditForRow(row) {
      if (!row) return;

      editState.active = true;
      editState.id = row.id;
      editState.nickname = normalizeName(row.nickname);
      editState.originalText = row.text || "";

      const form = document.getElementById("community-form");
      const btnNew = document.getElementById("btn-new");
      const nickEl = document.getElementById("nickname-input");
      const textEl = document.getElementById("text-input");

      if (form) {
        form.classList.remove("hidden");
        form.style.display = "block";
      }
      if (btnNew) {
        btnNew.textContent = "å–æ¶ˆç·¨è¼¯";
      }
      isFormOpen = true;
      formMode = "edit";

      if (nickEl) {
        nickEl.disabled = false;
        nickEl.value = "";
        nickEl.placeholder = "è«‹è¼¸å…¥åŸæœ¬ username ä»¥é€²è¡Œç·¨è¼¯";
      }

      if (textEl) {
        textEl.value = editState.originalText;
        textEl.disabled = true;
        textEl.style.opacity = "0.6";
      }

      const btnYoutube = document.getElementById("btn-media-youtube");
      const btnUpload = document.getElementById("btn-media-upload");
      const btnAudio = document.getElementById("btn-media-audio");
      [btnYoutube, btnUpload, btnAudio].forEach((b) => {
        if (b) b.disabled = true;
      });

      setMediaMode(null);
    }

    // ===== [JS-12-1] è¡¨é ­ã€Œç·¨è¼¯ã€æŒ‰éˆ• ======
    function setupEditHeaderButton() {
      const btn = document.getElementById("btn-edit");
      if (!btn) return;

      btn.addEventListener("click", () => {
        const willEnter = !editState.waitForSelect;
        resetFormToAddMode();
        editState.waitForSelect = willEnter;
        renderCommentsTable();
      });
    }

    // ===== [JS-13] è¡¨æ ¼é»æ“Šï¼šé¸å– / é€²å…¥ç·¨è¼¯ / å±•é–‹æ”¶åˆ ======
    function setupTableClicks() {
      const tbody = document.getElementById("comments-tbody");
      if (!tbody) return;

      tbody.addEventListener("click", (e) => {
        const tr = e.target.closest("tr[data-id]");
        if (!tr) return;

        const id = tr.getAttribute("data-id");
        const row = findRowById(id);
        if (!row) return;

        const editBtn = e.target.closest("button.row-edit-btn");

        if (e.target.classList.contains("expand-arrow")) {
          const cell = e.target.closest("td.col-text");
          if (cell && cell.getAttribute("data-expanded") === "1") {
            renderCommentsTable();
            const tbody2 = document.getElementById("comments-tbody");
            if (tbody2) {
              const tr2 = tbody2.querySelector(`tr[data-id="${id}"]`);
              if (tr2) tr2.classList.add("selected");
            }
            return;
          }
        }

        if (editState.waitForSelect) {
          if (editBtn) {
            editState.waitForSelect = false;
            selectRowForReply(row, true);
            startEditForRow(row);
          } else {
            editState.waitForSelect = false;
            renderCommentsTable();
            selectRowForReply(row);
          }
          return;
        }

        selectRowForReply(row);
      });
    }

    // ===== [JS-14] Back éµï¼šå›åˆ°åˆå§‹ç•«é¢ (éœ€æ±‚ 10 ä¿®æ”¹é») ======
    function setupBackButton() {
      const btn = document.getElementById("back-button");
      if (!btn) return;
      btn.addEventListener("click", (ev) => {
        // [éœ€æ±‚ 10] ç¦æ­¢é‡è¼‰è¡Œç‚ºï¼Œåƒ…è·³è½‰å›è¡¨é ­
        ev.preventDefault();
        scrollToVideoTop();
      });
    }

    // ===== [JS-15] ç®¡ç†å“¡å›è¦†å€ ======
    function setupAdminReply() {
      const box = document.getElementById("admin-reply");
      if (!box) return;

      ensureReplyPrefix();
      autoResizeReply();
      hideReplyActions();

      box.addEventListener("focus", () => {
        ensureReplyPrefix();
        autoResizeReply();
      });

      box.addEventListener("input", () => {
        ensureReplyPrefix();
        autoResizeReply();

        const val = box.value || "";
        let contentPart = val;
        if (val.startsWith(REPLY_PREFIX)) {
          contentPart = val.slice(REPLY_PREFIX.length);
        }
        if (contentPart.trim()) {
          showReplyActions();
        } else {
          hideReplyActions();
        }
      });

      box.addEventListener("keydown", (ev) => {
        const prefix = REPLY_PREFIX;
        const prefixLen = prefix.length;
        const pos = box.selectionStart || 0;

        if (pos <= prefixLen) {
          const blockedKeys = [
            "Backspace",
            "Delete",
            "ArrowLeft",
          ];
          const allowKeys = [
            "ArrowRight",
            "ArrowDown",
            "ArrowUp",
            "Tab",
          ];

          // è£œå¼·ï¼šé˜²æ­¢åœ¨å‰ç¶´å­—ä¸­é–“ä»‹å…¥ä¸¦æ›è¡Œ
          if (ev.key === "Enter" || (!ev.ctrlKey && !ev.metaKey && !allowKeys.includes(ev.key))) {
              if (ev.key === "Enter") {
                  ev.preventDefault();
                  if (!box.value.slice(prefixLen).startsWith("\n")) {
                      box.value = prefix + "\n" + box.value.slice(prefixLen).replace(/^\s+/, "");
                  }
                  const startOfContent = prefixLen + 1;
                  box.setSelectionRange(startOfContent, startOfContent);
                  return;
              }

              if (blockedKeys.includes(ev.key) || ev.key.length === 1) {
                  ev.preventDefault();
                  const safePos = prefixLen + 1;
                  try {
                      box.setSelectionRange(safePos, safePos);
                  } catch (e) {}
              }
          }
        }
      });

      const btnSave = document.getElementById("reply-save-btn");
      const btnCancel = document.getElementById("reply-cancel-btn");
      if (btnSave) {
        btnSave.addEventListener("click", () => {
          saveAdminReply();
        });
      }
      if (btnCancel) {
        btnCancel.addEventListener("click", () => {
          cancelAdminReply();
          try {
            box.blur();
          } catch (e) {}
        });
      }
    }

    // ===== [JS-16] From: æŒ‰éˆ• â†’ å›åˆ°è©²åˆ—ä¸¦å±•é–‹æ–‡å­— ======
    function setupReplyTargetButton() {
      const btn = document.getElementById("reply-target-btn");
      if (!btn) return;

      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        if (!id) return;

        const tbody = document.getElementById("comments-tbody");
        if (!tbody) return;

        const tr = tbody.querySelector(`tr[data-id="${id}"]`);
        if (!tr) return;

        const row = findRowById(id);
        if (!row) return;

        tr.scrollIntoView({ behavior: "smooth", block: "center" });
        tr.classList.add("row-flash");
        setTimeout(() => tr.classList.remove("row-flash"), 800);

        const cell = tr.querySelector("td.col-text");
        if (cell && String(row.text || "").length > 30) {
          cell.innerHTML =
            escapeHtml(row.text) +
            '<span class="expand-arrow" title="æ”¶åˆ">â–²</span>';
          cell.setAttribute("data-expanded", "1");
        }
      });
    }

    // ===== [JS-17] username æ³¨éŸ³ä¿è­· + Enter é˜²é€å‡º ======
    let isComposingName = false;

    function tryUnlockEditByName() {
      if (!editState.active) return;
      if (isComposingName) return;

      const nickEl = document.getElementById("nickname-input");
      const textEl = document.getElementById("text-input");
      if (!nickEl || !textEl) return;

      const typedRaw = String(nickEl.value || "");
      const typed = normalizeName(typedRaw);
      const target = normalizeName(editState.nickname);
      if (!typed || !target) return;

      if (!validateNameLength(typed)) return;
      if (typed !== target) return;

      nickEl.disabled = true;
      textEl.disabled = false;
      textEl.style.opacity = "1";
      textEl.focus();
      const len = textEl.value.length;
      try {
        textEl.setSelectionRange(len, len);
      } catch (e) {}
    }

    function setupEditNameGuard() {
      const nickEl = document.getElementById("nickname-input");
      if (!nickEl) return;

      nickEl.addEventListener("compositionstart", () => {
        isComposingName = true;
      });
      nickEl.addEventListener("compositionend", () => {
        isComposingName = false;
        tryUnlockEditByName();
      });
      nickEl.addEventListener("input", tryUnlockEditByName);
      nickEl.addEventListener("change", tryUnlockEditByName);
      nickEl.addEventListener("blur", tryUnlockEditByName);

      nickEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          ev.preventDefault();
          tryUnlockEditByName();
        }
      });
    }

    // é …ç›®æ¬„ä½ Enter é˜²èª¤é€å‡º
    function setupTextInputEnterGuard() {
      const textEl = document.getElementById("text-input");
      if (!textEl) return;

      textEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          ev.preventDefault();
        }
      });
    }

    // ===== [JS-18] é€å‡ºè™•ç† (éœ€æ±‚ 3 ä¿®æ”¹é») ======
    async function handleSubmit(e) {
      e.preventDefault();

      if (isSubmitting) return;

      const submitBtn = document.getElementById("submit-btn");
      const nickEl = document.getElementById("nickname-input");
      const textEl = document.getElementById("text-input");
      const ytEl = document.getElementById("youtube-url-input");
      const startEl = document.getElementById("start-input");
      const endEl = document.getElementById("end-input");
      const videoFile = document.getElementById("video-file-input");
      const audioFile = document.getElementById("audio-file-input");
      const videoLinkEl = document.getElementById("video-link-input");

      const nicknameInput = nickEl ? nickEl.value : "";
      const nickname = normalizeName(nicknameInput);
      const text = (textEl?.value || "").trim();
      const youtubeUrl = (ytEl?.value || "").trim();
      const startSec = parseTimeToSec(startEl?.value);
      const endSec = parseTimeToSec(endEl?.value);
      const vFile = videoFile && videoFile.files[0];
      const aFile = audioFile && audioFile.files[0];
      const videoLink = (videoLinkEl?.value || "").trim();

      const isEditing = editState.active && editState.id;

      try {
        if (!validateNameLength(nickname)) {
          alert("username è«‹ä½¿ç”¨ 5â€“12 å€‹ä¸­è‹±æ–‡æˆ–æ•¸å­—ï¼ˆä¸å«ç©ºç™½èˆ‡ç¬¦è™Ÿï¼‰ã€‚");
          if (nickEl) nickEl.focus();
          return;
        }

        if (isEditing) {
          const target = normalizeName(editState.nickname);
          if (nickname !== target) {
            alert("è«‹è¼¸å…¥ç•¶åˆå¡«å¯«çš„ usernameï¼ˆéœ€èˆ‡åŸå§‹ç´€éŒ„å®Œå…¨ä¸€è‡´ï¼‰ã€‚");
            if (nickEl) nickEl.focus();
            return;
          }
        }

        if (!text) {
          alert("è«‹å…ˆè¼¸å…¥ã€Œé …ç›®ã€èªªæ˜ï¼ˆ100 å­—å…§ï¼‰ã€‚");
          if (textEl) textEl.focus();
          return;
        }

        if (text.length > 100) {
          alert("èªªæ˜è«‹æ§åˆ¶åœ¨ 100 å­—ä»¥å…§ã€‚");
          if (textEl) textEl.focus();
          return;
        }

        // éœ€æ±‚ 3: ç«‹å³å•Ÿå‹•è™•ç†ä¸­æ–‡å­—ä¸¦ç¦ç”¨
        isSubmitting = true;
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "è™•ç†ä¸­..";
        }

        // ===== ç·¨è¼¯æ¨¡å¼ï¼šåªæ”¹æ–‡å­— =====
        if (isEditing) {
          const editingId = editState.id;
          let textToSend = text;
          if (/^[0-9]+$/.test(text)) {
            textToSend = "\u200B" + text;
          }

          const params = new URLSearchParams({
            action: "edit",
            id: String(editingId),
            text: textToSend,
          });

          const res = await fetch(API_URL + "?" + params.toString());
          const data = await res.json();

          if (!data || data.status !== "ok") {
            throw new Error(data.error || "edit å¤±æ•—");
          }

          resetFormToAddMode();
          // 12. ä¿®æ”¹é»ï¼šç·¨è¼¯å¾Œè·³è½‰å›è©²é …ç›®
          await loadComments(editingId);
          return;
        }

        // ===== æ–°å¢æ¨¡å¼ =====
        let type = "text";
        let nicknameToSend = nickname;
        if (/^[0-9]+$/.test(nickname)) {
          nicknameToSend = "\u200B" + nickname;
        }
        let textToSend = text;
        if (/^[0-9]+$/.test(text)) {
          textToSend = "\u200B" + text;
        }

        const payload = {
          action: "add",
          nickname: nicknameToSend,
          text: textToSend,
          startSec: startSec === "" ? "" : String(startSec),
          endSec: endSec === "" ? "" : String(endSec),
        };

        if (youtubeUrl) {
          type = "youtube";
          payload.type = type;
          payload.youtubeUrl = youtubeUrl;
        } else if (videoLink) {
          type = "upload";
          payload.type = type;
          payload.externalUrl = videoLink;
        } else if (vFile) {
          type = "upload";
          payload.type = type;
          const base64 = await readFileAsBase64(vFile);
          payload.videoBase64 = base64;
          payload.mimeType = vFile.type || "application/octet-stream";
          payload.fileName = vFile.name || "video_" + Date.now();
        } else if (aFile || window.recordedAudioBlob) {
          type = "audio";
          payload.type = type;
          let blobToUse = aFile || window.recordedAudioBlob;
          const base64 = await readFileAsBase64(blobToUse);
          payload.audioBase64 = base64;
          payload.audioMimeType = blobToUse.type || "audio/webm";
          payload.audioFileName = aFile ? aFile.name : "audio_" + Date.now() + ".webm";
        } else {
          payload.type = "text";
        }

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();

        if (!data || data.status !== "ok") {
          throw new Error(data.error || "add å¤±æ•—");
        }

        resetFormToAddMode();
        // 12. ä¿®æ”¹é»ï¼šæ–°å¢å¾Œè·³è½‰åˆ°å‰›ç”Ÿæˆçš„é …ç›® (data.id)
        await loadComments(data.id);
      } catch (err) {
        console.error(err);
        alert("å¤±æ•—ï¼š" + err.message);
      } finally {
        // æ¢å¾©æ–‡å­—
        isSubmitting = false;
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "ç™¼è¡¨";
        }
      }
    }

    // ===== [JS-18-1] å·¥å…·åˆ— & è¡¨å–®ç¶å®š ======
    function bindToolbarAndForm() {
      const form = document.getElementById("community-form");
      const btnNew = document.getElementById("btn-new");
      const btnYoutube = document.getElementById("btn-media-youtube");
      const btnUpload = document.getElementById("btn-media-upload");
      const btnAudio = document.getElementById("btn-media-audio");
      const videoFile = document.getElementById("video-file-input");
      const videoLabel = document.getElementById("video-file-label");
      const audioFile = document.getElementById("audio-file-input");
      const audioLabel = document.getElementById("audio-file-label");
      const ytEl = document.getElementById("youtube-url-input");
      const startEl = document.getElementById("start-input");
      const endEl = document.getElementById("end-input");
      const videoLinkEl = document.getElementById("video-link-input");

      if (!form) return;

      form.classList.add("hidden");
      form.style.display = "none";
      setMediaMode(null);
      isFormOpen = false;

      if (btnNew) {
        btnNew.addEventListener("click", () => {
          if (!isFormOpen) {
            editState.active = false;
            editState.id = null;
            editState.nickname = "";
            editState.originalText = "";
            editState.waitForSelect = false;

            form.classList.remove("hidden");
            form.style.display = "block";
            btnNew.textContent = "å–æ¶ˆæ–°å¢";
            isFormOpen = true;
            formMode = "add";

            setMediaMode(null);
            clearRecordedMediaState();
          } else {
            resetFormToAddMode();
          }
        });
      }

      function bindMediaButton(btn, modeName) {
        if (!btn) return;
        btn.addEventListener("click", () => {
          if (editState.active || btn.disabled) return;
          if (window.currentMediaMode === modeName) {
            setMediaMode(null);
          } else {
            setMediaMode(modeName);
          }
          clearRecordedMediaState();

          if (modeName === "youtube") {
            if (videoFile) videoFile.value = "";
            if (videoLabel) videoLabel.textContent = "";
            if (audioFile) audioFile.value = "";
            if (audioLabel) audioLabel.textContent = "";
            if (videoLinkEl) videoLinkEl.value = "";
          } else if (modeName === "upload") {
            if (ytEl) ytEl.value = "";
            if (startEl) startEl.value = "";
            if (endEl) endEl.value = "";
            if (audioFile) audioFile.value = "";
            if (audioLabel) audioLabel.textContent = "";
          } else if (modeName === "audio") {
            if (ytEl) ytEl.value = "";
            if (startEl) startEl.value = "";
            if (endEl) endEl.value = "";
            if (videoFile) videoFile.value = "";
            if (videoLabel) videoLabel.textContent = "";
            if (videoLinkEl) videoLinkEl.value = "";
          }
        });
      }

      bindMediaButton(btnYoutube, "youtube");
      bindMediaButton(btnUpload, "upload");
      bindMediaButton(btnAudio, "audio");

      if (videoFile && videoLabel) {
        videoFile.addEventListener("change", () => {
          if (videoFile.files && videoFile.files[0]) {
            videoLabel.textContent = "å·²é¸æ“‡ï¼š" + videoFile.files[0].name;
          } else {
            videoLabel.textContent = "";
          }
        });
      }

      if (audioFile && audioLabel) {
        audioFile.addEventListener("change", () => {
          if (audioFile.files && audioFile.files[0]) {
            audioLabel.textContent = "å·²é¸æ“‡ï¼š" + audioFile.files[0].name;
          } else {
            audioLabel.textContent = "";
          }
        });
      }

      form.addEventListener("submit", handleSubmit);
    }

    // ===== [JS-19] DOMContentLoadedï¼šå…¨éƒ¨å•Ÿå‹• ======
    document.addEventListener("DOMContentLoaded", () => {
      window.currentMediaMode = null;

      bindToolbarAndForm();
      setupTableClicks();
      setupBackButton();
      setupAdminReply();
      setupEditHeaderButton();
      setupReplyTargetButton();
      setupAudioRecording();
      setupEditNameGuard();
      setupTextInputEnterGuard();

      clearVideo();

      const replyBox = document.getElementById("admin-reply");

      // [è™•ç†ä¸­é˜²å‘† + ç·¨è¼¯é˜²å‘†] å…¨åŸŸç›£è½
      // ä½¿ç”¨æ•ç²éšæ®µï¼ˆtrueï¼‰ä¾†ç¢ºä¿ç¬¬ä¸€æ™‚é–“æ””æˆªäº‹ä»¶
      document.addEventListener("mousedown", (ev) => {
        // 1. å¦‚æœæ­£åœ¨ã€Œè™•ç†ä¸­..ã€ï¼Œé˜»æ–·æ‰€æœ‰é é¢é»æ“Šå‹•ä½œ
        if (isSubmitting) {
            ev.stopPropagation();
            ev.preventDefault();
            return;
        }

        // 2. åŸæœ‰çš„å›è¦†å€ç·¨è¼¯é˜²å‘†
        if (replyDirty && ev.target !== replyBox) {
            const actionsWrap = document.getElementById("reply-actions");
            if (actionsWrap && !actionsWrap.contains(ev.target)) {
                ev.preventDefault();
                replyBox.focus();

                // è¦–è¦ºé–ƒå‹•æç¤º
                replyBox.classList.add("reply-force-focus");
                setTimeout(() => replyBox.classList.remove("reply-force-focus"), 500);
            }
        }
      }, true);

      // è¼‰å…¥è³‡æ–™ï¼ˆå…§éƒ¨å·²åŒ…å«å±•ç¤ºæœ€æ–°ä¸€ç­†å½±éŸ³é …ç›®çš„é‚è¼¯ï¼‰
      loadComments().catch((err) => {
        console.error(err);
      });
    });
  </script>
</body>
</html>

