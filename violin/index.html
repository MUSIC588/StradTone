TYPE html>
<html lang="zh-TW">
    <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
            <title>Violin Pro 1:1 Trainer</title>
        <style>
                    :root {
                                    --bg-color: #1a1a1a;
                                    --wood: #3d2b1f;
                    }
                    body {
                                    margin: 0;
                                    background: var(--bg-color);
                                    color: white;
                                    display: flex;
                                    justify-content: center;
                                    align-items: flex-start;
                                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica;
                                    /* 關鍵：防止選取與系統手勢 */
                                    user-select: none;
                                    -webkit-user-select: none;
                                    touch-action: none;
                                    overflow: hidden;
                    }

                    #fingerboard {
                                    width: 70mm;
                                    height: 180mm;
                                    background: linear-gradient(to right, #222, #111 50%, #222);
                                    position: relative;
                                    border-top: 6mm solid #333; /* Nut */
                                    box-shadow: 0 0 50px rgba(0,0,0,0.8);
                                    margin-top: 40px;
                    }

                    .string {
                                    width: 1.5px;
                                    height: 100%;
                                    background: linear-gradient(to right, #eee, #999);
                                    position: absolute;
                                    top: 0;
                                    box-shadow: 1px 0 2px rgba(0,0,0,0.5);
                    }

                    /* 弦位：E A D G (從右至左) */
                    #string-e { right: 15mm; }
                    #string-a { right: 30mm; }
                    #string-d { right: 45mm; }
                    #string-g { right: 60mm; }

                    /* 準確點位視覺效果 */
                    #marker {
                                    position: absolute;
                                    width: 12mm;
                                    height: 12mm;
                                    background: rgba(76, 175, 80, 0.6);
                                    border: 2px solid #4CAF50;
                                    border-radius: 50%;
                                    transform: translate(50%, -50%);
                                    display: none; /* 預設隱藏 */
                                    justify-content: center;
                                    align-items: center;
                                    font-weight: bold;
                                    color: white;
                                    pointer-events: none;
                                    z-index: 10;
                    }

                    #info {
                                    position: fixed;
                                    top: 15px;
                                    text-align: center;
                                    width: 100%;
                                    z-index: 20;
                                    font-weight: 300;
                                    letter-spacing: 1px;
                    }
                </style>
    </head>
    <body>

        <div id="info">請在弦上按壓以練習音準</div>div>
        <div id="fingerboard">
                <div id="marker"></div>div>
                <div class="string" id="string-g"></div>div>
                <div class="string" id="string-d"></div>div>
                <div class="string" id="string-a"></div>div>
                <div class="string" id="string-e"></div>div>
        </div>div>

        <script>
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const marker = document.getElementById('marker');
                const fingerboard = document.getElementById('fingerboard');
                let activeOsc = null;
                let activeGain = null;

                const L = 328; 
                const strings = {
                            'E': { x: 15, baseFreq: 659.25, notes: ["E","F","F#","G","G#","A","A#","B"] },
                            'A': { x: 30, baseFreq: 440.00, notes: ["A","A#","B","C","C#","D","D#","E"] },
                            'D': { x: 45, baseFreq: 293.66, notes: ["D","D#","E","F","F#","G","G#","A"] },
                            'G': { x: 60, baseFreq: 196.00, notes: ["G","G#","A","A#","B","C","C#","D"] }
                };

                function getDist(n) { return L * (1 - Math.pow(0.5, n / 12)); }

                // 處理觸控開始
                fingerboard.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            handleInteraction(e.touches[0]);
                }, { passive: false });

                // 處理觸控移動 (長按滑動)
                fingerboard.addEventListener('touchmove', (e) => {
                            e.preventDefault();
                            handleInteraction(e.touches[0]);
                }, { passive: false });

                // 觸控結束
                fingerboard.addEventListener('touchend', stopSound);

                function handleInteraction(touch) {
                            if (audioCtx.state === 'suspended') audioCtx.resume();

                            const rect = fingerboard.getBoundingClientRect();
                            const pxToMm = 25.4 / 96; 
                            const touchX_mm = (rect.right - touch.clientX) * pxToMm;
                            const touchY_mm = (touch.clientY - rect.top) * pxToMm;

                            // 1. 識別弦
                            let activeStrKey = null;
                            for (let s in strings) {
                                            if (Math.abs(touchX_mm - strings[s].x) < 6) {
                                                                activeStrKey = s;
                                                                break;
                                            }
                            }

                            if (!activeStrKey) {
                                            stopSound();
                                            return;
                            }

                            // 2. 識別半音位
                            let closestNote = -1;
                            let minDist = 999;
                            for (let n = 1; n <= 7; n++) {
                                            let d = getDist(n);
                                            if (Math.abs(touchY_mm - d) < minDist) {
                                                                minDist = Math.abs(touchY_mm - d);
                                                                closestNote = n;
                                            }
                            }

                            const stepWidth = getDist(closestNote + 1) - getDist(closestNote);
                            const tolerance = stepWidth * 0.1;

                            // 3. 判斷是否在 10% 內
                            if (minDist <= tolerance) {
                                            const freq = strings[activeStrKey].baseFreq * Math.pow(2, closestNote / 12);
                                            const noteName = strings[activeStrKey].notes[closestNote];
                                            showMarker(touch.clientX, touch.clientY, noteName);
                                            startContinuousSound(freq);
                            } else {
                                            // 4. 不在 10% 內，發出敲擊聲並隱藏標記
                                            marker.style.display = 'none';
                                            playTapSound();
                                            stopSound(); // 停止持續音
                            }
                }

                function startContinuousSound(freq) {
                            if (activeOsc && Math.abs(activeOsc.frequency.value - freq) < 1) return;
                            stopSound();

                            activeOsc = audioCtx.createOscillator();
                            activeGain = audioCtx.createGain();
                            activeOsc.type = 'sawtooth'; // 鋸齒波較像弦樂感

                            // 低通濾波器讓聲音柔和一點
                            const filter = audioCtx.createBiquadFilter();
                            filter.type = "lowpass";
                            filter.frequency.value = 2000;

                            activeOsc.frequency.setValueAtTime(fresv 1itsa5vmer
        </script>
    </body>
        </style></title>
    </head>
