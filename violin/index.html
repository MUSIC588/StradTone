<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StradTone Violin</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, "Microsoft JhengHei", sans-serif;
      background: #222629;
      color: #f5f5f5;
    }

    /* æ•´å€‹é é¢çš„å®¹å™¨ï¼šæ¡Œæ©Ÿç½®ä¸­ã€å›ºå®šå¯¬åº¦ï¼Œé¿å…ç¸®æ”¾æ™‚æ•´å¡Šäº‚é£„ */
    .page {
      min-height: 100vh;
      padding: 12px;
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }

    header h1 { font-size: 20px; margin: 0; }
    header h2 { font-size: 14px; margin: 0; opacity: 0.8; }
    header small { font-size: 12px; opacity: 0.7; }

    main.layout {
      display: flex;
      gap: 12px;
      align-items: stretch;
    }

    .panel {
      background: #2d3236;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.35);
      min-height: 220px;
    }

    /* å·¦ 40%ã€å³ 60%ï¼ˆæ¡Œæ©Ÿï¼‰ */
    .panel-left  { flex: 0 0 40%; max-width: 40%; display: flex; flex-direction: column; }
    .panel-right { flex: 0 0 60%; max-width: 60%; display: flex; flex-direction: column; }

    h2 { font-size: 16px; margin: 0 0 4px; }

    /* ã€Œçµ¦ç«™ä¸»çœ‹çš„èªªæ˜ã€æ–‡å­— â†’ æ”¹æˆè·ŸèƒŒæ™¯ä¸€æ¨£è‰²ï¼Œç­‰æ–¼éš±è— */
    .hint,
    .reply-note {
      font-size: 12px;
      line-height: 1.4;
      color: #222629;  /* å’Œ body èƒŒæ™¯ä¸€æ¨£ */
    }

    .hidden { display: none !important; }

    /* placeholder é¡è‰²å†æ·¡ä¸€é» */
    input::placeholder,
    textarea::placeholder {
      color: #999;
      opacity: 0.7;
    }
    input::-webkit-input-placeholder,
    textarea::-webkit-input-placeholder {
      color: #999;
      opacity: 0.7;
    }


/* =====================================================
 * [CSS-1] å·¦å´ï¼šå·¥å…·åˆ— + è¡¨å–®
 * ===================================================== */

.toolbar {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
  flex-wrap: wrap;
}

.toolbar button {
  padding: 4px 10px;
  border-radius: 14px;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 12px;
  cursor: pointer;
}
.toolbar button:hover { background: #4a5056; }

form#community-form {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 8px;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #d1a343;        /* é‚Šæ¡†æ”¹æˆé‡‘è‰²ä¸€é» */
  background: #141b20;               /* åº•è‰²åŠ æ·±ï¼Œèˆ‡è¡¨æ ¼å€æ‹‰é–‹ */
  box-shadow: 0 0 10px rgba(0,0,0,0.65);
}
form#community-form label {
  font-size: 13px;
  display: block;
}

form#community-form input[type="text"] {
  width: 100%;
  padding: 4px 6px;
  margin-top: 2px;
  border-radius: 4px;
  border: 1px solid #555;
  background: #1f2326;
  color: #f5f5f5;
  font-size: 13px;
}

/* ç·¨è¼¯ / ç™¼è¡¨æ™‚å¯è¼¸å…¥ â†’ ç™½åº• */
form#community-form input[type="text"]:not(:disabled) {
  background: #ffffff;
  color: #111;
}

/* é–å®šç‹€æ…‹ï¼ˆç­‰åç¨±é©—è­‰ï¼‰â†’ æ·±åº• */
form#community-form input[type="text"]:disabled {
  background: #1f2326;
  color: #999;
}

#record-btn {
  padding: 4px 10px;
  border-radius: 16px;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 12px;
  cursor: not-allowed; /* é ç•™éŒ„éŸ³ */
  opacity: 0.6;
}

.form-row-inline {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}

#video-file-input {
  font-size: 11px;
}

#video-file-label {
  font-size: 11px;
  opacity: 0.8;
}

#submit-btn {
  padding: 4px 14px;
  border-radius: 16px;
  border: none;
  background: #d1a343;
  color: #1d1d1d;
  font-size: 13px;
  cursor: pointer;
}
#submit-btn:hover { background: #e0b85f; }

/* é˜²æ­¢é€£é»æ™‚çš„è¦–è¦ºåé¥‹ */
#submit-btn:disabled, .reply-action-btn:disabled {
  opacity: 0.7;
  cursor: wait;
}

.sub-hint {
  font-size: 11px;
  opacity: 0.8;
}

/* ä¸‰é¡†åª’é«”é¸æ“‡æŒ‰éˆ• */
.media-select-row {
  margin: 4px 0 2px;
  gap: 6px;
}

.media-select-btn {
  padding: 3px 10px;
  border-radius: 14px;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 12px;
  cursor: pointer;
  opacity: 0.9;
  transition: all 0.2s;
}

/* [åª’é«”è®Šè‰²æ¨£å¼] é¸ä¸­æ™‚è®Šå®˜æ–¹é®®ç´… */
.media-select-btn.active-bright-red {
  background: #FF0000 !important;
  border-color: #FF8080;
  color: #FFFFFF !important;
  font-weight: 600;
  box-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
}

/* [åª’é«”è®Šè‰²æ¨£å¼] YouTube æš«æ™‚è®Šæš—ç°è‰² */
.media-select-btn.dimmed-gray {
  background: #3a3f44 !important;
  border-color: #777 !important;
  color: #f5f5f5 !important;
  font-weight: normal !important;
}

.media-select-btn:disabled {
  opacity: 0.2;
  filter: grayscale(0.8);
  cursor: default;
}

/* [éœ€æ±‚ 6 è£œå¼·] YouTube å®˜æ–¹è‰²å¡æ ¡æ­£ */
#btn-media-youtube {
  background: #FF0000;           /* å®˜æ–¹æ¨™èªŒç´… */
  border-color: #FF4D4D;        /* äº®è‰²é‚Šæ¡† */
  color: #FFFFFF;               /* æ”¹ç‚ºç™½å­—æ›´é¡¯çœ¼ */
  font-weight: 600;
}
#btn-media-youtube:hover:not(:disabled) {
  background: #CC0000;           /* æ‡¸åœæ™‚æ·±ç´… */
}


/* è¡¨å–®å…§ï¼šéŒ„å½±/éŒ„éŸ³æ§åˆ¶åˆ—ï¼ˆç›®å‰åªçµ¦éŒ„éŸ³ç”¨ï¼‰ */
.media-record-toolbar {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 4px;
  font-size: 11px;
}
.media-record-btn {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease, opacity 0.15s ease;
}
.media-record-btn[disabled] {
  opacity: 0.4;
  cursor: default;
}

/* éŒ„éŸ³ä¸­ï¼šç™½é»è®Šç´…ã€å¤–è§€ç¨äº®ä¸¦é–ƒçˆ */
.media-record-btn.recording {
  color: #ff4b4b;
  border-color: #ff8080;
  background: #4a3a3a;
  animation: recordBlink 0.8s ease-in-out infinite;
}

@keyframes recordBlink {
  0%   { opacity: 1; }
  50%  { opacity: 0.3; }
  100% { opacity: 1; }
}
/* å³ä¸Šå½±éŸ³å€çš„ audio æ’­æ”¾å™¨ï¼ˆæœ‰éŒ„éŸ³æ™‚ä½¿ç”¨ï¼‰ */
#audio-player {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  background: #111315;
  display: none; /* é è¨­éš±è—ï¼Œéœ€è¦æ™‚ç”± JS é¡¯ç¤º */
}

.media-record-status {
  font-size: 11px;
  opacity: 0.8;
}

/* éŒ„å½± / éŒ„éŸ³é è¦½å€ */
.rec-preview {
  width: 100%;
  max-height: 140px;
  border-radius: 4px;
  border: 1px solid #444;
  background: #111;
}


  /* =====================================================
 * [CSS-2] å·¦å´ï¼šç•™è¨€åˆ—è¡¨è¡¨æ ¼
 * ===================================================== */

.comments-wrapper {
  flex: 1 1 auto;
  overflow-y: auto;           
  overflow-x: hidden;         
  border-radius: 6px;
  border: 1px solid #444;
  background: #202427;
}
table#comments-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  table-layout: fixed;        
}
table#comments-table thead {
  position: sticky;
  top: 0;
  background: #33383c;
  z-index: 1;
}
table#comments-table th,
table#comments-table td {
  border-bottom: 1px solid #333;
  padding: 4px 6px;
  text-align: left;
  vertical-align: top;
  word-wrap: break-word;
  word-break: break-word;     
}
table#comments-table th {
  font-weight: 600;
  font-size: 12px;
}
table#comments-table tbody tr:nth-child(even) {
  background: #252a2e;
}

.col-nick  { width: 80px; white-space: nowrap; }
.col-text  { width: 50%; position: relative; }
.col-media { width: 90px; }

.media-icons {
  display: flex;
  gap: 4px;
  align-items: center;
  flex-wrap: wrap;
  font-size: 13px;
}

.media-flag {
  font-size: 16px;   
}

/* æ¯åˆ—å‰é¢çš„ç­†æŒ‰éˆ•ï¼ˆé€²å…¥ç·¨è¼¯ç”¨ï¼‰ */
.row-edit-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  margin-right: 4px;
  border-radius: 4px;
  border: 1px solid #888;
  background: #3a3f44;
  box-shadow: 0 0 3px rgba(0,0,0,0.5);
  font-size: 12px;
  cursor: pointer;
  flex-shrink: 0;
}
.row-edit-btn:hover {
  background: #4a5056;
}

.play-video-btn {
  padding: 2px 6px;
  border-radius: 12px;
  border: 1px solid #888;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 11px;
  cursor: pointer;
  margin-top: 2px;
}

/* è¡¨é ­çš„ã€Œç·¨è¼¯ã€å°éˆ• */
.edit-header-btn {
  margin-left: 6px;
  padding: 1px 6px;
  border-radius: 10px;
  border: 1px solid #666;
  background: #2f3438;
  color: #d0d0d0;
  font-size: 10px;
  cursor: pointer;
  opacity: 0.8;
}
.edit-header-btn:hover {
  opacity: 1;
  background: #4a5056;
}

.expand-arrow {
  font-size: 10px;
  opacity: 0.7;
  float: right;
  margin-left: 4px;
  cursor: pointer;
}

#comments-tbody tr.selected {
  background: #4f7a3b !important; 
}

/* é¸åˆ°çš„åˆ—é–ƒä¸€ä¸‹ */
.row-flash {
  animation: rowFlash 0.8s ease-out;
}
@keyframes rowFlash {
  0%   { background-color: #7fbf4f; }
  100% { background-color: inherit; }
}

/* å·¦å´ Back æŒ‰éˆ• */
#back-button {
  margin-top: 6px;
  align-self: flex-start;
  padding: 4px 10px;
  border-radius: 14px;
  border: 1px solid #777;
  background: #3a3f44;
  color: #f5f5f5;
  font-size: 12px;
  cursor: pointer;
}


    /* =====================================================
     * [CSS-3] å³å´ï¼šè¦–è¦ºå€æ¡†æ¶
     * ===================================================== */

    .visual-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }
    .visual-header {
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .current-point { font-size: 12px; opacity: 0.9; }

    .current-point {
      display: none;
    }

    .visual-body {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 260px;
    }

    .top-row {
      display: flex;
      gap: 8px;
      min-height: 170px;
    }

    /* å·¦ï¼šå½±ç‰‡ï¼éŒ„éŸ³æ ¼å­ */
    .video-frame-wrap {
      flex: 1 1 60%;
      background: #111315;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #555;
      position: relative;
      min-height: 150px;
    }
    .video-frame-wrap iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .video-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #999;
      text-align: center;
      padding: 8px;
    }

    /* =====================================================
     * [CSS-4] å³å´ï¼šå¤šå±¤åœ“
     * ===================================================== */

    .circle-area {
      flex: 1 1 40%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .circle-stack {
      position: relative;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      --ring-main-color: #5c7a5c;
      --ring-boundary-color: #9ad09a;
      --ring-highlight-color: #70ff70;
      --ring-outer-fog: rgba(112, 255, 112, 0.35);
      background: radial-gradient(circle at 20% 20%, #555, #111);
    }

    .ring {
      position: absolute;
      border-radius: 50%;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }

    .ring-main {
      border: 3px solid var(--ring-main-color);
      opacity: 0.8;
    }
    .ring-boundary {
      border: 1.2px solid var(--ring-boundary-color);
      opacity: 0.7;
    }
    .ring-b45 {
      border: 1px solid transparent;
      box-shadow: 0 0 16px var(--ring-outer-fog);
      opacity: 0.9;
    }

    .ring-b45 { inset: 4%;  } 
    .ring-4   { inset: 10%; } 
    .ring-b35 { inset: 20%; } 
    .ring-3   { inset: 26%; } 
    .ring-b25 { inset: 36%; } 
    .ring-2   { inset: 42%; } 
    .ring-b15 { inset: 52%; } 
    .ring-1   { inset: 60%; } 

    .ring.active {
      border-color: var(--ring-highlight-color);
      opacity: 1;
      box-shadow: 0 0 10px rgba(140, 255, 140, 0.9);
    }

    .layer-label {
      position: absolute;
      bottom: 6px;
      right: 8px;
      font-size: 11px;
      color: #cfe9cf;
      text-shadow: 0 0 3px #000;
    }

    .layer-label {
      display: none;
    }

    /* =====================================================
     * [CSS-5] å³å´ä¸‹åŠï¼šå›è¦†å€ + æŒ‡æ¿
     * ===================================================== */

    .bottom-row {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    .reply-area {
      flex: 1 1 60%;
    }

    .reply-area-header {
      font-size: 13px;
      margin: 0 0 4px;
    }

    .reply-target {
      font-size: 12px;
      margin-bottom: 4px;
      opacity: 0.85;
    }

/* å›è¦†å€ä¸‹æ–¹çš„ã€Œå„²å­˜ / å–æ¶ˆã€ */
.reply-actions {
  margin-top: 4px;
  display: flex;
  gap: 6px;
}
.reply-actions.hidden {
  display: none;
}
.reply-action-btn {
  padding: 3px 10px;
  border-radius: 14px;
  border: 1px solid #bbb;
  background: #f5f5f5;
  color: #222629;
  font-size: 12px;
  cursor: pointer;
}
.reply-action-btn.reply-cancel-btn {
  background: #3a3f44;
  color: #f5f5f5;
  border-color: #777;
}

    .reply-target-btn {
      padding: 3px 10px;
      border-radius: 14px;
      border: 1px solid #bbb;
      background: #f5f5f5;
      color: #222629;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }
    .reply-target-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .reply-target-btn.linked {
      background: #4f7a3b;
      border-color: #4f7a3b;
      color: #f5f5f5;
    }

    .reply-note {
      font-size: 11px;
      opacity: 0.75;
      margin-bottom: 4px;
    }

    #admin-reply {
      width: 100%;
      background: #1f2326;
      border: 1px solid #555;
      color: #f5f5f5;
      font-size: 12px;
      border-radius: 4px;
      min-height: 80px;
      resize: none;           
      overflow: hidden;       
      line-height: 1.4;
    }

    .fingerboard-row {
      flex: 1 1 40%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .fingerboard {
      position: relative;
      width: 120px;
      max-width: 140px;
      height: 260px;
      background: linear-gradient(180deg, #181a1d, #34383d);
      border-radius: 14px;
      overflow: hidden;
      border: 2px solid #676f78;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.55);
    }

    .fb-string {
      position: absolute;
      top: 6%;
      bottom: 6%;
      width: 2px;
      background: linear-gradient(180deg, #cfcfcf, #888);
      opacity: 0.9;
    }
    .fb-s1 { left: 20%; transform: skewX(-3deg); }
    .fb-s2 { left: 40%; transform: skewX(-1.5deg); }
    .fb-s3 { left: 62%; transform: skewX( 1.5deg); }
    .fb-s4 { left: 80%; transform: skewX( 3deg); }

    .fingerboard-note {
      position: absolute;
      font-size: 10px;
      color: #fdf5c5;
      opacity: 0.95;
      text-shadow: 0 0 2px #000;
      pointer-events: none;
    }

    /* =====================================================
     * [CSS-6] æ‰‹æ©Ÿç‰ˆ
     * ===================================================== */

    @media (max-width: 820px) {
      .page {
        padding: 0;         
        max-width: 100%;
      }
      main.layout {
        flex-direction: column;
      }
      #visual-panel {
        order: 1;
      }
      #comments-section {
        order: 2;
      }
      .panel-left,
      .panel-right {
        max-width: 100%;
        width: 100%;
        border-radius: 0;
      }
      .panel-right .visual-body {
        min-height: 420px;
      }
      .top-row {
        flex-direction: column;
        min-height: 0;
      }
      .video-frame-wrap {
        width: 100%;
        height: 160px !important;
        min-height: 160px;
      }
      .circle-area {
        justify-content: center;
        margin-top: 6px;
      }
      .bottom-row {
        flex-direction: row;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <h1>StradTone Violin</h1>
      <h2>æç´è²å­¸å¯¦é©—å®¤</h2>
    </header>

    <main class="layout">
      <section class="panel panel-left" id="comments-section">
        <p class="hint">
          å°æç´
        </p>

        <div class="toolbar">
          <button type="button" id="btn-new">æ–°å¢</button>
        </div>

        <form id="community-form" class="hidden">
          <label>
            usernameï¼ˆ5â€“12 å­—å¿…å¡«,ä¿®æ”¹ç·¨è¼¯ç”¨ï¼‰ï¼š
            <input
              type="text"
              id="nickname-input"
              maxlength="12"
              placeholder="Mr,s 09â€¦."
            />
          </label>
          <label>
            é …ç›®ï¼ˆ100 å­—å…§ï¼‰ï¼š
            <input
              type="text"
              id="text-input"
              maxlength="100"
              placeholder="..."
            />
          </label>

          <div class="form-row-inline media-select-row">
            <button
              type="button"
              class="media-select-btn"
              id="btn-media-youtube"
              data-media="youtube"
            >
              YouTube
            </button>
            <button
              type="button"
              class="media-select-btn"
              id="btn-media-upload"
              data-media="upload"
            >
              å½±ç‰‡
            </button>
            <button
              type="button"
              class="media-select-btn"
              id="btn-media-audio"
              data-media="audio"
            >
              éŒ„éŸ³
            </button>
          </div>

          <div id="video-fields" class="hidden">
            <div class="form-row-inline" id="youtube-row" style="margin-top:4px;">
              <input
                type="text"
                id="youtube-url-input"
                placeholder="https://youtu.be/....(Link)â€¦"
              />
              <input
                type="text"
                id="start-input"
                placeholder="é–‹å§‹ mm:ss "
              />
              <input
                type="text"
                id="end-input"
                placeholder="çµæŸ mm:ss "
              />
            </div>

            <div class="form-row-inline" id="video-upload-row" style="margin-top:4px;">
              <input type="file" id="video-file-input" />
              <span id="video-file-label" class="sub-hint"></span>
            </div>
            <div class="form-row-inline" id="video-link-row" style="margin-top:4px;">
              <input
                type="text"
                id="video-link-input"
                placeholder="https://... å½±ç‰‡æˆ–ç¶²é ç¶²å€ï¼ˆé¸å¡«ï¼‰"
              />
            </div>
          </div>

          <div id="audio-fields" class="hidden">
            <div class="media-record-toolbar" id="audio-record-toolbar">
              <button type="button" class="media-record-btn" id="audio-rec-start">â—</button>
              <button type="button" class="media-record-btn" id="audio-rec-pause" disabled>â¸</button>
              <button type="button" class="media-record-btn" id="audio-rec-stop" disabled>â– </button>
              <button type="button" class="media-record-btn" id="audio-rec-cancel" disabled>âœ•</button>
              <span class="media-record-status" id="audio-rec-status">éŒ„éŸ³é å‚™</span>
            </div>

            <div class="form-row-inline" id="audio-upload-row" style="margin-top:4px;">
              <input type="file" id="audio-file-input" accept="audio/*" />
              <span id="audio-file-label" class="sub-hint"></span>
            </div>

            <div class="form-row-inline" id="audio-preview-row" style="margin-top:4px;">
              <audio id="audio-rec-preview" class="rec-preview" controls></audio>
            </div>
          </div>

          <div class="form-row-inline">
            <button type="submit" id="submit-btn">ç™¼è¡¨</button>
          </div>
        </form>

        <div class="comments-wrapper">
          <table id="comments-table">
            <thead>
              <tr>
                <th class="col-nick">username</th>
                <th class="col-text">
                  é …ç›®
                  <button
                    type="button"
                    id="btn-edit"
                    class="edit-header-btn"
                  >
                    ç·¨è¼¯
                  </button>
                </th>
                <th class="col-media">éŒ„éŸ³ / å½±ç‰‡</th>
              </tr>
            </thead>
            <tbody id="comments-tbody">
              </tbody>
          </table>
        </div>

        <button id="back-button" type="button">Back</button>
      </section>

      <section class="panel panel-right" id="visual-panel">
        <div class="visual-wrapper">
          <div class="visual-header">
            <div class="current-point" id="current-info">
              å°šæœªé¸å–ç•™è¨€
            </div>
          </div>

          <div class="visual-body">
            <div class="top-row">
              <div class="video-frame-wrap">
                <iframe
                  id="video-iframe"
                  src=""
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  referrerpolicy="origin-when-cross-origin"
                  allowfullscreen
                ></iframe>

                <audio id="audio-player" controls></audio>

                <div class="video-placeholder" id="video-placeholder">
                  è«‹å¾å·¦å´è¡¨æ ¼é¸å–ä¸€ç­†å¸¶æœ‰å½±ç‰‡æˆ–éŒ„éŸ³çš„é …ç›®
                </div>
              </div>

              <div class="circle-area">
                <div class="circle-stack" id="circle-stack">
                  <div class="ring ring-main ring-1" data-layer="1"></div>
                  <div class="ring ring-main ring-2" data-layer="2"></div>
                  <div class="ring ring-main ring-3" data-layer="3"></div>
                  <div class="ring ring-main ring-4" data-layer="4"></div>
                  <div
                    class="ring ring-boundary ring-b15"
                    data-layer="1.5"
                  ></div>
                  <div
                    class="ring ring-boundary ring-b25"
                    data-layer="2.5"
                  ></div>
                  <div
                    class="ring ring-boundary ring-b35"
                    data-layer="3.5"
                  ></div>
                  <div
                    class="ring ring-b45"
                    data-layer="4.5"
                  ></div>
                </div>
              </div>
            </div>

            <div class="bottom-row">
              <div class="reply-area">
                <div class="reply-target" id="reply-target">
                  <button
                    type="button"
                    id="reply-target-btn"
                    class="reply-target-btn"
                    disabled
                  >
                    From: â€”
                  </button>
                </div>
                <p class="reply-note">
                  </p>
                <textarea
                  id="admin-reply"
                  placeholder="æç´è²å­¸å¯¦é©—å®¤ï¼š"
                ></textarea>

                <div class="reply-actions hidden" id="reply-actions">
                  <button type="button" id="reply-save-btn" class="reply-action-btn">å„²å­˜</button>
                  <button type="button" id="reply-cancel-btn" class="reply-action-btn reply-cancel-btn">å–æ¶ˆ</button>
                </div>
              </div>

              <div class="fingerboard-row">
                <div class="fingerboard" id="fingerboard">
                  <div class="fb-string fb-s1"></div>
                  <div class="fb-string fb-s2"></div>
                  <div class="fb-string fb-s3"></div>
                  <div class="fb-string fb-s4"></div>
                  <div class="fingerboard-note" style="left:24%; top:8%;">G0</div>
                  <div class="fingerboard-note" style="left:24%; top:26%;">G3</div>
                  <div class="fingerboard-note" style="left:38%; top:18%;">D5</div>
                  <div class="fingerboard-note" style="left:38%; top:40%;">D8</div>
                  <div class="fingerboard-note" style="left:62%; top:22%;">A7</div>
                  <div class="fingerboard-note" style="left:62%; top:44%;">A10</div>
                  <div class="fingerboard-note" style="left:76%; top:30%;">E9</div>
                  <div class="fingerboard-note" style="left:76%; top:52%;">E12</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== [JS-0] å…¨åŸŸç‹€æ…‹ =====
    const API_URL = "https://script.google.com/macros/s/AKfycbxn5aDCimtZmvgK4uEGr5fIyNItY2wZgQyO2LVEZkggFkO0VZ_YdDMyspGpzpkYy5W6-A/exec";
    let commentsCache = [];
    let currentSelectedId = null;
    const REPLY_PREFIX = "æç´è²å­¸å¯¦é©—å®¤ï¼š";
    let currentReplyOriginalRaw = "";
    let replyDirty = false;
    let isFormOpen = false;
    let formMode = "add";
    let isSubmitting = false;
    let editState = { active: false, id: null, nickname: "", originalText: "", waitForSelect: false };
    window.recordedAudioBlob = null;
    let audioRecStream = null, audioRecRecorder = null, audioRecChunks = [], audioRecActive = false, audioRecPaused = false, audioRecTimerId = null, audioRecStartTime = 0;
    let carouselActive = false, carouselTimerId = null, carouselUserStopped = true;

    // ===== [JS-1] å°å·¥å…· =====
    function normalizeName(name) { return String(name || "").replace(/\u200B/g, "").trim(); }
    function maskName(name) {
      const s = normalizeName(name); if (!s) return "åŒ¿å";
      if (s.length <= 2) return s[0] + "*";
      return s[0] + "*".repeat(s.length - 2) + s[s.length - 1];
    }
    function validateNameLength(name) {
      const s = normalizeName(name); if (s.length < 5 || s.length > 12) return false;
      return /^[A-Za-z0-9\u4E00-\u9FFF]+$/.test(s);
    }
    function parseTimeToSec(str) {
      if (!str) return ""; const s = String(str).trim();
      let m = s.match(/^(\d+):(\d{1,2})$/); if (m) return Number(m[1]) * 60 + Number(m[2]);
      m = s.match(/^(\d{3,4})$/); if (m) { const digits = m[1]; return Number(digits.slice(0, -2)) * 60 + Number(digits.slice(-2)); }
      return "";
    }
    function escapeHtml(str) { return String(str || "").replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c] || c)); }
    function extractYoutubeId(url) { if (!url) return ""; const m1 = url.match(/youtu\.be\/([^?]+)/); if (m1) return m1[1]; const m2 = url.match(/[?&]v=([^&]+)/); return m2 ? m2[1] : ""; }
    function buildYoutubeEmbedUrl(url, startSec, endSec) {
      const id = extractYoutubeId(url); if (!id) return "";
      const base = "https://www.youtube-nocookie.com/embed/" + id;
      const params = ["autoplay=1", "rel=0", "modestbranding=1", "playsinline=1"];
      if (startSec !== "" && !isNaN(startSec)) params.push("start=" + startSec);
      if (endSec !== "" && !isNaN(endSec)) params.push("end=" + endSec);
      return base + "?" + params.join("&");
    }
    function buildDriveEmbedUrl(fid) { return fid ? "https://drive.google.com/file/d/" + fid + "/preview" : ""; }
    function buildDriveDownloadUrl(fid) { return fid ? "https://drive.google.com/uc?export=download&id=" + fid : ""; }
    function scrollToVideoTop() { window.scrollTo({ top: 0, behavior: "smooth" }); }
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader(); r.onload = () => { const res = r.result || ""; const idx = res.indexOf(","); resolve(idx >= 0 ? res.slice(idx + 1) : result); };
        r.onerror = () => reject(r.error); r.readAsDataURL(file);
      });
    }
    function stopAllPlayback() {
      const iframe = document.getElementById("video-iframe"), audio = document.getElementById("audio-player"), ph = document.getElementById("video-placeholder");
      if (iframe) iframe.src = ""; if (audio) { try { audio.pause(); } catch (e) {} audio.removeAttribute("src"); audio.load(); audio.style.display = "none"; }
      if (ph) ph.style.display = "flex";
    }
    function formatDuration(sec) { const s = Math.max(0, sec | 0); const m = (s / 60) | 0; const r = s % 60; return (m < 10 ? "0" + m : m) + ":" + (r < 10 ? "0" + r : r); }

    // ===== [JS-2] è¼‰å…¥èˆ‡è¡¨æ ¼åˆ—è¡¨ ======
    async function loadComments() {
      const res = await fetch(API_URL + "?action=list", { cache: "no-cache" });
      const data = await res.json(); commentsCache = data.posts || [];
      renderCommentsTable();
      const newestWithMedia = commentsCache.slice().reverse().find(row => {
        const type = row.type || "text";
        return (type === "youtube" && row.youtubeUrl) || (type === "upload" && (row.driveFileId || row.externalUrl || row.linkUrl)) || (type === "audio");
      });
      if (newestWithMedia) selectRowForReply(newestWithMedia, false);
    }

    // ===== [JS-3] æ¸²æŸ“è¡¨æ ¼ ======
    function renderCommentsTable() {
      const tbody = document.getElementById("comments-tbody"); if (!tbody) return;
      if (!commentsCache.length) { tbody.innerHTML = `<tr><td colspan="3">ç›®å‰å°šç„¡é …ç›®</td></tr>`; return; }
      const rows = commentsCache.slice().reverse();
      tbody.innerHTML = rows.map((row) => {
        const nick = maskName(row.nickname);
        const shortText = row.text.length > 30 ? escapeHtml(row.text.slice(0, 30)) + "â€¦" : escapeHtml(row.text);
        const hasAudio = row.type === "audio" || row.hasAudio || row.driveAudioId;
        const hasVideo = (row.type === "youtube" && row.youtubeUrl) || (row.type === "upload" && (row.driveFileId || row.externalUrl || row.linkUrl));
        const hasReply = row.reply && row.reply.replace(REPLY_PREFIX, "").trim();
        let icons = [];
        if (hasAudio) icons.push(`<span class="media-flag">ğŸµ</span>`);
        if (hasVideo) icons.push(`<span class="media-flag">ğŸ¬</span>`);
        if (hasReply) icons.push(`<span class="media-flag">ğŸ’¬</span>`);
        const selected = String(row.id) === String(currentSelectedId) ? ` class="selected"` : "";
        const editBtn = !!editState.waitForSelect ? `<button type="button" class="row-edit-btn" data-id="${row.id}">âœ</button>` : "";
        return `<tr data-id="${row.id}"${selected}><td class="col-nick">${escapeHtml(nick)}</td><td class="col-text">${editBtn}${shortText}</td><td class="col-media"><div class="media-icons">${icons.join("") || "â€”"}</div></td></tr>`;
      }).join("");
    }

    // ===== [JS-4] é¡¯ç¤ºå½±ç‰‡ã€éŸ³è¨Š ======
    function showVideoForRow(row) {
      const iframe = document.getElementById("video-iframe"), audio = document.getElementById("audio-player"), ph = document.getElementById("video-placeholder");
      if (!iframe || !audio || !ph) return; stopAllPlayback();
      iframe.style.display = "none"; audio.style.display = "none"; if (!row) return;
      if (row.type === "youtube" && row.youtubeUrl) {
        const url = buildYoutubeEmbedUrl(row.youtubeUrl, row.startSec, row.endSec);
        if (url) { iframe.src = url; iframe.style.display = "block"; ph.style.display = "none"; }
      } else if (row.type === "upload") {
        const url = row.externalUrl || row.linkUrl || buildDriveEmbedUrl(row.driveFileId);
        if (url) { iframe.src = url; iframe.style.display = "block"; ph.style.display = "none"; }
      } else if (row.type === "audio") {
        const url = row.audioUrl || buildDriveDownloadUrl(row.driveAudioId);
        if (url) { audio.src = url; audio.style.display = "block"; ph.style.display = "none"; try { audio.play(); } catch (e) {} }
      }
      highlightLayers(row.layers);
    }

    // ===== [JS-5] å¤šå±¤åœ“ ======
    function highlightLayers(layerStr) {
      const rings = document.querySelectorAll(".ring"); rings.forEach(r => r.classList.remove("active"));
      if (!layerStr) return; const parts = String(layerStr).split(",").map(s => s.trim());
      rings.forEach(r => { if (parts.includes(r.getAttribute("data-layer"))) r.classList.add("active"); });
    }

    // ===== [JS-6] æŸ¥æ‰¾ row ======
    function findRowById(id) { return commentsCache.find(r => String(r.id) === String(id)); }

    // ===== [JS-7] ç®¡ç†å“¡å›è¦†å€å‰ç¶´ ======
    function ensureReplyPrefix() {
      const box = document.getElementById("admin-reply"); if (!box) return;
      if (!box.value || !box.value.startsWith(REPLY_PREFIX)) { const content = box.value.replace(REPLY_PREFIX, "").trim(); box.value = REPLY_PREFIX + "\n" + content; }
    }
    function autoResizeReply() {
      const box = document.getElementById("admin-reply"); if (!box) return;
      box.style.height = "auto"; box.style.height = Math.min(box.scrollHeight, 260) + "px";
    }

    // ===== [JS-8] é¸å–é …ç›® ======
    function selectRowForReply(row, fromEditStart) {
      if (!row) return; if (!fromEditStart && (editState.active || isFormOpen)) resetFormToAddMode();
      currentSelectedId = row.id; renderCommentsTable();
      const btn = document.getElementById("reply-target-btn");
      if (btn) { btn.textContent = "From: " + maskName(row.nickname); btn.disabled = false; btn.setAttribute("data-id", row.id); btn.classList.add("linked"); }
      const box = document.getElementById("admin-reply"); if (box) { box.value = row.reply ? row.reply : REPLY_PREFIX + "\n"; autoResizeReply(); }
      showVideoForRow(row); scrollToVideoTop();
    }

    // ===== [JS-9] å„²å­˜å›è¦† ======
    async function saveAdminReply() {
      if (!currentSelectedId) return; const btn = document.getElementById("reply-save-btn");
      btn.disabled = true; btn.textContent = "è™•ç†ä¸­..";
      try {
        const params = new URLSearchParams({ action: "reply", id: currentSelectedId, reply: document.getElementById("admin-reply").value.trim() });
        const res = await fetch(API_URL + "?" + params.toString());
        if ((await res.json()).status === "ok") { await loadComments(); }
      } catch (err) { alert("å¤±æ•—"); } finally { btn.disabled = false; btn.textContent = "å„²å­˜"; }
    }

    // ===== [JS-10] åª’é«”æ¨¡å¼åˆ‡æ› (éœ€æ±‚ä¿®æ­£) ======
    function setMediaMode(mode) {
      window.currentMediaMode = mode;
      const btnYt = document.getElementById("btn-media-youtube"), btnUpload = document.getElementById("btn-media-upload"), btnAudio = document.getElementById("btn-media-audio");
      [btnYt, btnUpload, btnAudio].forEach(b => b.classList.remove("active-bright-red", "dimmed-gray"));
      
      if (!mode || mode === "youtube") {
        btnYt.classList.add("active-bright-red");
      } else {
        btnYt.classList.add("dimmed-gray");
        if (mode === "upload") btnUpload.classList.add("active-bright-red");
        if (mode === "audio") btnAudio.classList.add("active-bright-red");
      }
      document.getElementById("video-fields").classList.toggle("hidden", mode === "audio" || !mode);
      document.getElementById("audio-fields").classList.toggle("hidden", mode !== "audio");
      document.getElementById("youtube-row").style.display = (mode === "youtube") ? "flex" : "none";
      document.getElementById("video-upload-row").style.display = (mode === "upload") ? "flex" : "none";
      document.getElementById("video-link-row").style.display = (mode === "upload") ? "flex" : "none";
    }

    // ===== [JS-11] é‡ç½®è¡¨å–® ======
    function resetFormToAddMode() {
      isFormOpen = false; editState.active = false;
      const form = document.getElementById("community-form"); form.classList.add("hidden"); form.style.display = "none";
      document.getElementById("btn-new").textContent = "æ–°å¢"; document.getElementById("nickname-input").value = ""; document.getElementById("text-input").value = "";
      setMediaMode(null);
    }

    // ===== [JS-12] ç·¨è¼¯æµç¨‹ ======
    function startEditForRow(row) {
      editState.active = true; editState.id = row.id; editState.nickname = normalizeName(row.nickname);
      const form = document.getElementById("community-form"); form.classList.remove("hidden"); form.style.display = "block";
      document.getElementById("btn-new").textContent = "å–æ¶ˆç·¨è¼¯"; isFormOpen = true;
      const nickEl = document.getElementById("nickname-input"); nickEl.disabled = false; nickEl.value = "";
      const textEl = document.getElementById("text-input"); textEl.value = row.text || ""; textEl.disabled = true; textEl.style.opacity = "0.6";
      document.querySelectorAll(".media-select-btn").forEach(b => b.disabled = true);
    }

    // ===== [JS-13] è¡¨æ ¼é»æ“Šç›£è½ (æ ¸å¿ƒè·³è½‰) ======
    function setupTableClicks() {
      document.getElementById("comments-tbody")?.addEventListener("click", (e) => {
        const tr = e.target.closest("tr"); if (!tr) return;
        const row = findRowById(tr.dataset.id);
        if (editState.waitForSelect && e.target.classList.contains("row-edit-btn")) {
          editState.waitForSelect = false; selectRowForReply(row, true); startEditForRow(row);
        } else { selectRowForReply(row); }
      });
    }

    // ===== [JS-14] Back æŒ‰éˆ• (éœ€æ±‚ä¿®æ­£) ======
    function setupBackButton() {
      document.getElementById("back-button")?.addEventListener("click", (ev) => {
        ev.preventDefault(); scrollToVideoTop();
      });
    }

    // ===== [JS-15] ç®¡ç†å“¡å›è¦†å€ ======
    function setupAdminReply() {
      const box = document.getElementById("admin-reply"); if (!box) return;
      box.addEventListener("input", () => { ensureReplyPrefix(); autoResizeReply(); if (box.value.replace(REPLY_PREFIX, "").trim()) document.getElementById("reply-actions").classList.remove("hidden"); else document.getElementById("reply-actions").classList.add("hidden"); });
    }

    // ===== [JS-16] From: ä½œè€…è·³è½‰ ======
    function setupReplyTargetButton() {
      document.getElementById("reply-target-btn")?.addEventListener("click", () => {
        const id = document.getElementById("reply-target-btn").getAttribute("data-id");
        const tr = document.querySelector(`tr[data-id="${id}"]`);
        if (tr) { tr.scrollIntoView({ behavior: "smooth", block: "center" }); tr.classList.add("row-flash"); setTimeout(() => tr.classList.remove("row-flash"), 800); }
      });
    }

    // ===== [JS-17] åç¨±é©—è­‰ä¿è­· ======
    function setupEditNameGuard() {
      const nickEl = document.getElementById("nickname-input");
      nickEl?.addEventListener("input", () => {
        if (editState.active && normalizeName(nickEl.value) === editState.nickname) {
          nickEl.disabled = true; const textEl = document.getElementById("text-input");
          textEl.disabled = false; textEl.style.opacity = "1"; textEl.focus();
        }
      });
    }

    // ===== [JS-18] é€å‡ºè™•ç† (ç™¼è¡¨å¼•æ“) ======
    async function handleSubmit(e) {
      e.preventDefault(); if (isSubmitting) return;
      const nick = normalizeName(document.getElementById("nickname-input").value), text = document.getElementById("text-input").value.trim();
      if (!validateNameLength(nick) || !text) return;
      isSubmitting = true; const btn = document.getElementById("submit-btn"); btn.disabled = true;
      try {
        const payload = { action: editState.active ? "edit" : "add", nickname: nick, text: text, id: editState.id };
        const vFile = document.getElementById("video-file-input").files[0];
        if (vFile) { payload.type = "upload"; payload.videoBase64 = await readFileAsBase64(vFile); payload.fileName = vFile.name; }
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        if ((await res.json()).status === "ok") { resetFormToAddMode(); await loadComments(); }
      } catch (e) { alert("éŒ¯èª¤"); } finally { isSubmitting = false; btn.disabled = false; }
    }

    // ===== [JS-19] å…¨éƒ¨å•Ÿå‹•èˆ‡éŒ„éŸ³å¼•æ“ ======
    function setupAudioRecording() {
      const bStart = document.getElementById("audio-rec-start"), sEl = document.getElementById("audio-rec-status");
      bStart?.addEventListener("click", async () => {
        if (audioRecActive) return;
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioRecStream = stream; audioRecRecorder = new MediaRecorder(stream);
          audioRecChunks = []; audioRecRecorder.ondataavailable = e => audioRecChunks.push(e.data);
          audioRecRecorder.onstop = () => { window.recordedAudioBlob = new Blob(audioRecChunks, { type: 'audio/webm' }); document.getElementById("audio-rec-preview").src = URL.createObjectURL(window.recordedAudioBlob); };
          audioRecRecorder.start(); audioRecActive = true; audioRecStartTime = Date.now();
          audioRecTimerId = setInterval(() => { sEl.textContent = "éŒ„éŸ³ä¸­â€¦ " + formatDuration((Date.now() - audioRecStartTime)/1000); }, 500);
          bStart.classList.add("recording");
        } catch (e) { sEl.textContent = "å•Ÿå‹•å¤±æ•—"; }
      });
      document.getElementById("audio-rec-stop")?.addEventListener("click", () => {
        audioRecRecorder?.stop(); if (audioRecStream) audioRecStream.getTracks().forEach(t => t.stop());
        clearInterval(audioRecTimerId); audioRecActive = false;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadComments(); setupTableClicks(); setupBackButton(); setupAdminReply(); 
      setupEditHeaderButton(); setupReplyTargetButton(); setupAudioRecording(); setupEditNameGuard();
      document.getElementById("btn-new").addEventListener("click", () => {
        if (isFormOpen) resetFormToAddMode(); else {
          isFormOpen = true; const form = document.getElementById("community-form");
          form.classList.remove("hidden"); form.style.display = "block"; document.getElementById("btn-new").textContent = "å–æ¶ˆæ–°å¢";
        }
      });
      document.querySelectorAll(".media-select-btn").forEach(b => b.addEventListener("click", () => setMediaMode(b.dataset.media)));
      document.getElementById("community-form").addEventListener("submit", handleSubmit);
      document.getElementById("reply-save-btn").addEventListener("click", saveAdminReply);
    });
  </script>
</body>
</html>

