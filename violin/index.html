<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StradTone Violin</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, "Microsoft JhengHei", sans-serif;
      background: #222629;
      color: #f5f5f5;
    }
    /* æ•´å€‹é é¢çš„å®¹å™¨ï¼šæ¡Œæ©Ÿç½®ä¸­ã€å›ºå®šå¯¬åº¦ï¼Œé¿å…ç¸®æ”¾æ™‚æ•´å¡Šäº‚é£„ */
    .page {
      min-height: 100vh;
      padding: 12px;
      max-width: 1100px;
      margin: 0 auto;
    }
    header {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
    }
    header h1 { font-size: 20px; margin: 0; }
    header h2 { font-size: 14px; margin: 0; opacity: 0.8; }
    header small { font-size: 12px; opacity: 0.7; }
    main.layout {
      display: flex;
      gap: 12px;
      align-items: stretch;
    }
    .panel {
      background: #2d3236;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.35);
      min-height: 220px;
    }
    /* å·¦ 40%ã€å³ 60%ï¼ˆæ¡Œæ©Ÿï¼‰ */
    .panel-left  { flex: 0 0 40%; max-width: 40%; display: flex; flex-direction: column; }
    .panel-right { flex: 0 0 60%; max-width: 60%; display: flex; flex-direction: column; }
    h2 { font-size: 16px; margin: 0 0 4px; }
    /* ã€Œçµ¦ç«™ä¸»çœ‹çš„èªªæ˜ã€æ–‡å­— â†’ æ”¹æˆè·ŸèƒŒæ™¯ä¸€æ¨£è‰²ï¼Œç­‰æ–¼éš±è— */
    .hint,
    .reply-note {
      font-size: 12px;
      line-height: 1.4;
      color: #222629;  /* å’Œ body èƒŒæ™¯ä¸€æ¨£ */
    }
    .hidden { display: none !important; }
    /* placeholder é¡è‰²å†æ·¡ä¸€é» */
    input::placeholder,
    textarea::placeholder {
      color: #999;
      opacity: 0.7;
    }
    input::-webkit-input-placeholder,
    textarea::-webkit-input-placeholder {
      color: #999;
      opacity: 0.7;
    }
    /* =====================================================
     * [CSS-1] å·¦å´ï¼šå·¥å…·åˆ— + è¡¨å–® (å¼·çƒˆèƒŒæ™¯è‰²)
     * ===================================================== */
    .toolbar {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .toolbar button {
      padding: 4px 10px;
      border-radius: 14px;
      border: 1px solid #777;
      background: #3a3f44;
      color: #f5f5f5;
      font-size: 12px;
      cursor: pointer;
    }
    .toolbar button:hover { background: #4a5056; }
    form#community-form {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 2px solid #d1a343; /* é‚Šæ¡†åŠ å¼· */
      background: #4a4f52; /* èƒŒæ™¯åŠ å¼· */
    }
    form#community-form label {
      font-size: 13px;
      display: block;
    }
    form#community-form input[type="text"] {
      width: 100%;
      padding: 4px 6px;
      margin-top: 2px;
      border-radius: 4px;
      border: 1px solid #555;
      background: #1f2326;
      color: #f5f5f5;
      font-size: 13px;
    }
    /* ç·¨è¼¯ / ç™¼è¡¨æ™‚å¯è¼¸å…¥ â†’ ç™½åº• */
    form#community-form input[type="text"]:not(:disabled) {
      background: #ffffff;
      color: #111;
    }
    /* é–å®šç‹€æ…‹ï¼ˆç­‰åç¨±é©—è­‰ï¼‰â†’ æ·±åº• */
    form#community-form input[type="text"]:disabled {
      background: #1f2326;
      color: #999;
    }
    #submit-btn {
      padding: 4px 14px;
      border-radius: 16px;
      border: none;
      background: #d1a343;
      color: #1d1d1d;
      font-size: 13px;
      cursor: pointer;
    }
    #submit-btn:hover { background: #e0b85f; }
    .sub-hint {
      font-size: 11px;
      opacity: 0.8;
    }
    /* ä¸‰é¡†åª’é«”é¸æ“‡æŒ‰éˆ• */
    .media-select-row {
      margin: 4px 0 2px;
      gap: 6px;
    }
    .media-select-btn {
      padding: 3px 10px;
      border-radius: 14px;
      border: 1px solid #777;
      background: #3a3f44;
      color: #f5f5f5;
      font-size: 12px;
      cursor: pointer;
      opacity: 0.9;
    }
    .media-select-btn.active {
      border-color: #d1a343;
      background: #e0b85f;
      color: #1d1d1d;
      font-weight: 600;
    }
    /* è¡¨å–®å…§ï¼šéŒ„å½±/éŒ„éŸ³æ§åˆ¶åˆ—ï¼ˆç›®å‰åªçµ¦éŒ„éŸ³ç”¨ï¼‰ */
    .media-record-toolbar {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      font-size: 11px;
    }
    .media-record-btn {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 1px solid #777;
      background: #3a3f44;
      color: #f5f5f5;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .media-record-btn[disabled] {
      opacity: 0.5;
      cursor: default;
    }
    .media-record-status {
      font-size: 11px;
      opacity: 0.8;
    }
    /* éŒ„å½± / éŒ„éŸ³é è¦½å€ */
    .rec-preview {
      width: 100%;
      max-height: 140px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #111;
    }
    /* =====================================================
     * [CSS-2] å·¦å´ï¼šç•™è¨€åˆ—è¡¨è¡¨æ ¼ (fixed å¯¬åº¦)
     * ===================================================== */
    .comments-wrapper {
      flex: 1 1 auto;
      overflow: auto;
      border-radius: 6px;
      border: 1px solid #444;
      background: #202427;
      max-width: 100%; /* é˜²æ­¢è¡¨æ ¼å…§å®¹æº¢å‡ºé€ æˆå®¹å™¨å·è»¸ */
      overflow-x: hidden;
    }
    table#comments-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 420px;
      table-layout: fixed; /* å›ºå®šæ¬„å¯¬ï¼Œé¿å…å±•é–‹å¾€å·¦å³æ“´å…… */
    }
    table#comments-table thead {
      position: sticky;
      top: 0;
      background: #33383c;
      z-index: 1;
    }
    table#comments-table th,
    table#comments-table td {
      border-bottom: 1px solid #333;
      padding: 4px 6px;
      text-align: left;
      vertical-align: top;
      word-wrap: break-word;
      word-break: break-word;
    }
    table#comments-table th {
      font-weight: 600;
      font-size: 12px;
    }
    table#comments-table tbody tr:nth-child(even) {
      background: #252a2e;
    }
    .col-edit  { width: 30px; text-align: center; } /* ç·¨è¼¯æŒ‰éˆ•æ¬„ */
    .col-nick  { width: 80px; white-space: nowrap; }
    .col-text  { width: auto; } /* è®“æ–‡å­—æ¬„è‡ªå‹•ä¼¸ç¸® */
    .col-media { width: 60px; text-align: center; } /* åª’é«”åœ–ç¤ºæ¬„ */
    /* æ–°å¢çš„ç·¨è¼¯æŒ‰éˆ•æ¨£å¼ */
    .edit-row-btn {
      width: 24px;
      height: 24px;
      padding: 0;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #444;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      transition: all 0.15s ease;
    }
    .edit-row-btn:hover {
      background: #d1a343;
      color: #1d1d1d;
      border-color: #d1a343;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    }
    .media-icons {
      display: flex;
      gap: 4px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      font-size: 16px;
    }
    .media-flag {
      font-size: 16px;
      opacity: 0.8;
    }
    .expand-arrow {
      font-size: 10px;
      opacity: 0.7;
      float: right;
      margin-left: 4px;
      cursor: pointer;
    }
    #comments-tbody tr.selected {
      background: #4f7a3b !important; /* æ¯”åŸæœ¬å†äº®ä¸€é» */
    }
    /* é¸åˆ°çš„åˆ—é–ƒä¸€ä¸‹ï¼ˆçµ¦å›è¦†å€åç¨±æŒ‰éˆ•ç”¨ï¼‰ */
    .row-flash {
      animation: rowFlash 0.8s ease-out;
    }
    @keyframes rowFlash {
      0%   { background-color: #7fbf4f; }
      100% { background-color: inherit; }
    }
    /* å·¦å´ Back æŒ‰éˆ•ï¼ˆç§»åˆ°è¡¨æ ¼åº•ä¸‹ï¼‰ */
    #back-button {
      margin-top: 6px;
      align-self: flex-start;
      padding: 4px 10px;
      border-radius: 14px;
      border: 1px solid #777;
      background: #3a3f44;
      color: #f5f5f5;
      font-size: 12px;
      cursor: pointer;
    }
    /* =====================================================
     * [CSS-3] å³å´ï¼šè¦–è¦ºå€æ¡†æ¶
     * ===================================================== */
    .visual-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }
    .visual-header {
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    /* æš«æ™‚éš±è—ï¼Œç”± JS æ§åˆ¶ */
    .current-point { display: none; } 
    .visual-body {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 260px;
    }
    .top-row {
      display: flex;
      gap: 8px;
      min-height: 170px;
    }
    /* å·¦ï¼šå½±ç‰‡ï¼éŒ„éŸ³æ ¼å­ */
    .video-frame-wrap {
      flex: 1 1 60%;
      background: #111315;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #555;
      position: relative;
      min-height: 150px;
    }
    .video-frame-wrap iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .video-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #999;
      text-align: center;
      padding: 8px;
    }
    /* =====================================================
     * [CSS-4] å³å´ï¼šå¤šå±¤åœ“
     * ===================================================== */
    .circle-area {
      flex: 1 1 40%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .circle-stack {
      position: relative;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      --ring-main-color: #5c7a5c;
      --ring-boundary-color: #9ad09a;
      --ring-highlight-color: #70ff70;
      --ring-outer-fog: rgba(112, 255, 112, 0.35);
      background: radial-gradient(circle at 20% 20%, #555, #111);
    }
    .ring {
      position: absolute;
      border-radius: 50%;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }
    .ring-main {
      border: 3px solid var(--ring-main-color);
      opacity: 0.8;
    }
    .ring-boundary {
      border: 1.2px solid var(--ring-boundary-color);
      opacity: 0.7;
    }
    .ring-b45 {
      border: 1px solid transparent;
      box-shadow: 0 0 16px var(--ring-outer-fog);
      opacity: 0.9;
    }
    .ring-b45 { inset: 4%;  } /* 4.5 */
    .ring-4   { inset: 10%; } /* 4   */
    .ring-b35 { inset: 20%; } /* 3.5 */
    .ring-3   { inset: 26%; } /* 3   */
    .ring-b25 { inset: 36%; } /* 2.5 */
    .ring-2   { inset: 42%; } /* 2   */
    .ring-b15 { inset: 52%; } /* 1.5 */
    .ring-1   { inset: 60%; } /* 1   */
    .ring.active {
      border-color: var(--ring-highlight-color);
      opacity: 1;
      box-shadow: 0 0 10px rgba(140, 255, 140, 0.9);
    }
    .layer-label {
      position: absolute;
      bottom: 6px;
      right: 8px;
      font-size: 11px;
      color: #cfe9cf;
      text-shadow: 0 0 3px #000;
    }
    /* æš«æ™‚éš±è—å±¤ç´šæ–‡å­— */
    .layer-label {
      display: none;
    }
    /* =====================================================
     * [CSS-5] å³å´ä¸‹åŠï¼šå›è¦†å€ + æŒ‡æ¿
     * ===================================================== */
    .bottom-row {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }
    /* å›è¦†å€å¯¬åº¦æ”¹æˆå’Œå½±ç‰‡åŒæ¨£æ¯”ä¾‹ï¼ˆç´„ 6:4ï¼‰ */
    .reply-area {
      flex: 1 1 60%;
    }
    .reply-area-header {
      font-size: 13px;
      margin: 0 0 4px;
    }
    .reply-target {
      font-size: 12px;
      margin-bottom: 4px;
      opacity: 0.85;
    }
    .reply-target-btn {
      padding: 3px 10px;
      border-radius: 14px;
      border: 1px solid #bbb;
      background: #f5f5f5;
      color: #222629;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }
    .reply-target-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    /* è¢«é …ç›®é€£å‹•æ™‚ï¼Œé¡è‰²è·Ÿ .selected row ä¸€è‡´ */
    .reply-target-btn.linked {
      background: #4f7a3b;
      border-color: #4f7a3b;
      color: #f5f5f5;
    }
    .reply-note {
      font-size: 11px;
      opacity: 0.75;
      margin-bottom: 4px;
    }
    #admin-reply {
      width: 100%;
      background: #1f2326;
      border: 1px solid #555;
      color: #f5f5f5;
      font-size: 12px;
      border-radius: 4px;
      min-height: 80px;
      resize: none;           /* å…ˆç”± JS æ§åˆ¶æ‹–æ‹‰ */
      overflow: hidden;       /* ç”± JS æ§åˆ¶æ˜¯å¦å‡ºç¾å·è»¸ */
      line-height: 1.4;
      padding: 4px 6px;
    }
    /* å›è¦†å€å‰ç¶´é–å®šæ¨£å¼ */
    .reply-prefix {
      color: #d1a343; /* é†’ç›®é¡è‰² */
      font-weight: bold;
      margin-right: 2px;
    }
    .fingerboard-row {
      flex: 1 1 40%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .fingerboard {
      position: relative;
      width: 120px;
      max-width: 140px;
      height: 260px;
      background: linear-gradient(180deg, #181a1d, #34383d);
      border-radius: 14px;
      overflow: hidden;
      border: 2px solid #676f78;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.55);
    }
    .fb-string {
      position: absolute;
      top: 6%;
      bottom: 6%;
      width: 2px;
      background: linear-gradient(180deg, #cfcfcf, #888);
      opacity: 0.9;
    }
    .fb-s1 { left: 20%; transform: skewX(-3deg); }
    .fb-s2 { left: 40%; transform: skewX(-1.5deg); }
    .fb-s3 { left: 62%; transform: skewX( 1.5deg); }
    .fb-s4 { left: 80%; transform: skewX( 3deg); }
    .fingerboard-note {
      position: absolute;
      font-size: 10px;
      color: #fdf5c5;
      opacity: 0.95;
      text-shadow: 0 0 2px #000;
      pointer-events: none;
    }
    /* =====================================================
     * [CSS-6] æ‰‹æ©Ÿç‰ˆ
     * ===================================================== */
    @media (max-width: 820px) {
      .page {
        padding: 0;         /* æ‰‹æ©Ÿç‰ˆæ»¿ç‰ˆ */
        max-width: 100%;
      }
      main.layout {
        flex-direction: column;
      }
      /* æ‰‹æ©Ÿç‰ˆï¼šé †åºæ”¹æˆ å³ï¼ˆå½±ç‰‡+å¤šå±¤åœ“+å›è¦†+æŒ‡æ¿ï¼‰åœ¨ä¸Šï¼Œå·¦ï¼ˆè¡¨æ ¼ï¼‰åœ¨ä¸‹ */
      #visual-panel {
        order: 1;
      }
      #comments-section {
        order: 2;
      }
      .panel-left,
      .panel-right {
        max-width: 100%;
        width: 100%;
        border-radius: 0;
      }
      .panel-right .visual-body {
        min-height: 420px;
      }
      /* æ‰‹æ©Ÿç‰ˆï¼šä¸Šå±¤åªè¦å½±ç‰‡ï¼Œå½±ç‰‡é«˜åº¦å›ºå®š */
      .top-row {
        flex-direction: column;
        min-height: 0;
      }
      .video-frame-wrap {
        width: 100%;
        height: 160px !important;
        min-height: 160px;
      }
      .circle-area {
        justify-content: center;
        margin-top: 6px;
      }
      .circle-stack {
        width: 160px;
        height: 160px;
      }
      .fingerboard {
        height: 220px;
      }
      /* æ‰‹æ©Ÿç‰ˆï¼šä¸­å±¤ å›è¦†å€ + æŒ‡æ¿ å·¦å³ä¸¦æ’ */
      .bottom-row {
        flex-direction: row;
      }
      .reply-area {
        flex: 1 1 60%;
      }
      .fingerboard-row {
        flex: 1 1 40%;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>StradTone Violin</h1>
      <h2>æç´è²å­¸å¯¦é©—å®¤</h2>
    </header>
    <main class="layout">
      <section class="panel panel-left" id="comments-section">
        <p class="hint">
          å°æç´
        </p>
        <div class="toolbar">
          <button type="button" id="btn-new">æ–°å¢</button>
        </div>
        <form id="community-form" class="hidden">
          <label>
            usernameï¼ˆ5â€“12 å­—å¿…å¡«,ä¿®æ”¹ç·¨è¼¯ç”¨ï¼‰ï¼š
            <input
              type="text"
              id="nickname-input"
              maxlength="12"
              placeholder="Mr,s 09â€¦."
            />
          </label>
          <label>
            é …ç›®ï¼ˆ100 å­—å…§ï¼‰ï¼š
            <input
              type="text"
              id="text-input"
              maxlength="100"
              placeholder="..."
            />
          </label>
          <div class="form-row-inline media-select-row">
            <button
              type="button"
              class="media-select-btn"
              id="btn-media-youtube"
              data-media="youtube"
            >
              YouTube
            </button>
            <button
              type="button"
              class="media-select-btn"
              id="btn-media-upload"
              data-media="upload"
            >
              å½±ç‰‡
            </button>
            <button
              type="button"
              class="media-select-btn"
              id="btn-media-audio"
              data-media="audio"
            >
              éŒ„éŸ³
            </button>
          </div>
          <div id="video-fields" class="hidden">
            <div class="form-row-inline" id="youtube-row" style="margin-top:4px;">
              <input
                type="text"
                id="youtube-url-input"
                placeholder="https://youtu.be/....(Link)â€¦"
              />
              <input
                type="text"
                id="start-input"
                placeholder="é–‹å§‹ mm:ss "
              />
              <input
                type="text"
                id="end-input"
                placeholder="çµæŸ mm:ss "
              />
            </div>
            <div class="form-row-inline" id="video-upload-row" style="margin-top:4px;">
              <input type="file" id="video-file-input" accept="video/*,image/*" />
              <span id="video-file-label" class="sub-hint"></span>
            </div>
          </div>
          <div id="audio-fields" class="hidden">
            <div class="media-record-toolbar" id="audio-record-toolbar">
              <button type="button" class="media-record-btn" id="audio-rec-start">â—</button>
              <button type="button" class="media-record-btn" id="audio-rec-stop" disabled>â– </button>
              <button type="button" class="media-record-btn" id="audio-rec-cancel" disabled>âœ•</button>
              <span class="media-record-status" id="audio-rec-status">éŒ„éŸ³é å‚™</span>
            </div>
            <div class="form-row-inline" id="audio-upload-row" style="margin-top:4px;">
              <input type="file" id="audio-file-input" accept="audio/*" />
              <span id="audio-file-label" class="sub-hint"></span>
            </div>
            <div class="form-row-inline" id="audio-preview-row" style="margin-top:4px;">
              <audio id="audio-rec-preview" class="rec-preview" controls></audio>
            </div>
          </div>
          <div class="form-row-inline">
            <button type="submit" id="submit-btn">ç™¼è¡¨</button>
          </div>
        </form>
        <div class="comments-wrapper">
          <table id="comments-table">
            <thead>
              <tr>
                <th class="col-edit"></th> <th class="col-nick">username</th>
                <th class="col-text">é …ç›®</th>
                <th class="col-media">åª’é«”/å›è¦†</th>
              </tr>
            </thead>
            <tbody id="comments-tbody">
              </tbody>
          </table>
        </div>
        <button id="back-button" type="button">Back</button>
      </section>
      <section class="panel panel-right" id="visual-panel">
        <div class="visual-wrapper">
          <div class="visual-header">
            <div class="current-point" id="current-info">
              å°šæœªé¸å–ç•™è¨€
            </div>
          </div>
          <div class="visual-body">
            <div class="top-row">
              <div class="video-frame-wrap">
<iframe
  id="video-iframe"
  src=""
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
  referrerpolicy="origin-when-cross-origin"
  allowfullscreen
></iframe>
                <div class="video-placeholder" id="video-placeholder">
                  è«‹é¸æ“‡ä¸€å‰‡é …ç›®æˆ–é»æ“Šæ’­æ”¾æŒ‰éˆ•
                </div>
              </div>
              <div class="circle-area">
                <div class="circle-stack" id="circle-stack">
                  <div class="ring ring-main ring-1" data-layer="1"></div>
                  <div class="ring ring-main ring-2" data-layer="2"></div>
                  <div class="ring ring-main ring-3" data-layer="3"></div>
                  <div class="ring ring-main ring-4" data-layer="4"></div>
                  <div
                    class="ring ring-boundary ring-b15"
                    data-layer="1.5"
                  ></div>
                  <div
                    class="ring ring-boundary ring-b25"
                    data-layer="2.5"
                  ></div>
                  <div
                    class="ring ring-boundary ring-b35"
                    data-layer="3.5"
                  ></div>
                  <div
                    class="ring ring-b45"
                    data-layer="4.5"
                  ></div>
                  <div class="layer-label" id="layer-label">
                    layers: â€“
                  </div>
                </div>
              </div>
            </div>
            <div class="bottom-row">
              <div class="reply-area">
                <div class="reply-target" id="reply-target">
                  <button
                    type="button"
                    id="reply-target-btn"
                    class="reply-target-btn"
                    disabled
                  >
                    From: â€”
                  </button>
                </div>
                <p class="reply-note">
                  </p>
                <textarea
                  id="admin-reply"
                  placeholder=""
                ></textarea>
              </div>
              <div class="fingerboard-row">
                <div class="fingerboard" id="fingerboard">
                  <div class="fb-string fb-s1"></div>
                  <div class="fb-string fb-s2"></div>
                  <div class="fb-string fb-s3"></div>
                  <div class="fb-string fb-s4"></div>
                  <div
                    class="fingerboard-note"
                    style="left:24%; top:8%;"
                  >
                    G0
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:24%; top:26%;"
                  >
                    G3
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:38%; top:18%;"
                  >
                    D5
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:38%; top:40%;"
                  >
                    D8
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:62%; top:22%;"
                  >
                    A7
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:62%; top:44%;"
                  >
                    A10
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:76%; top:30%;"
                  >
                    E9
                  </div>
                  <div
                    class="fingerboard-note"
                    style="left:76%; top:52%;"
                  >
                    E12
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>
<script>
// ====== [JS-0] å…¨åŸŸç‹€æ…‹ ======
const API_URL =
  "https://script.google.com/macros/s/AKfycbxn5aDCimtZmvgK4uEGr5fIyNItY2wZgQyO2LVEZkggFkO0VZ_YdDMyspGpzpkYy5W6-A/exec";
let commentsCache = [];
let currentSelectedId = null;
// æ–°å¢ / ç·¨è¼¯æ¬„æ˜¯å¦å±•é–‹
let isFormOpen = false;
// ç·¨è¼¯ç‹€æ…‹ï¼šæŒ‰ä¸‹ã€Œç·¨è¼¯ã€å¾Œæ‰æœƒå•Ÿå‹•
let editState = {
  active: false,
  id: null,
  nickname: "",
  originalText: "",
  // waitForSelect: false // ç§»é™¤ï¼Œæ”¹ç”¨æŒ‰éˆ•å•Ÿå‹•ç·¨è¼¯
};
// éŒ„éŸ³ / éŒ„å½± blobï¼ˆé ç•™ï¼‰
window.recordedAudioBlob = null;
window.recordedVideoBlob = null;
// å·¦å´ã€ŒéŒ„éŸ³ã€é¢æ¿ç”¨çš„éŒ„éŸ³æ§åˆ¶
let audioRecStream = null;
let audioRecRecorder = null;
let audioRecChunks = [];
let audioRecActive = false;
// å›è¦†å€å®šæ™‚å„²å­˜ Debounce
let saveReplyTimeout = null;
const REPLY_SAVE_DELAY = 1500; // 1.5 ç§’
const REPLY_PREFIX = "æç´è²å­¸å¯¦é©—å®¤ï¼š";

// ====== [JS-1] å°å·¥å…· ======
// é®è”½åç¨±
function maskName(name) {
  const s = String(name || "").trim(); // ç¢ºä¿æ˜¯å­—ä¸²
  if (!s) return "åŒ¿å";
  if (s.length <= 2) return s[0] + "*";
  const first = s[0];
  const last = s[s.length - 1];
  const middle = "*".repeat(s.length - 2);
  return first + middle + last;
}
// åç¨±éœ€ 5ï½12 å­— & ç¦æ­¢ç‰¹æ®Šç¬¦è™Ÿï¼ˆå…è¨±ç´”æ•¸å­—ã€è‹±æ–‡ã€ä¸­æ–‡å­—ï¼‰
function validateNameLength(name) {
  const s = String(name || "").trim();
  if (s.length < 5 || s.length > 12) return false;
  // æª¢æŸ¥æ˜¯å¦åªåŒ…å«ä¸­ã€è‹±ã€æ•¸å­—
  if (!/^[A-Za-z0-9\u4E00-\u9FFF]+$/.test(s)) return false;
  return true;
}
// æ™‚é–“å­—ä¸² â†’ ç§’æ•¸
function parseTimeToSec(str) {
  if (!str) return "";
  const s = String(str).trim();
  let m = s.match(/^(\d+):(\d{1,2})$/);
  if (m) {
    const min = Number(m[1]);
    const sec = Number(m[2]);
    if (!isNaN(min) && !isNaN(sec)) return min * 60 + sec;
  }
  m = s.match(/^(\d{3,4})$/);
  if (m) {
    const digits = m[1];
    const sec = Number(digits.slice(-2));
    const min = Number(digits.slice(0, -2));
    if (!isNaN(min) && !isNaN(sec)) return min * 60 + sec;
  }
  return "";
}
function escapeHtml(str) {
  return String(str || "").replace(/[&<>"']/g, (c) => {
    return (
      {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      }[c] || c
    );
  });
}
// YouTube ID
function extractYoutubeId(url) {
  if (!url) return "";
  const m1 = url.match(/youtu\.be\/([^?]+)/);
  if (m1) return m1[1];
  const m2 = url.match(/[?&]v=([^&]+)/);
  if (m2) return m2[1];
  return "";
}
// YouTube embed
function buildYoutubeEmbedUrl(url, startSec, endSec) {
  const id = extractYoutubeId(url);
  if (!id) return "";
  // ä½¿ç”¨éš±ç§åŠ å¼·çš„ youtube-nocookie ç¶²åŸŸ
  const base = "https://www.youtube-nocookie.com/embed/" + id;
  const params = [];
  
  // æ‰€æœ‰è£ç½®éƒ½å˜—è©¦è‡ªå‹•æ’­æ”¾
  params.push("autoplay=1"); 
  // --- é˜²è·³è½‰èˆ‡åŸºæœ¬åƒæ•¸ (æ‰€æœ‰è£ç½®é€šç”¨) ---
  // 1. é˜²è·³è½‰ (rel=0)ï¼šæ’­æ”¾çµæŸä¸é¡¯ç¤ºç›¸é—œå½±ç‰‡
  // 2. æ¸›å°‘æ¨™èªŒ (modestbranding=1)ï¼šç›¡å¯èƒ½éš±è— YouTube æ¨™èªŒï¼Œæ¸›å°‘é»æ“Šè·³è½‰é»
  // 3. Playsinline (playsinline=1)ï¼šå…è¨±åœ¨ iOS è¨­å‚™ä¸Šç¶²é å…§æ’­æ”¾
  params.push("rel=0", "modestbranding=1", "playsinline=1");
  // è¨­å®šé–‹å§‹èˆ‡çµæŸæ™‚é–“
  if (startSec !== "" && !isNaN(startSec)) {
    params.push("start=" + startSec);
  }
  if (endSec !== "" && !isNaN(endSec)) {
    params.push("end=" + endSec);
  }
  return params.length ? base + "?" + params.join("&") : base;
}
// Google Drive embed
function buildDriveEmbedUrl(fid) {
  return fid
    ? "https://drive.google.com/file/d/" + fid + "/preview"
    : "";
}
// å·è»¸å¾€å›ï¼ˆå½±ç‰‡ä¸Šæ–¹ï¼Œæ¡Œæ©Ÿ + æ‰‹æ©Ÿå…±ç”¨ï¼‰
function scrollToVideoTop() {
  const el = document.querySelector(".video-frame-wrap");
  if (el) {
    el.scrollIntoView({
      behavior: "smooth",
      block: "start",
    });
  }
}
// Base64
function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => {
      const result = r.result || "";
      const idx = String(result).indexOf(",");
      resolve(idx >= 0 ? result.slice(idx + 1) : result);
    };
    r.onerror = () => reject(r.error);
    r.readAsDataURL(file);
  });
}
// Debounce å‡½æ•¸
function debounce(func, delay) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), delay);
  };
}

// ====== [JS-2] è¼‰å…¥èˆ‡è¡¨æ ¼åˆ—è¡¨ ======
async function loadComments(selectIdAfterLoad = null) {
  const res = await fetch(API_URL + "?action=list", { cache: "no-cache" });
  const data = await res.json();
  commentsCache = data.posts || [];
  renderCommentsTable();
  if (selectIdAfterLoad) {
    const row = findRowById(selectIdAfterLoad);
    if (row) {
      selectRowForReply(row);
      // ç¢ºä¿è¡¨æ ¼æ²å‹•åˆ°è©²é …ç›®
      const tr = document.getElementById("comments-tbody")?.querySelector(`tr[data-id="${selectIdAfterLoad}"]`);
      if (tr) {
        tr.scrollIntoView({ behavior: "smooth", block: "center" });
      }
    }
  }
}
// ====== [JS-3] æ¸²æŸ“è¡¨æ ¼ ======
function renderCommentsTable() {
  const tbody = document.getElementById("comments-tbody");
  if (!tbody) return;
  if (!commentsCache.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center;">ç›®å‰å°šç„¡é …ç›®</td></tr>`;
    return;
  }
  const rows = commentsCache.slice().reverse();
  const html = rows
    .map((row) => {
      const nick = maskName(row.nickname);
      const full = String(row.text || "");
      const long = full.length > 30;
      const shortText = long
        ? escapeHtml(full.slice(0, 30)) + "..."
        : escapeHtml(full);
      const type = row.type || "text";
      const hasVideo = (type === "youtube" && row.youtubeUrl) || (type === "upload" && row.driveFileId);
      const hasAudio = type === "audio" && (row.hasAudio || row.driveAudioId);
      const hasReply = (row.reply && row.reply.trim().length > REPLY_PREFIX.length + 1); // æª¢æŸ¥æ˜¯å¦æœ‰å¯¦è³ªå›è¦†
      
      // åª’é«”é¡¯ç¤ºç¬¦è™Ÿ
      const icons = [];
      if (hasAudio) {
        icons.push(`<span class="media-flag" title="éŒ„éŸ³">ğŸµ</span>`);
      }
      if (hasVideo) {
        icons.push(`<span class="media-flag" title="å½±ç‰‡/åœ–ç‰‡">ğŸ¬</span>`);
      }
      if (hasReply) {
         icons.push(`<span class="media-flag" title="ç®¡ç†å“¡å›è¦†">ğŸ’¬</span>`);
      }
      let mediaHtml = icons.length ? `<div class="media-icons">${icons.join("")}</div>` : `<span style="opacity:.5">â€”</span>`;
      
      const selected =
        String(row.id) === String(currentSelectedId) ? ` class="selected"` : "";
      
      // ç·¨è¼¯æŒ‰éˆ•
      const editBtnHtml = `
        <button class="edit-row-btn" data-id="${row.id}" title="ç·¨è¼¯æ­¤é …ç›®">
          âœï¸
        </button>
      `;

      return `
        <tr data-id="${row.id}"${selected}>
          <td class="col-edit">${editBtnHtml}</td>
          <td class="col-nick">${escapeHtml(nick)}</td>
          <td class="col-text" data-long="${long ? "1" : "0"}">
            ${shortText}${long ? `<span class="expand-arrow">â–¼</span>` : ""}
          </td>
          <td class="col-media">${mediaHtml}</td>
        </tr>
      `;
    })
    .join("");
  tbody.innerHTML = html;
}
// ====== [JS-4] é¡¯ç¤ºå½±ç‰‡ã€éŸ³è¨Š ======
function clearVideo() {
  const iframe = document.getElementById("video-iframe");
  const ph = document.getElementById("video-placeholder");
  if (iframe) iframe.src = "";
  if (ph) ph.style.display = "flex";
}
function showVideoForRow(row) {
  if (!row) return;
  clearVideo();
  let url = "";
  const type = row.type || "text";
  if (type === "youtube" && row.youtubeUrl) {
    url = buildYoutubeEmbedUrl(row.youtubeUrl, row.startSec, row.endSec);
  } else if (type === "upload" && row.driveFileId) {
    url = buildDriveEmbedUrl(row.driveFileId);
  }
  
  const iframe = document.getElementById("video-iframe");
  const ph = document.getElementById("video-placeholder");
  if (url) {
    iframe.src = url;
    ph.style.display = "none";
  } else if (type === "audio" && (row.hasAudio || row.driveAudioId)) {
    // åªæœ‰éŸ³æª”ï¼Œé¡¯ç¤ºé ç•™æ–‡å­—
    ph.innerHTML = "æ­¤é …ç›®ç‚ºç´”éŸ³æª”ï¼Œè«‹ä½¿ç”¨æ‰‹æ©Ÿæˆ–é›»è…¦æ’­æ”¾ã€‚";
    ph.style.display = "flex";
  } else {
    ph.innerHTML = "æ­¤é …ç›®æ²’æœ‰å½±éŸ³å…§å®¹ï¼Œè«‹é¸æ“‡å…¶ä»–é …ç›®ã€‚";
    ph.style.display = "flex";
  }
}
// ====== [JS-5] å¤šå±¤åœ“ï¼ˆé ç•™ï¼‰ ======
function highlightLayers(layerStr) {
  const rings = document.querySelectorAll(".ring");
  rings.forEach((r) => r.classList.remove("active"));
  if (!layerStr) return;
  const parts = String(layerStr)
    .split(",")
    .map((s) => s.trim())
    .filter(Boolean);
  rings.forEach((r) => {
    const v = r.getAttribute("data-layer");
    if (parts.includes(v)) r.classList.add("active");
  });
}
// ====== [JS-6] æŸ¥æ‰¾ row ======
function findRowById(id) {
  return commentsCache.find((r) => String(r.id) === String(id));
}
// ====== [JS-7] å›è¦†å€å›ºå®šå‰ç¶´ ======
function updateAdminReplyDisplay() {
  const box = document.getElementById("admin-reply");
  if (!box) return;

  const raw = box.value || "";
  let content = raw;
  let prefixOffset = REPLY_PREFIX.length;

  if (!raw.startsWith(REPLY_PREFIX)) {
    // å¦‚æœå‰ç¶´ä¸è¦‹äº†ï¼Œå˜—è©¦åœ¨ä¸‹æ¬¡ focus æ™‚è£œä¸Š
    content = REPLY_PREFIX + "\n" + raw.replace(new RegExp("^" + REPLY_PREFIX + "\\s*"), "");
    box.value = content;
  } else {
     // ç¢ºä¿å‰ç¶´å¾Œè‡³å°‘æœ‰ä¸€å€‹æ›è¡Œç¬¦ï¼Œé¿å…è¼¸å…¥æ™‚è·‘é€²å‰ç¶´
     const prefixEndIndex = raw.indexOf('\n');
     if (prefixEndIndex === -1 || prefixEndIndex > REPLY_PREFIX.length) {
         content = REPLY_PREFIX + "\n" + raw.substring(REPLY_PREFIX.length).trimStart();
         box.value = content;
     }
  }

  // æ¸²æŸ“ç‚º HTMLï¼Œä¸¦æ›¿æ›ç‚ºæœ‰æ¨£å¼çš„ SPAN
  const htmlContent = escapeHtml(box.value).replace(
    REPLY_PREFIX + "\n",
    `<span class="reply-prefix">${REPLY_PREFIX}</span>\n`
  );
  // å› ç‚º textarea åªèƒ½é¡¯ç¤ºç´”æ–‡å­—ï¼Œæ‰€ä»¥é€™å€‹æ­¥é©Ÿå…¶å¯¦æ˜¯å¤šé¤˜çš„
  // æ ¸å¿ƒçš„é‚è¼¯æ˜¯ **æ§åˆ¶ `value`** ä¸¦åœ¨ `input` æ™‚é€²è¡Œæ ¡æ­£ã€‚

  // é–å®šå‰ç¶´å€åŸŸï¼šé˜»æ­¢æ¸¸æ¨™é€²å…¥
  box.addEventListener('keydown', (e) => {
      const start = box.selectionStart;
      const end = box.selectionEnd;
      if (start <= prefixOffset || end <= prefixOffset) {
          // ä¸å…è¨±æ¸¸æ¨™ç§»å‹•åˆ°å‰ç¶´ä¹‹å‰æˆ–ä¸­é–“
          if (e.key === 'ArrowLeft' && start <= prefixOffset) {
              box.selectionStart = box.selectionEnd = prefixOffset + 1; // è·³åˆ°ä¸‹ä¸€è¡Œ
              e.preventDefault();
          } else if (e.key === 'Backspace' && start <= prefixOffset + 1) {
              // ä¸å…è¨±åˆªé™¤å‰ç¶´
              box.selectionStart = box.selectionEnd = prefixOffset + 1;
              e.preventDefault();
          }
      }
  });

  autoResizeReply();
}

function autoResizeReply() {
  const box = document.getElementById("admin-reply");
  if (!box) return;
  let maxH = 260;
  const fb = document.getElementById("fingerboard");
  if (fb) {
    const rect = fb.getBoundingClientRect();
    if (rect.height > 0) maxH = rect.height;
  }
  box.style.height = "auto";
  const scrollH = box.scrollHeight;
  if (scrollH <= maxH) {
    box.style.height = scrollH + "px";
    box.style.overflowY = "hidden";
    box.style.resize = "none";
  } else {
    box.style.height = maxH + "px";
    box.style.overflowY = "auto";
    box.style.resize = "vertical";
  }
}

// ====== [JS-8] é¸å–é …ç›®ï¼ˆè‡ªå‹•å±•é–‹ + è‡ªå‹•æ’­æ”¾ + å›è¦†é€£å‹• + From: é¡è‰²åŒæ­¥ï¼‰ ======
function resetReplyTargetButton() {
  const btn = document.getElementById("reply-target-btn");
  if (!btn) return;
  btn.textContent = "From: â€”";
  btn.disabled = true;
  btn.removeAttribute("data-id");
  btn.classList.remove("linked");
}
function selectRowForReply(row) {
  if (!row) return;
  
  // è‹¥æ­£åœ¨ç·¨è¼¯/æ–°å¢ â†’ å–æ¶ˆè¡¨å–®
  if (isFormOpen) {
    resetFormToAddMode();
  }
  
  currentSelectedId = row.id;
  
  // é¸å–åˆ—é«˜äº®
  const tbody = document.getElementById("comments-tbody");
  if (tbody) {
    Array.from(tbody.querySelectorAll("tr")).forEach((tr) => {
      tr.classList.toggle(
        "selected",
        tr.getAttribute("data-id") === String(row.id)
      );
    });
  }
  
  // æ›´æ–° From: æ¨™ç±¤
  const btn = document.getElementById("reply-target-btn");
  if (btn) {
    btn.textContent = "From: " + maskName(row.nickname);
    btn.disabled = false;
    btn.setAttribute("data-id", String(row.id));
    // é¡è‰²åŒæ­¥é¸å–åˆ—
    btn.classList.add("linked");
  }
  
  // ç®¡ç†å“¡å›è¦†å€å¡«å…¥åŸæœ¬ reply
  const box = document.getElementById("admin-reply");
  if (box) {
    const raw = row.reply || "";
    if (raw.startsWith(REPLY_PREFIX)) {
      box.value = raw;
    } else {
      box.value = REPLY_PREFIX + "\n" + raw;
    }
    updateAdminReplyDisplay(); // åŸ·è¡Œå‰ç¶´é–å®šå’Œè‡ªé©æ‡‰èª¿æ•´
    // èšç„¦ä¸¦å°‡æ¸¸æ¨™ç§»åˆ°å…§å®¹é–‹å§‹
    box.focus();
    box.selectionStart = box.selectionEnd = REPLY_PREFIX.length + 1;
  }
  
  // å±•é–‹æ–‡å­—ï¼ˆè‹¥ >30 å­—ï¼‰
  expandTextForRow(row, true);
  
  // æ’­æ”¾å½±ç‰‡
  showVideoForRow(row);
  
  // æ²åˆ°å½±ç‰‡é ‚éƒ¨ï¼ˆé˜²è·³æ ¼ç‰ˆï¼‰
  scrollToVideoTop();
}

// å±•é–‹æˆ–æ”¶åˆæ–‡å­—
function expandTextForRow(row, expand) {
  const tbody = document.getElementById("comments-tbody");
  if (!tbody) return;
  const tr = tbody.querySelector(`tr[data-id="${row.id}"]`);
  if (!tr) return;
  const cell = tr.querySelector("td.col-text");
  if (!cell || String(row.text || "").length <= 30) return;
  
  const longText = escapeHtml(row.text);
  const shortText = escapeHtml(row.text.slice(0, 30)) + "...";
  
  if (expand) {
    cell.innerHTML = longText + `<span class="expand-arrow" title="æ”¶åˆ">â–²</span>`;
    cell.setAttribute("data-expanded", "1");
  } else {
    cell.innerHTML = shortText + `<span class="expand-arrow">â–¼</span>`;
    cell.setAttribute("data-expanded", "0");
  }
}


// ====== [JS-9] å„²å­˜å›è¦† (Debounced) ======
// å¯¦éš›çš„å„²å­˜å‡½æ•¸
async function saveAdminReplyActual() {
  const box = document.getElementById("admin-reply");
  if (!box || !currentSelectedId) return;
  
  // ç¢ºä¿å‰ç¶´åœ¨
  updateAdminReplyDisplay();
  const text = box.value.trim();
  
  // åªæœ‰ç•¶å…§å®¹é•·åº¦å¤§æ–¼å‰ç¶´æ™‚æ‰å„²å­˜ï¼Œé˜²æ­¢å­˜å…¥ç©ºå›è¦†
  if (text.length <= REPLY_PREFIX.length + 1 && text.startsWith(REPLY_PREFIX)) {
      // ç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹æ›è¡Œç¬¦
      box.value = REPLY_PREFIX + "\n";
      // å¯¦è³ªä¸Šæ˜¯æ¸…ç©ºå›è¦†
      try {
          const params = new URLSearchParams({
              action: "reply",
              id: String(currentSelectedId),
              reply: REPLY_PREFIX + "\n"
          });
          await fetch(API_URL + "?" + params.toString());
          const r = findRowById(currentSelectedId);
          if (r) r.reply = REPLY_PREFIX + "\n";
          // é‡æ–°è¼‰å…¥ä¸¦ä¿æŒé¸ä¸­ç‹€æ…‹ï¼Œç¢ºä¿å·¦å´åœ–ç¤ºæ›´æ–°
          loadComments(currentSelectedId); 
      } catch (err) {
          console.error("æ¸…ç©ºå›è¦†å¤±æ•—:", err);
      }
      return;
  }
  
  try {
    const params = new URLSearchParams({
      action: "reply",
      id: String(currentSelectedId),
      reply: text,
    });
    const res = await fetch(API_URL + "?" + params.toString());
    const data = await res.json();
    if (!data || data.status !== "ok") {
      throw new Error(data.error || "reply å¤±æ•—");
    }
    const r = findRowById(currentSelectedId);
    if (r) r.reply = text;
    // é‡æ–°è¼‰å…¥ä¸¦ä¿æŒé¸ä¸­ç‹€æ…‹ï¼Œç¢ºä¿å·¦å´åœ–ç¤ºæ›´æ–°
    loadComments(currentSelectedId); 
  } catch (err) {
    console.error("å„²å­˜å›è¦†å¤±æ•—:", err);
    // å¯è€ƒæ…®åœ¨ UI ä¸Šé¡¯ç¤ºå„²å­˜å¤±æ•—çš„æç¤º
  }
}

// Debounced ç‰ˆæœ¬
const saveAdminReply = debounce(saveAdminReplyActual, REPLY_SAVE_DELAY);


// ====== [JS-10] åª’é«”æ¨¡å¼åˆ‡æ›ï¼ˆYouTube / å½±ç‰‡ / éŒ„éŸ³ äº’æ–¥ï¼‰ ======
function clearRecordedMediaState() {
  window.recordedAudioBlob = null;
  window.recordedVideoBlob = null;
  const aStatus = document.getElementById("audio-rec-status");
  if (aStatus) aStatus.textContent = "éŒ„éŸ³é å‚™";
  const aPreview = document.getElementById("audio-rec-preview");
  if (aPreview) {
      aPreview.src = "";
      aPreview.removeAttribute("src");
  }
  // å¦‚æœæ­£åœ¨éŒ„éŸ³ï¼Œåœæ­¢å®ƒ
  stopAudioRecordingInternal(true);
}

function setMediaMode(mode) {
  window.currentMediaMode = mode || null;
  const btnYoutube = document.getElementById("btn-media-youtube");
  const btnUpload  = document.getElementById("btn-media-upload");
  const btnAudio   = document.getElementById("btn-media-audio");
  const videoFields    = document.getElementById("video-fields");
  const audioFields    = document.getElementById("audio-fields");
  const youtubeRow     = document.getElementById("youtube-row");
  const videoUploadRow = document.getElementById("video-upload-row");
  // æ¸…é™¤ active æ¨£å¼
  [btnYoutube, btnUpload, btnAudio].forEach((b) => {
    if (b) b.classList.remove("active");
  });
  if (videoFields) videoFields.classList.add("hidden");
  if (audioFields) audioFields.classList.add("hidden");
  if (youtubeRow) youtubeRow.style.display = "none";
  if (videoUploadRow) videoUploadRow.style.display = "none";
  if (!mode) return;
  if (mode === "youtube") {
    if (btnYoutube) btnYoutube.classList.add("active");
    if (videoFields) videoFields.classList.remove("hidden");
    if (youtubeRow) youtubeRow.style.display = "flex";
  } else if (mode === "upload") {
    if (btnUpload) btnUpload.classList.add("active");
    if (videoFields) videoFields.classList.remove("hidden");
    if (videoUploadRow) videoUploadRow.style.display = "flex";
  } else if (mode === "audio") {
    if (btnAudio) btnAudio.classList.add("active");
    if (audioFields) audioFields.classList.remove("hidden");
  }
}
// ====== [JS-A] å·¦å´è¡¨å–®ï¼šéŒ„éŸ³é¢æ¿æ§åˆ¶ï¼ˆä½¿ç”¨ MediaRecorderï¼‰ ======
function stopAudioRecordingInternal(cancelOnly) {
  const statusEl = document.getElementById("audio-rec-status");
  const previewEl = document.getElementById("audio-rec-preview");
  const btnStart = document.getElementById("audio-rec-start");
  const btnStop = document.getElementById("audio-rec-stop");
  const btnCancel = document.getElementById("audio-rec-cancel");
  // åœæ‰ recorder
  if (audioRecRecorder && audioRecRecorder.state !== "inactive") {
    try {
      audioRecRecorder.stop();
    } catch (e) {}
  }
  audioRecRecorder = null;
  // é—œæ‰éº¥å…‹é¢¨ stream
  if (audioRecStream) {
    audioRecStream.getTracks().forEach((t) => t.stop());
  }
  audioRecStream = null;
  audioRecActive = false;
  if (cancelOnly) {
    // å–æ¶ˆï¼šæ¸…é™¤é€™æ¬¡éŒ„éŸ³
    audioRecChunks = [];
    window.recordedAudioBlob = null;
    if (previewEl) {
      previewEl.src = "";
      previewEl.removeAttribute("src");
    }
    if (statusEl) statusEl.textContent = "éŒ„éŸ³é å‚™";
  } else {
    // æ­£å¸¸åœæ­¢ (ç”± recorder çš„ 'stop' event è™•ç†)
    return;
  }
  if (btnStart) btnStart.disabled = false;
  if (btnStop) btnStop.disabled = true;
  if (btnCancel) btnCancel.disabled = true; // å–æ¶ˆå¾Œï¼Œå¿…é ˆé‡æ–°éŒ„éŸ³
}

function setupAudioRecording() {
  const btnStart = document.getElementById("audio-rec-start");
  const btnStop = document.getElementById("audio-rec-stop");
  const btnCancel = document.getElementById("audio-rec-cancel");
  const statusEl = document.getElementById("audio-rec-status");
  const previewEl = document.getElementById("audio-rec-preview");
  if (!btnStart || !btnStop || !btnCancel || !statusEl || !previewEl) {
    return; // HTML æ²’è¼‰åˆ°å°±ç›´æ¥è·³é
  }
  // ä¸€é–‹å§‹ï¼šåªé–‹ã€Œé–‹å§‹éŒ„éŸ³ã€ï¼Œåœæ­¢/å–æ¶ˆç‹€æ…‹è·Ÿä½ åŸæœ¬è¨­å®šç‚ºä¸»
  btnStart.disabled = false;
  btnStart.addEventListener("click", async () => {
    if (audioRecActive) return;
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      statusEl.textContent = "æ­¤ç€è¦½å™¨ä¸æ”¯æ´éº¥å…‹é¢¨éŒ„éŸ³ã€‚";
      return;
    }
    try {
      btnStart.disabled = true;
      btnStop.disabled = true;
      btnCancel.disabled = true;
      statusEl.textContent = "æ­£åœ¨å•Ÿç”¨éº¥å…‹é¢¨â€¦";
      // æ¸…ç©ºé è¦½
      previewEl.src = "";
      previewEl.removeAttribute("src");
      
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioRecStream = stream;
      audioRecChunks = [];
      window.recordedAudioBlob = null;
      const mimeType =
        MediaRecorder.isTypeSupported &&
        MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
          ? "audio/webm;codecs=opus"
          : "audio/webm";
      const recorder = new MediaRecorder(stream, { mimeType });
      audioRecRecorder = recorder;
      audioRecActive = true;
      recorder.addEventListener("dataavailable", (ev) => {
        if (ev.data && ev.data.size > 0) {
          audioRecChunks.push(ev.data);
        }
      });
      recorder.addEventListener("stop", () => {
        // ç¢ºä¿ stream å·²ç¶“é—œé–‰
        if (audioRecStream) {
           audioRecStream.getTracks().forEach((t) => t.stop());
           audioRecStream = null;
        }
        
        // å¦‚æœæ˜¯å–æ¶ˆæ“ä½œï¼ŒChunksæœƒæ˜¯ç©ºçš„ï¼Œæ­¤æ™‚ä¸æ‡‰è©²å„²å­˜ blob
        if (!audioRecChunks.length) {
            statusEl.textContent = "éŒ„éŸ³å·²å–æ¶ˆã€‚";
            btnStart.disabled = false;
            btnStop.disabled = true;
            btnCancel.disabled = true;
            audioRecActive = false;
            return;
        }
        
        const blob = new Blob(audioRecChunks, { type: mimeType });
        window.recordedAudioBlob = blob;
        const url = URL.createObjectURL(blob);
        previewEl.src = url;
        previewEl.play().catch(() => {});
        statusEl.textContent = `éŒ„éŸ³å®Œæˆ (${(blob.size / 1024).toFixed(1)} KB)ï¼Œå¯æŒ‰ã€Œç™¼è¡¨ã€å„²å­˜ã€‚`;
        btnStart.disabled = false;
        btnStop.disabled = true;
        btnCancel.disabled = false;
        audioRecActive = false;
      });
      recorder.start();
      statusEl.textContent = "éŒ„éŸ³ä¸­â€¦ å†æŒ‰ã€Œâ– ã€åœæ­¢ã€‚";
      btnStop.disabled = false;
      btnCancel.disabled = false;
    } catch (err) {
      console.error(err);
      statusEl.textContent = "ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨ï¼ˆå¯èƒ½è¢«æ‹’çµ•æˆ–è£ç½®ä¸æ”¯æ´ï¼‰ã€‚";
      btnStart.disabled = false;
      btnStop.disabled = true;
      btnCancel.disabled = true;
    }
  });
  btnStop.addEventListener("click", () => {
    if (!audioRecActive || !audioRecRecorder) return;
    // æ­£å¸¸çµæŸéŒ„éŸ³ï¼šè®“ recorder çš„ onstop æŠŠ blob å­˜åˆ° recordedAudioBlob
    audioRecRecorder.stop();
    // stream åœ¨ onstop è£¡é—œæ‰
    statusEl.textContent = "è™•ç†éŒ„éŸ³ä¸­â€¦";
    btnStop.disabled = true;
  });
  btnCancel.addEventListener("click", () => {
    // å–æ¶ˆï¼šå…¨éƒ¨æ¸…æ‰ï¼Œä¸å­˜ blob
    stopAudioRecordingInternal(true);
  });
}

// ====== [JS-11] å¾ã€Œæ–°å¢/ç·¨è¼¯ã€å¾©åŸæˆåˆå§‹ç‹€æ…‹ ======
function resetFormToAddMode() {
  const form       = document.getElementById("community-form");
  const btnNew     = document.getElementById("btn-new");
  const nickEl     = document.getElementById("nickname-input");
  const textEl     = document.getElementById("text-input");
  const ytEl       = document.getElementById("youtube-url-input");
  const startEl    = document.getElementById("start-input");
  const endEl      = document.getElementById("end-input");
  const videoFile  = document.getElementById("video-file-input");
  const videoLabel = document.getElementById("video-file-label");
  const audioFile  = document.getElementById("audio-file-input");
  const audioLabel = document.getElementById("audio-file-label");
  
  // æ¸…ç©ºæ¬„ä½
  if (nickEl) {
    nickEl.value = "";
    nickEl.placeholder = "Mr,s 09â€¦.";
    nickEl.disabled = false;
  }
  if (textEl) {
    textEl.value = "";
    textEl.disabled = false;
    textEl.style.opacity = "1";
  }
  if (ytEl) {
    ytEl.value = "";
  }
  if (startEl) startEl.value = "";
  if (endEl)   endEl.value   = "";
  if (videoFile) {
    videoFile.disabled = false;
    videoFile.value = "";
  }
  if (videoLabel) videoLabel.textContent = "";
  if (audioFile) {
    audioFile.disabled = false;
    audioFile.value = "";
  }
  if (audioLabel) audioLabel.textContent = "";
  
  setMediaMode(null);
  clearRecordedMediaState();
  
  if (form) {
    form.classList.add("hidden");
    form.style.display = "none";
  }
  if (btnNew) {
    btnNew.textContent = "æ–°å¢";
  }
  isFormOpen = false;
  editState.active = false;
  editState.id = null;
  editState.nickname = "";
  editState.originalText = "";
  // ä¸éœ€è¦ resetReplyTargetButton()ï¼Œå› ç‚ºå–æ¶ˆç·¨è¼¯/æ–°å¢ä¸æ‡‰è©²å½±éŸ¿ç•¶å‰é¸ä¸­çš„é€£å‹•

  // ç¢ºä¿ã€Œæ–°å¢ã€æŒ‰éˆ•æ–‡å­—é‡ç½®
  if (btnNew) btnNew.textContent = "æ–°å¢";
}

// ====== [JS-12] ç·¨è¼¯æµç¨‹ï¼šç›´æ¥é»æ“ŠæŒ‰éˆ•é€²å…¥ç·¨è¼¯ ======
function startEditForRow(row) {
  if (!row) return;

  // å¦‚æœç›®å‰æ˜¯é–‹å•Ÿç‹€æ…‹ï¼Œå…ˆé‡ç½®
  if (isFormOpen) {
    resetFormToAddMode();
  }

  // ç«‹å³é¸å–è©²åˆ—ï¼Œé€£å‹•å³å´è³‡è¨Š
  selectRowForReply(row);

  editState.active       = true;
  editState.id           = row.id;
  editState.nickname     = String(row.nickname || "").trim();
  editState.originalText = row.text || "";
  
  const form   = document.getElementById("community-form");
  const btnNew = document.getElementById("btn-new");
  const nickEl = document.getElementById("nickname-input");
  const textEl = document.getElementById("text-input");

  if (form) {
    form.classList.remove("hidden");
    form.style.display = "block";
  }
  if (btnNew) {
    btnNew.textContent = "å–æ¶ˆç·¨è¼¯";
  }
  isFormOpen = true;

  // æ¸…ç©º username â†’ è®“ç”¨æˆ¶è¼¸å…¥åŸæœ¬å§“å
  if (nickEl) {
    nickEl.disabled = false;
    nickEl.value = "";
    nickEl.placeholder = "è«‹è¼¸å…¥åŸæœ¬ username ä»¥é€²è¡Œç·¨è¼¯";
  }
  
  // èªªæ˜æ¬„å…ˆé–ä½ï¼Œåªé¡¯ç¤ºåŸæœ¬çš„å…§å®¹
  if (textEl) {
    textEl.value = editState.originalText;
    textEl.disabled = true;
    textEl.style.opacity = "0.6";
  }

  // ç·¨è¼¯æ™‚ä¸å…è¨±è®Šå‹•åª’é«”ï¼Œä¸¦æ¸…é™¤æ‰€æœ‰åª’é«”è¼¸å…¥æ¬„
  setMediaMode(null);
  const ytEl  = document.getElementById("youtube-url-input");
  const startEl = document.getElementById("start-input");
  const endEl = document.getElementById("end-input");
  const videoFile  = document.getElementById("video-file-input");
  const videoLabel = document.getElementById("video-file-label");
  const audioFile  = document.getElementById("audio-file-input");
  const audioLabel = document.getElementById("audio-file-label");
  if (ytEl) ytEl.value = "";
  if (startEl) startEl.value = "";
  if (endEl) endEl.value = "";
  if (videoFile) videoFile.value = "";
  if (videoLabel) videoLabel.textContent = "";
  if (audioFile) audioFile.value = "";
  if (audioLabel) audioLabel.textContent = "";

  // æ²åˆ°è¡¨å–®é ‚éƒ¨
  form.scrollIntoView({ behavior: "smooth", block: "start" });
}

// åç¨±é©—è­‰é€šé â†’ è§£é–èªªæ˜æ¬„ä½
function tryUnlockEditByName() {
  if (!editState.active) return;
  if (isComposingName) return;
  const nickEl = document.getElementById("nickname-input");
  const textEl = document.getElementById("text-input");
  if (!nickEl || !textEl) return;
  
  const typed  = String(nickEl.value || "").trim();
  const target = String(editState.nickname || "").trim();
  
  if (!typed || !target) return;

  // å…ˆåšæ ¼å¼é©—è­‰ï¼ˆ5â€“12ã€ä¸­è‹±æ–‡/æ•¸å­—ï¼‰
  if (!validateNameLength(typed)) {
    return;
  }
  // å¿…é ˆã€Œå®Œå…¨ä¸€æ¨£ã€æ‰è§£é–ï¼ˆç´”æ•¸å­—ä¹Ÿå¯ä»¥ï¼‰
  // æ³¨æ„ï¼šé€™è£¡å¿…é ˆä½¿ç”¨ String() ç¢ºä¿ä¸æœƒå› ç‚º 0 é–‹é ­è¢«ç•¶æˆæ•¸å€¼è€Œå°è‡´é©—è­‰å¤±æ•—
  if (String(typed) !== String(target)) return;
  
  // é€šéï¼šé–ä½ usernameï¼Œè§£é–é …ç›®æ¬„
  nickEl.disabled = true;
  textEl.disabled = false;
  textEl.style.opacity = "1";
  textEl.focus();
  const len = textEl.value.length;
  try {
    textEl.setSelectionRange(len, len);
  } catch (e) {}
}

// ====== [JS-13] è¡¨æ ¼é»æ“Šï¼šé¸å– / é€²å…¥ç·¨è¼¯ ======
function setupTableClicks() {
  const tbody = document.getElementById("comments-tbody");
  if (!tbody) return;
  tbody.addEventListener("click", (e) => {
    
    // 1. é»æ“Šç·¨è¼¯æŒ‰éˆ•
    const editBtn = e.target.closest("button.edit-row-btn");
    if (editBtn) {
        const id = editBtn.getAttribute("data-id");
        const row = findRowById(id);
        if (row) {
            startEditForRow(row);
        }
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ° TR
        return;
    }

    // 2. é»æ“Šå±•é–‹ç®­é ­ (æ”¶åˆ/å±•é–‹æ–‡å­—)
    const expandArrow = e.target.closest(".expand-arrow");
    if (expandArrow) {
      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;
      const id = tr.getAttribute("data-id");
      const row = findRowById(id);
      if (!row) return;

      const cell = tr.querySelector("td.col-text");
      const isExpanded = cell.getAttribute("data-expanded") === "1";
      expandTextForRow(row, !isExpanded);
      e.stopPropagation();
      return;
    }

    // 3. é»æ“Š TR åˆ—ï¼ˆé¸å–é …ç›®ï¼‰
    const tr = e.target.closest("tr[data-id]");
    if (!tr) return;
    const id = tr.getAttribute("data-id");
    const row = findRowById(id);
    if (!row) return;

    // å¦‚æœç›®å‰æœ‰è¡¨å–®é–‹å•Ÿ (æ–°å¢æˆ–ç·¨è¼¯)ï¼Œå…ˆå–æ¶ˆä¸¦æ”¶å›
    if (isFormOpen) {
        resetFormToAddMode();
    }
    
    // é¸å–é …ç›®ä¸¦é€£å‹•å³å´
    selectRowForReply(row);
  });
}
// ====== [JS-14] Back éµï¼šå›åˆ°å½±ç‰‡é ‚ç«¯ ======
function setupBackButton() {
  const btn = document.getElementById("back-button");
  if (!btn) return;
  btn.addEventListener("click", () => {
    scrollToVideoTop();
  });
}
// ====== [JS-15] ç®¡ç†å“¡å›è¦†å€ ======
function setupAdminReply() {
  const box = document.getElementById("admin-reply");
  if (!box) return;
  
  // åˆå§‹åŒ–å›è¦†å€
  if (!box.value) {
    box.value = REPLY_PREFIX + "\n";
  }
  updateAdminReplyDisplay();
  
  // ç¶å®šè¼¸å…¥äº‹ä»¶ï¼šè‡ªå‹•èª¿æ•´å¤§å°å’Œå®šæ™‚å„²å­˜
  box.addEventListener("input", () => {
    updateAdminReplyDisplay(); // ç¢ºä¿å‰ç¶´å’Œå¤§å°èª¿æ•´
    saveAdminReply(); // Debounced å„²å­˜
  });
  
  // èšç„¦æ™‚ï¼Œç¢ºä¿æ¸¸æ¨™åœ¨æ­£ç¢ºä½ç½®
  box.addEventListener("focus", () => {
    const prefixOffset = REPLY_PREFIX.length + 1;
    if (box.selectionStart < prefixOffset) {
        box.selectionStart = box.selectionEnd = prefixOffset;
    }
  });

  // å¤±å»ç„¦é»æ™‚ï¼Œç«‹å³å„²å­˜
  box.addEventListener("blur", () => {
     // ç«‹å³è§¸ç™¼ä¸€æ¬¡å„²å­˜ï¼Œä¸ç®¡ debounce
     if (saveReplyTimeout) {
        clearTimeout(saveReplyTimeout);
     }
     saveAdminReplyActual();
  });
}
// ====== [JS-16] From: æŒ‰éˆ• â†’ å›åˆ°è©²åˆ—ä¸¦å±•é–‹æ–‡å­— ======
function setupReplyTargetButton() {
  const btn = document.getElementById("reply-target-btn");
  if (!btn) return;
  btn.addEventListener("click", () => {
    const id = btn.getAttribute("data-id");
    if (!id) return;
    const tbody = document.getElementById("comments-tbody");
    if (!tbody) return;
    const tr = tbody.querySelector(`tr[data-id="${id}"]`);
    if (!tr) return;
    const row = findRowById(id);
    if (!row) return;
    
    tr.scrollIntoView({ behavior: "smooth", block: "center" });
    tr.classList.add("row-flash");
    setTimeout(() => tr.classList.remove("row-flash"), 800);
    
    // è‡ªå‹•å±•é–‹æ–‡å­—
    expandTextForRow(row, true);
  });
}
// ====== [JS-17] username æ³¨éŸ³ä¿è­· + Enter é˜²é€å‡º ======
let isComposingName = false;
function setupEditNameGuard() {
  const nickEl = document.getElementById("nickname-input");
  if (!nickEl) return;
  nickEl.addEventListener("compositionstart", () => {
    isComposingName = true;
  });
  nickEl.addEventListener("compositionend", () => {
    isComposingName = false;
    tryUnlockEditByName();
  });
  nickEl.addEventListener("input",  tryUnlockEditByName);
  nickEl.addEventListener("change", tryUnlockEditByName);
  nickEl.addEventListener("blur",   tryUnlockEditByName);
  // Enter ä¸é€å‡ºï¼Œåªå˜—è©¦è§£é–
  nickEl.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter") {
      ev.preventDefault();
      tryUnlockEditByName();
    }
  });
}
// é …ç›®æ¬„ä½ Enter å®Œå…¨ç¦æ­¢é€å‡º
function setupTextInputEnterGuard() {
  const textEl = document.getElementById("text-input");
  if (!textEl) return;
  textEl.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter") {
      ev.preventDefault();
    }
  });
}
// ====== [JS-18] å·¥å…·åˆ— / è¡¨å–® + é€å‡ºè™•ç† ======
async function handleSubmit(e) {
  e.preventDefault();
  const nickEl    = document.getElementById("nickname-input");
  const textEl    = document.getElementById("text-input");
  const ytEl      = document.getElementById("youtube-url-input");
  const startEl   = document.getElementById("start-input");
  const endEl     = document.getElementById("end-input");
  const videoFile = document.getElementById("video-file-input");
  const audioFile = document.getElementById("audio-file-input");
  
  // ç¢ºä¿ nickname æ˜¯å­—ä¸²
  const nickname  = String((nickEl?.value || "")).trim(); 
  const text      = (textEl?.value || "").trim();
  const youtubeUrl= (ytEl?.value || "").trim();
  const startSec  = parseTimeToSec(startEl?.value);
  const endSec    = parseTimeToSec(endEl?.value);
  const vFile     = videoFile && videoFile.files[0];
  const aFile     = audioFile && audioFile.files[0];
  const isEditing = editState.active && editState.id;
  
  // username é©—è­‰
  if (!validateNameLength(nickname)) {
    alert("username è«‹ä½¿ç”¨ 5â€“12 å€‹ä¸­è‹±æ–‡æˆ–æ•¸å­—ï¼ˆä¸å«ç©ºç™½èˆ‡ç¬¦è™Ÿï¼‰ã€‚");
    if (nickEl) nickEl.focus();
    return;
  }
  
  if (isEditing) {
    // ç·¨è¼¯æ¨¡å¼é©—è­‰åŸå§‹åç¨±
    const target = String(editState.nickname || "").trim();
    if (nickname !== target) {
      alert("è«‹è¼¸å…¥ç•¶åˆå¡«å¯«çš„ usernameï¼ˆéœ€èˆ‡åŸå§‹ç´€éŒ„å®Œå…¨ä¸€è‡´ï¼‰ã€‚");
      if (nickEl) nickEl.focus();
      return;
    }
    // ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œå¦‚æœ text æ²’æœ‰è®Šæ›´ï¼Œä¸é€å‡º
    if (text === editState.originalText) {
       alert("é …ç›®å…§å®¹æœªä¿®æ”¹ã€‚");
       return;
    }
  }
  
  if (!text) {
    alert("è«‹å…ˆè¼¸å…¥ã€Œé …ç›®ã€èªªæ˜ï¼ˆ100 å­—å…§ï¼‰ã€‚");
    if (textEl) textEl.focus();
    return;
  }
  if (text.length > 100) {
    alert("èªªæ˜è«‹æ§åˆ¶åœ¨ 100 å­—ä»¥å…§ã€‚");
    if (textEl) textEl.focus();
    return;
  }
  
  // åª’é«”äº’æ–¥ï¼šæ–°å¢æ¨¡å¼ä¸‹æ‰æª¢æŸ¥
  if (!isEditing) {
    if (youtubeUrl) {
      if (vFile || aFile || window.recordedAudioBlob) {
        alert("YouTube é€£çµä¸å¯åŒæ™‚æ­é…å½±ç‰‡æª” / éŒ„éŸ³ï¼Œè«‹æ“‡ä¸€ç¨®åª’é«”ä¾†æºã€‚");
        return;
      }
    }
    if (aFile && window.recordedAudioBlob) {
      alert("éŸ³æª”ä¸Šå‚³èˆ‡éŒ„éŸ³è«‹æ“‡ä¸€ã€‚");
      return;
    }
  }
  
  try {
    // ===== ç·¨è¼¯æ¨¡å¼ï¼šåªæ”¹æ–‡å­— =====
    if (isEditing) {
      const params = new URLSearchParams({
        action: "edit",
        id: String(editState.id),
        text
      });
      const res  = await fetch(API_URL + "?" + params.toString());
      const data = await res.json();
      if (!data || data.status !== "ok") {
        throw new Error(data && data.error ? data.error : "edit å¤±æ•—");
      }
      
      const updatedId = editState.id;
      resetFormToAddMode();
      // è¼‰å…¥ä¸¦å¼·åˆ¶é¸å–å·²ç·¨è¼¯çš„é …ç›®
      await loadComments(updatedId);
      return;
    }
    
    // ===== æ–°å¢æ¨¡å¼ =====
    let type = "text";
    const payload = {
      action: "add",
      nickname,
      text,
      startSec: (startSec === "" ? "" : String(startSec)),
      endSec:   (endSec   === "" ? "" : String(endSec))
    };
    
    if (youtubeUrl) {
      type = "youtube";
      payload.type = type;
      payload.youtubeUrl = youtubeUrl;
    } else if (vFile) {
      // å½±ç‰‡ / åœ–ç‰‡ä¸Šå‚³ â†’ ä¸€å¾‹ç•¶æˆ upload
      type = "upload";
      payload.type = type;
      const base64   = await readFileAsBase64(vFile);
      const mimeType = vFile.type || "application/octet-stream";
      const fileName = vFile.name || ("video_" + Date.now());
      payload.videoBase64 = base64;
      payload.mimeType = mimeType;
      payload.fileName = fileName;
    } else if (aFile || window.recordedAudioBlob) {
      // éŒ„éŸ³ï¼ˆä¸Šå‚³éŸ³æª” or ç›´æ¥éŒ„éŸ³ï¼‰
      type = "audio";
      payload.type = type;
      let blobToUse = null;
      let mimeType  = "audio/webm";
      let fileName  = "audio_" + Date.now() + ".webm";
      
      if (aFile) {
        blobToUse = aFile;
        mimeType  = aFile.type || mimeType;
        fileName  = aFile.name || fileName;
      } else if (window.recordedAudioBlob) {
        blobToUse = window.recordedAudioBlob;
        mimeType  = window.recordedAudioBlob.type || mimeType;
      }
      
      if (blobToUse) {
        const base64 = await readFileAsBase64(blobToUse);
        payload.audioBase64    = base64;
        payload.audioMimeType  = mimeType;
        payload.audioFileName  = fileName;
      }
    } else {
      payload.type = "text";
    }
    
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload),
    });
    
    let data;
    try {
      data = await res.json();
    } catch (err) {
      throw new Error("ç„¡æ³•è§£æä¼ºæœå™¨å›æ‡‰ï¼ˆå¯èƒ½æ˜¯æ¬Šé™æˆ– CORS å•é¡Œï¼‰");
    }
    
    if (!data || data.status !== "ok" || !data.id) {
      throw new Error(data && data.error ? data.error : "add å¤±æ•—");
    }
    
    const newId = data.id; // å–å¾—æ–° ID
    resetFormToAddMode();
    // è¼‰å…¥ä¸¦å¼·åˆ¶é¸å–æ–°å¢çš„é …ç›®
    await loadComments(newId);
  } catch (err) {
    console.error(err);
    alert((isEditing ? "å„²å­˜æ–‡å­—ä¿®æ”¹å¤±æ•—ï¼š" : "é€å‡ºç•™è¨€å¤±æ•—ï¼š") + err.message);
  }
}

function bindToolbarAndForm() {
  const form          = document.getElementById("community-form");
  const btnNew        = document.getElementById("btn-new");
  const btnYoutube    = document.getElementById("btn-media-youtube");
  const btnUpload     = document.getElementById("btn-media-upload");
  const btnAudio      = document.getElementById("btn-media-audio");
  const videoFile     = document.getElementById("video-file-input");
  const videoLabel    = document.getElementById("video-file-label");
  const audioFile     = document.getElementById("audio-file-input");
  const audioLabel    = document.getElementById("audio-file-label");
  const ytEl          = document.getElementById("youtube-url-input");
  const startEl       = document.getElementById("start-input");
  const endEl         = document.getElementById("end-input");

  if (!form) return;
  form.classList.add("hidden");
  form.style.display = "none";
  setMediaMode(null);
  isFormOpen = false;
  
  // æ–°å¢ / å–æ¶ˆ
  if (btnNew) {
    btnNew.addEventListener("click", () => {
      if (!isFormOpen) {
        // é–‹å•Ÿã€Œæ–°å¢ã€æ¨¡å¼
        resetFormToAddMode(); // ç¢ºä¿é€²å…¥æ–°å¢å‰ç‹€æ…‹æ˜¯ä¹¾æ·¨çš„
        editState.active = false; // æ˜ç¢ºè¨­ç½®ç‚ºæ–°å¢æ¨¡å¼
        form.classList.remove("hidden");
        form.style.display = "block";
        btnNew.textContent = "å–æ¶ˆæ–°å¢"; // æ”¹è®ŠæŒ‰éˆ•æ–‡å­—
        isFormOpen = true;
        setMediaMode(null);
        clearRecordedMediaState();
      } else {
        // å–æ¶ˆï¼ˆæ–°å¢æˆ–ç·¨è¼¯ï¼‰
        resetFormToAddMode();
      }
    });
  }
  
  // ä¸‰é¡†åª’é«”æŒ‰éˆ•ï¼šåˆ‡æ›æ¨¡å¼ï¼ˆé»åŒä¸€é¡† â†’ é—œé–‰ï¼‰
  function bindMediaButton(btn, modeName) {
    if (!btn) return;
    btn.addEventListener("click", () => {
      if (editState.active) return; // ç·¨è¼¯æ¨¡å¼ä¸å…è¨±æ”¹åª’é«”
      if (btn.disabled) return;
      
      const isCurrentMode = window.currentMediaMode === modeName;
      
      // æ¸…ç©ºæ‰€æœ‰åª’é«”ç›¸é—œçš„è¼¸å…¥
      if (ytEl)     ytEl.value = "";
      if (startEl)  startEl.value = "";
      if (endEl)    endEl.value = "";
      if (videoFile)  videoFile.value = "";
      if (videoLabel) videoLabel.textContent = "";
      if (audioFile)  audioFile.value = "";
      if (audioLabel) audioLabel.textContent = "";
      clearRecordedMediaState();
      
      if (isCurrentMode) {
        setMediaMode(null);
      } else {
        setMediaMode(modeName);
      }
    });
  }
  
  bindMediaButton(btnYoutube, "youtube");
  bindMediaButton(btnUpload,  "upload");
  bindMediaButton(btnAudio,   "audio");
  
  // æª”æ¡ˆ change â†’ é¡¯ç¤ºæª”å
  if (videoFile && videoLabel) {
    videoFile.addEventListener("change", () => {
      if (videoFile.files && videoFile.files[0]) {
        videoLabel.textContent = "å·²é¸æ“‡ï¼š" + videoFile.files[0].name;
      } else {
        videoLabel.textContent = "";
      }
    });
  }
  if (audioFile && audioLabel) {
    audioFile.addEventListener("change", () => {
      if (audioFile.files && audioFile.files[0]) {
        audioLabel.textContent = "å·²é¸æ“‡ï¼š" + audioFile.files[0].name;
      } else {
        audioLabel.textContent = "";
      }
    });
  }
  form.addEventListener("submit", handleSubmit);
}
// ====== [JS-19] DOMContentLoadedï¼šå…¨éƒ¨å•Ÿå‹• ======
document.addEventListener("DOMContentLoaded", () => {
  // å…¨åŸŸåª’é«”ç‹€æ…‹
  window.currentMediaMode = null;
  // å·¥å…·åˆ— / è¡¨å–®
  bindToolbarAndForm();
  // è¡¨æ ¼é»æ“Š
  setupTableClicks();
  // Back éµ
  setupBackButton();
  // ç®¡ç†å“¡å›è¦†å€
  setupAdminReply();
  // é ‚éƒ¨ã€Œç·¨è¼¯ã€æŒ‰éˆ• (å·²ç§»é™¤)
  // From: æŒ‰éˆ•
  setupReplyTargetButton();
 // å·¦å´éŒ„éŸ³é¢æ¿
  setupAudioRecording();
  // username æ³¨éŸ³çµ„å­—ä¿è­· + Enter é˜²é€å‡º
  setupEditNameGuard();
  // é …ç›®æ¬„ä½ Enter é˜²èª¤é€å‡º
  setupTextInputEnterGuard();
  // ä¸€é–‹å§‹æ¸…ç©ºå½±ç‰‡
  clearVideo();
  // è¼‰å…¥ç•™è¨€åˆ—è¡¨
  loadComments().catch((err) => {
    console.error(err);
    alert("è¼‰å…¥åˆ—è¡¨å¤±æ•—ï¼š" + err.message);
  });
});
</script>
</body>
</html>


