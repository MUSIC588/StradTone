<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Violin 1st Position Trainer</title>
    <style>
        body {
            margin: 0;
            background: #2c1e14;
            display: flex;
            justify-content: center;
            font-family: sans-serif;
            touch-action: none; /* 防止縮放與捲動 */
        }

        /* 指板容器：確保物理尺寸 */
        #fingerboard {
            width: 60mm; /* 四條弦的寬度 */
            height: 150mm; /* 容納第一把位 */
            background: #1a1a1a;
            position: relative;
            border-top: 5mm solid #444; /* 弦枕 Nut */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .string {
            width: 1px;
            height: 100%;
            background: linear-gradient(to bottom, #ddd, #888);
            position: absolute;
            top: 0;
        }

        /* 弦的位置由右至左：E, A, D, G */
        #string-e { right: 10mm; }
        #string-a { right: 25mm; }
        #string-d { right: 40mm; }
        #string-g { right: 55mm; }

        /* 觸控偵測點 */
        .note-marker {
            position: absolute;
            width: 8mm;
            height: 4mm;
            border-radius: 50%;
            transform: translate(50%, -50%);
            border: 1px dashed rgba(255,255,255,0.3);
            pointer-events: none;
        }

        #feedback {
            position: fixed;
            top: 20px;
            color: white;
            text-align: center;
            width: 100%;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

<div id="feedback">請點擊指板開始練習</div>
<div id="fingerboard">
    <div class="string" id="string-g"></div>
    <div class="string" id="string-d"></div>
    <div class="string" id="string-a"></div>
    <div class="string" id="string-e"></div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const feedback = document.getElementById('feedback');
    const fingerboard = document.getElementById('fingerboard');

    // 4/4 小提琴物理參數 (mm)
    const L = 328; 
    const strings = {
        'E': { x: 10, baseFreq: 659.25 },
        'A': { x: 25, baseFreq: 440.00 },
        'D': { x: 40, baseFreq: 293.66 },
        'G': { x: 55, baseFreq: 196.00 }
    };

    // 計算半音位置 (從弦枕往下的 mm)
    function getDist(n) {
        return L * (1 - Math.pow(0.5, n / 12));
    }

    // 初始化檢測：當使用者觸碰
    fingerboard.addEventListener('touchstart', handleTouch);

    function handleTouch(e) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        const touch = e.touches[0];
        const rect = fingerboard.getBoundingClientRect();
        
        // 將像素轉換為 mm (大約值，取決於瀏覽器 PPI 報告)
        const pxToMm = 25.4 / 96; // 標準 CSS 像素比例
        const touchX_mm = (rect.right - touch.clientX) * pxToMm; // 從右側計算
        const touchY_mm = (touch.clientY - rect.top) * pxToMm;

        checkNote(touchX_mm, touchY_mm);
    }

    function checkNote(x, y) {
        // 1. 判斷哪條弦 (容錯範圍 ±5mm)
        let activeString = null;
        for (let s in strings) {
            if (Math.abs(x - strings[s].x) < 5) {
                activeString = s;
                break;
            }
        }

        if (!activeString) return;

        // 2. 判斷半音位置
        let closestNote = 0;
        let minDist = 999;
        
        for (let n = 1; n <= 7; n++) { // 檢測到第一把位第 7 半音 (四指)
            let targetY = getDist(n);
            let diff = Math.abs(y - targetY);
            if (diff < minDist) {
                minDist = diff;
                closestNote = n;
            }
        }

        // 3. 10% 容錯檢測
        // 計算該半音與下一個半音間距的 10%
        const stepWidth = getDist(closestNote + 1) - getDist(closestNote);
        const tolerance = stepWidth * 0.1;

        if (minDist <= tolerance) {
            playTone(strings[activeString].baseFreq * Math.pow(2, closestNote / 12));
            feedback.innerText = `準確！ ${activeString} 弦 第 ${closestNote} 半音`;
            feedback.style.color = "#4CAF50";
        } else {
            feedback.innerText = "位置偏差！音準錯誤";
            feedback.style.color = "#FF5252";
            // 可加入一個低沈的錯誤音
        }
    }

    function playTone(freq) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
    }
</script>
</body>
</html>

