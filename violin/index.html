<!DOCTYPE html>
<html lang="zh-TW">
    <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
            <title>Violin 1:1 Pro</title>
        <style>
                    /* 防止選取與手勢干擾 */
                    * {
                                    -webkit-tap-highlight-color: transparent;
                                    user-select: none;
                                    -webkit-user-select: none;
                                    touch-action: none;
                    }

                    body {
                                    margin: 0;
                                    background: #000;
                                    color: white;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    font-family: sans-serif;
                                    height: 100vh;
                                    overflow: hidden;
                    }

                    /* 啟動遮罩：解決所有行動裝置無聲問題 */
                    #overlay {
                                    position: fixed;
                                    top: 0; left: 0; right: 0; bottom: 0;
                                    background: rgba(0,0,0,0.95);
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    z-index: 999;
                    }

                    #start-btn {
                                    padding: 25px 50px;
                                    font-size: 22px;
                                    background: #1db954;
                                    color: white;
                                    border: none;
                                    border-radius: 50px;
                                    box-shadow: 0 4px 15px rgba(29,185,84,0.4);
                    }

                    #fingerboard {
                                    width: 75mm;
                                    height: 160mm;
                                    background: #1a1a1a;
                                    position: relative;
                                    border-top: 8mm solid #333; /* 弦枕 */
                                    margin-top: 20px;
                                    box-shadow: 0 0 50px rgba(255,255,255,0.1);
                    }

                    .string {
                                    width: 2px;
                                    height: 100%;
                                    background: linear-gradient(to right, #ddd, #999);
                                    position: absolute;
                                    top: 0;
                    }

                    /* 弦位置 (由右至左：E, A, D, G) */
                    #string-e { right: 15mm; }
                    #string-a { right: 30mm; }
                    #string-d { right: 45mm; }
                    #string-g { right: 60mm; }

                    /* 準確點位標記 */
                    #marker {
                                    position: absolute;
                                    width: 15mm;
                                    height: 15mm;
                                    background: rgba(29, 185, 84, 0.6);
                                    border: 2px solid #fff;
                                    border-radius: 50%;
                                    transform: translate(-50%, -50%);
                                    display: none;
                                    justify-content: center;
                                    align-items: center;
                                    font-size: 20px;
                                    font-weight: bold;
                                    pointer-events: none;
                    }
                </style>
    </head>
    <body oncontextmenu="return false;">

        <div id="overlay">
                <button id="start-btn">點擊啟動 (解鎖音效)</button>button>
        </div>div>

        <div id="info" style="padding: 20px; color: #aaa;">4/4 小提琴第一把位實體練習</div>div>

        <div id="fingerboard">
                <div id="marker"></div>div>
                <div class="string" id="string-g"></div>div>
                <div class="string" id="string-d"></div>div>
                <div class="string" id="string-a"></div>div>
                <div class="string" id="string-e"></div>div>
        </div>div>

        <script>
                let audioCtx = null;
                let activeOsc = null;
                const marker = document.getElementById('marker');
                const fingerboard = document.getElementById('fingerboard');
                const overlay = document.getElementById('overlay');

                // 初始化音訊環境
                function initAudio() {
                            if (!audioCtx) {
                                            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                            }
                            if (audioCtx.state === 'suspended') {
                                            audioCtx.resume();
                            }
                            overlay.style.display = 'none';
                }

                document.getElementById('start-btn').addEventListener('click', initAudio);

                const L = 328; // 4/4 小提琴弦長 mm
                const strings = {
                            'E': { x: 15, baseFreq: 659.25, notes: ["E","F","F#","G","G#","A","A#","B"] },
                            'A': { x: 30, baseFreq: 440.00, notes: ["A","A#","B","C","C#","D","D#","E"] },
                            'D': { x: 45, baseFreq: 293.66, notes: ["D","D#","E","F","F#","G","G#","A"] },
                            'G': { x: 60, baseFreq: 196.00, notes: ["G","G#","A","A#","B","C","C#","D"] }
                };

                function getDist(n) { return L * (1 - Math.pow(0.5, n / 12)); }

                function handleInput(e) {
                            e.preventDefault();
                            const touch = e.touches ? e.touches[0] : e;
                            const rect = fingerboard.getBoundingClientRect();
                            const pxToMm = 25.4 / 96; // 假設標準 96dpi

                            const relX_px = touch.clientX - rect.left;
                            const relY_px = touch.clientY - rect.top;

                            // 換算 mm
                            const touchX_mm = (rect.width - relX_px) * pxToMm;
                            const touchY_mm = relY_px * pxToMm;

                            let selectedStr = null;
                            for (let s in strings) {
                                            if (Math.abs(touchX_mm - strings[s].x) < 7) {
                                                                selectedStr = s;
                                                                break;
                                            }
                            }

                            if (!selectedStr) {
                                            stopSound();
                                            return;
                            }

                            let closestN = -1;
                            let minDist = 999;
                            for (let n = 1; n <= 7; n++) {
                                            let d = getDist(n);
                                            if (Math.abs(touchY_mm - d) < minDist) {
                                                                minDist = Math.abs(touchY_mm - d);
                                                                closestN = n;
                                            }
                            }

                            const step = getDist(closestN + 1) - getDist(closestN);
                            if (minDist <= step * 0.1) {
                                            const freq = strings[selectedStr].baseFreq * Math.pow(2, closestN / 12);
                                            marker.style.display = 'flex';
                                            marker.style.left = relX_px + 'px';
                                            marker.style.top = relY_px + 'px';
                                            marker.textContent = strings[selectedStr].notes[closestN];
                                            playSound(freq);
                            } else {
                                            playTap();
                                            stopSound();
                            }
                }

                function playSound(freq) {
                            if (activeOsc && Math.abs(activeOsc.frequency.value - freq) < 1) return;
                            stopSound();
                            activeOsc = audioCtx.createOscillator();
                            let gain = audioCtx.createGain();
                            activeOsc.type = 'sawtooth';
                            activeOsc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                            gain.gain.setValueAtTime(0.15, audioCt l Cltf
        </script>
        </style></title>
    </head>
