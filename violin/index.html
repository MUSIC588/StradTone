<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StradTone Violin</title>

  <style>
    /* =====================================================
     * [CSS] 100% ÂéüÂßã‰øùÁïôÊÇ®ÁöÑ StradTone 8 Ê®£Âºè
     * ===================================================== */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, "Microsoft JhengHei", sans-serif; background: #222629; color: #f5f5f5; }
    .page { min-height: 100vh; padding: 12px; max-width: 1100px; margin: 0 auto; }
    header { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: baseline; gap: 8px; flex-wrap: wrap; }
    header h1 { font-size: 20px; margin: 0; }
    header h2 { font-size: 14px; margin: 0; opacity: 0.8; }
    header small { font-size: 12px; opacity: 0.7; }
    main.layout { display: flex; gap: 12px; align-items: stretch; }
    .panel { background: #2d3236; border-radius: 8px; padding: 10px; box-shadow: 0 0 8px rgba(0, 0, 0, 0.35); min-height: 220px; }
    .panel-left  { flex: 0 0 40%; max-width: 40%; display: flex; flex-direction: column; }
    .panel-right { flex: 0 0 60%; max-width: 60%; display: flex; flex-direction: column; }
    h2 { font-size: 16px; margin: 0 0 4px; }
    .hint, .reply-note { font-size: 12px; line-height: 1.4; color: #222629; }
    .hidden { display: none !important; }
    input::placeholder, textarea::placeholder { color: #999; opacity: 0.7; }
    
    /* CSS-1: Â∑•ÂÖ∑ÂàóËàáË°®ÂñÆ */
    .toolbar { display: flex; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; }
    .toolbar button { padding: 4px 10px; border-radius: 14px; border: 1px solid #777; background: #3a3f44; color: #f5f5f5; font-size: 12px; cursor: pointer; }
    form#community-form { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; padding: 6px 8px; border-radius: 6px; border: 1px solid #d1a343; background: #141b20; box-shadow: 0 0 10px rgba(0,0,0,0.65); }
    form#community-form input[type="text"] { width: 100%; padding: 4px 6px; margin-top: 2px; border-radius: 4px; border: 1px solid #555; background: #1f2326; color: #f5f5f5; font-size: 13px; }
    form#community-form input[type="text"]:not(:disabled) { background: #ffffff; color: #111; }
    #submit-btn { padding: 4px 14px; border-radius: 16px; border: none; background: #d1a343; color: #1d1d1d; font-size: 13px; cursor: pointer; }
    
    /* ÈúÄÊ±Ç 5 Ê®£Âºè */
    .media-record-toolbar { display: flex; align-items: center; gap: 6px; margin-top: 4px; font-size: 11px; }
    .media-record-btn { width: 26px; height: 26px; border-radius: 50%; border: 1px solid #777; background: #3a3f44; color: #f5f5f5; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .media-record-btn.recording { color: #ff4b4b; border-color: #ff8080; background: #4a3a3a; animation: recordBlink 0.8s ease-in-out infinite; }
    .media-record-btn.paused-steady { color: #ff4b4b; border-color: #ff8080; background: #4a3a3a; animation: none !important; }
    .media-record-btn.pause-active { color: #ff4b4b; border-color: #ff8080; }
    @keyframes recordBlink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

    /* CSS-2: Ë°®Ê†ºÂçÄÂüü */
    .comments-wrapper { flex: 1 1 auto; overflow-y: auto; border-radius: 6px; border: 1px solid #444; background: #202427; }
    table#comments-table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
    table#comments-table thead { position: sticky; top: 0; background: #33383c; z-index: 1; }
    table#comments-table td, table#comments-table th { border-bottom: 1px solid #333; padding: 4px 6px; text-align: left; vertical-align: top; word-wrap: break-word; }
    #comments-tbody tr.selected { background: #4f7a3b !important; }
    .row-edit-btn { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; margin-right: 4px; border-radius: 4px; border: 1px solid #888; background: #3a3f44; font-size: 12px; cursor: pointer; }

    /* CSS-3: Ë¶ñË¶∫ÂçÄ */
    .video-frame-wrap { flex: 1 1 60%; background: #111315; border-radius: 6px; overflow: hidden; border: 1px solid #555; position: relative; min-height: 150px; }
    .video-frame-wrap iframe { width: 100%; height: 100%; border: none; }
    #audio-player { position: absolute; left: 0; right: 0; bottom: 0; width: 100%; background: #111315; display: none; }
    .circle-stack { position: relative; width: 160px; height: 160px; border-radius: 50%; background: radial-gradient(circle at 20% 20%, #555, #111); }
    .ring { position: absolute; border-radius: 50%; transition: all 0.12s ease; }
    .ring-main { border: 3px solid #5c7a5c; opacity: 0.8; }
    .ring-boundary { border: 1.2px solid #9ad09a; opacity: 0.7; }
    .ring-b45 { inset: 4%; } .ring-4 { inset: 10%; } .ring-b35 { inset: 20%; } .ring-3 { inset: 26%; } .ring-b25 { inset: 36%; } .ring-2 { inset: 42%; } .ring-b15 { inset: 52%; } .ring-1 { inset: 60%; }
    .ring.active { border-color: #70ff70; opacity: 1; box-shadow: 0 0 10px rgba(140, 255, 140, 0.9); }
    #admin-reply { width: 100%; background: #1f2326; border: 1px solid #555; color: #f5f5f5; font-size: 12px; border-radius: 4px; min-height: 80px; resize: none; overflow: hidden; line-height: 1.4; }
    .fingerboard { position: relative; width: 120px; height: 260px; background: linear-gradient(180deg, #181a1d, #34383d); border-radius: 14px; border: 2px solid #676f78; box-shadow: 0 0 10px rgba(0, 0, 0, 0.55); }
    .fb-string { position: absolute; top: 6%; bottom: 6%; width: 2px; background: linear-gradient(180deg, #cfcfcf, #888); opacity: 0.9; }
    .fb-s1 { left: 20%; transform: skewX(-3deg); } .fb-s2 { left: 40%; transform: skewX(-1.5deg); } .fb-s3 { left: 62%; transform: skewX(1.5deg); } .fb-s4 { left: 80%; transform: skewX(3deg); }
    .fingerboard-note { position: absolute; font-size: 10px; color: #fdf5c5; pointer-events: none; }

    @media (max-width: 820px) {
      main.layout { flex-direction: column; }
      #visual-panel { order: 1; }
      #comments-section { order: 2; }
      .panel-left, .panel-right { max-width: 100%; width: 100%; border-radius: 0; }
      .video-frame-wrap { height: 160px !important; }
      .bottom-row { display: flex; flex-direction: row; }
    }
  </style>
</head>

<body>
  <div class="page">
    <header><h1>StradTone Violin</h1><h2>ÊèêÁê¥ËÅ≤Â≠∏ÂØ¶È©óÂÆ§</h2></header>

    <main class="layout">
      <section class="panel panel-left" id="comments-section">
        <div class="toolbar"><button type="button" id="btn-new">Êñ∞Â¢û</button></div>
        <form id="community-form" class="hidden">
          <label>usernameÔºö<input type="text" id="nickname-input" maxlength="12" /></label>
          <label>È†ÖÁõÆÔºö<input type="text" id="text-input" maxlength="100" /></label>
          <div class="media-select-row">
            <button type="button" class="media-select-btn" id="btn-media-youtube">YouTube</button>
            <button type="button" class="media-select-btn" id="btn-media-upload">ÂΩ±Áâá</button>
            <button type="button" class="media-select-btn" id="btn-media-audio">ÈåÑÈü≥</button>
          </div>
          <div id="video-fields" class="hidden">
            <div class="form-row-inline"><input type="text" id="youtube-url-input" placeholder="YouTube Link" /></div>
            <div class="form-row-inline"><input type="file" id="video-file-input" /></div>
          </div>
          <div id="audio-fields" class="hidden">
            <div class="media-record-toolbar" id="audio-record-toolbar">
              <button type="button" class="media-record-btn" id="audio-rec-start">‚óè</button>
              <button type="button" class="media-record-btn" id="audio-rec-pause" disabled>‚è∏</button>
              <button type="button" class="media-record-btn" id="audio-rec-stop" disabled>‚ñ†</button>
              <button type="button" class="media-record-btn" id="audio-rec-cancel" disabled>‚úï</button>
              <span id="audio-rec-status">ÈåÑÈü≥È†êÂÇô</span>
            </div>
            <input type="file" id="audio-file-input" accept="audio/*" />
            <audio id="audio-rec-preview" class="rec-preview" controls></audio>
          </div>
          <button type="submit" id="submit-btn">ÁôºË°®</button>
        </form>
        <div class="comments-wrapper"><table id="comments-table">
          <thead><tr><th>username</th><th>È†ÖÁõÆ <button type="button" id="btn-edit" class="edit-header-btn">Á∑®ËºØ</button></th><th>ÂΩ±Èü≥</th></tr></thead>
          <tbody id="comments-tbody"></tbody>
        </table></div>
        <button id="back-button" type="button">Back</button>
      </section>

      <section class="panel panel-right" id="visual-panel">
        <div class="visual-body">
          <div class="top-row">
            <div class="video-frame-wrap"><iframe id="video-iframe"></iframe><audio id="audio-player" controls></audio><div class="video-placeholder" id="video-placeholder">Ë´ãÈÅ∏ÂèñÈ†ÖÁõÆ</div></div>
            <div class="circle-area"><div class="circle-stack" id="circle-stack">
              <div class="ring ring-main ring-1" data-layer="1"></div><div class="ring ring-main ring-2" data-layer="2"></div>
              <div class="ring ring-main ring-3" data-layer="3"></div><div class="ring ring-main ring-4" data-layer="4"></div>
              <div class="ring ring-boundary ring-b15" data-layer="1.5"></div><div class="ring ring-boundary ring-b25" data-layer="2.5"></div>
              <div class="ring ring-boundary ring-b35" data-layer="3.5"></div><div class="ring ring-b45" data-layer="4.5"></div>
            </div></div>
          </div>
          <div class="bottom-row">
            <div class="reply-area">
              <div class="reply-target"><button type="button" id="reply-target-btn" class="reply-target-btn" disabled>From: ‚Äî</button></div>
              <textarea id="admin-reply" placeholder="ÊèêÁê¥ËÅ≤Â≠∏ÂØ¶È©óÂÆ§Ôºö"></textarea>
              <div class="reply-actions hidden" id="reply-actions"><button type="button" id="reply-save-btn">ÂÑ≤Â≠ò</button><button type="button" id="reply-cancel-btn">ÂèñÊ∂à</button></div>
            </div>
            <div class="fingerboard-row"><div class="fingerboard" id="fingerboard">
              <div class="fb-string fb-s1"></div><div class="fb-string fb-s2"></div><div class="fb-string fb-s3"></div><div class="fb-string fb-s4"></div>
              <div class="fingerboard-note" style="left:24%; top:8%;">G0</div><div class="fingerboard-note" style="left:24%; top:26%;">G3</div>
              <div class="fingerboard-note" style="left:38%; top:18%;">D5</div><div class="fingerboard-note" style="left:38%; top:40%;">D8</div>
              <div class="fingerboard-note" style="left:62%; top:22%;">A7</div><div class="fingerboard-note" style="left:62%; top:44%;">A10</div>
              <div class="fingerboard-note" style="left:76%; top:30%;">E9</div><div class="fingerboard-note" style="left:76%; top:52%;">E12</div>
            </div></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // =====================================================
    // [JS-ÂÆåÊï¥Âæ©Âéü] 100% ÂõûÊ≠∏ StradTone 8 ÁµêÊßã
    // =====================================================
    const API_URL = "https://script.google.com/macros/s/AKfycbxn5aDCimtZmvgK4uEGr5fIyNItY2wZgQyO2LVEZkggFkO0VZ_YdDMyspGpzpkYy5W6-A/exec";
    let commentsCache = [];
    let currentSelectedId = null;
    const REPLY_PREFIX = "ÊèêÁê¥ËÅ≤Â≠∏ÂØ¶È©óÂÆ§Ôºö";
    let isFormOpen = false, isSubmitting = false;
    let editState = { active: false, id: null, nickname: "", originalText: "", waitForSelect: false };
    window.recordedAudioBlob = null;
    let audioRecStream = null, audioRecRecorder = null, audioRecChunks = [], audioRecActive = false, audioRecPaused = false, audioRecTimerId = null, audioRecStartTime = 0;

    function normalizeName(n) { return String(n || "").replace(/\u200B/g, "").trim(); }
    function maskName(n) { let s = normalizeName(n); if (!s) return "ÂåøÂêç"; if (s.length <= 2) return s[0] + "*"; return s[0] + "*".repeat(s.length - 2) + s[s.length - 1]; }
    function validateNameLength(n) { let s = normalizeName(n); return s.length >= 5 && s.length <= 12 && /^[A-Za-z0-9\u4E00-\u9FFF]+$/.test(s); }
    function escapeHtml(s) { return String(s || "").replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c])); }
    function scrollToVideoTop() { window.scrollTo({ top: 0, behavior: "smooth" }); }
    function readFileAsBase64(f) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => { const s = r.result || ""; const i = s.indexOf(","); res(i >= 0 ? s.slice(i + 1) : s); }; r.onerror = () => rej(r.error); r.readAsDataURL(f); }); }

    async function loadComments() {
      const res = await fetch(API_URL + "?action=list", { cache: "no-cache" });
      const data = await res.json();
      commentsCache = data.posts || [];
      renderCommentsTable();
      const newestMedia = commentsCache.slice().reverse().find(r => r.type !== "text");
      if (newestMedia) selectRowForReply(newestMedia, false);
    }

    function renderCommentsTable() {
      const tbody = document.getElementById("comments-tbody");
      if (!tbody) return;
      tbody.innerHTML = commentsCache.slice().reverse().map(row => {
        const selected = String(row.id) === String(currentSelectedId) ? ' class="selected"' : "";
        const editBtn = editState.waitForSelect ? `<button type="button" class="row-edit-btn" data-id="${row.id}">‚úé</button>` : "";
        const hasMedia = (row.type !== "text") ? "üé¨" : "‚Äî";
        return `<tr data-id="${row.id}"${selected}><td>${escapeHtml(maskName(row.nickname))}</td><td>${editBtn}${escapeHtml(row.text.slice(0, 30))}</td><td>${hasMedia}</td></tr>`;
      }).join("");
    }

    function selectRowForReply(row, fromEdit) {
      if (!row) return;
      if (!fromEdit && (editState.active || isFormOpen)) resetFormToAddMode();
      currentSelectedId = row.id; renderCommentsTable();
      const btn = document.getElementById("reply-target-btn");
      if (btn) { btn.textContent = "From: " + maskName(row.nickname); btn.disabled = false; btn.setAttribute("data-id", row.id); }
      document.getElementById("admin-reply").value = row.reply ? row.reply : REPLY_PREFIX + "\n";
      showVideoForRow(row); scrollToVideoTop();
    }

    function showVideoForRow(row) {
      const i = document.getElementById("video-iframe"), a = document.getElementById("audio-player");
      i.src = ""; a.pause(); i.style.display="none"; a.style.display="none";
      if (!row) return;
      if (row.type === "youtube") {
        i.src = `https://www.youtube-nocookie.com/embed/${row.youtubeUrl.split('v=')[1] || row.youtubeUrl.split('/').pop()}?autoplay=1&rel=0`;
        i.style.display="block";
      } else if (row.type === "audio") {
        a.src = row.audioUrl || (row.driveAudioId ? `https://drive.google.com/uc?export=download&id=${row.driveAudioId}` : "");
        a.style.display="block"; a.play().catch(()=>{});
      }
      highlightLayers(row.layers);
    }

    function highlightLayers(l) { document.querySelectorAll(".ring").forEach(r => r.classList.remove("active")); if (!l) return; l.split(",").forEach(v => { let r = document.querySelector(`.ring[data-layer="${v.trim()}"]`); if (r) r.classList.add("active"); }); }

    function setupReplyTargetButton() {
      document.getElementById("reply-target-btn")?.addEventListener("click", () => {
        const id = document.getElementById("reply-target-btn").getAttribute("data-id");
        const tr = document.querySelector(`tr[data-id="${id}"]`);
        if (tr) { tr.scrollIntoView({ behavior: "smooth", block: "center" }); tr.classList.add("row-flash"); setTimeout(() => tr.classList.remove("row-flash"), 800); }
      });
    }

    function setupAdminReply() {
      const box = document.getElementById("admin-reply");
      box?.addEventListener("keydown", (e) => { if (box.selectionStart <= REPLY_PREFIX.length && ["Backspace", "Delete"].includes(e.key)) e.preventDefault(); });
      box?.addEventListener("input", () => { if (!box.value.startsWith(REPLY_PREFIX)) box.value = REPLY_PREFIX + "\n" + box.value.trim(); document.getElementById("reply-actions").classList.remove("hidden"); });
    }

    // [JS-19: ÈåÑÈü≥ÂÑ™ÂåñÂæÆÂâµÊâãË°ì]
    function setupAudioRecording() {
      const bStart = document.getElementById("audio-rec-start"), bPause = document.getElementById("audio-rec-pause"), bStop = document.getElementById("audio-rec-stop"), sEl = document.getElementById("audio-rec-status");
      bStart?.addEventListener("click", async () => {
        if (audioRecActive) return;
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioRecStream = stream; audioRecRecorder = new MediaRecorder(stream);
          audioRecChunks = []; audioRecRecorder.ondataavailable = e => audioRecChunks.push(e.data);
          audioRecRecorder.onstop = () => { window.recordedAudioBlob = new Blob(audioRecChunks, { type: 'audio/webm' }); document.getElementById("audio-rec-preview").src = URL.createObjectURL(window.recordedAudioBlob); };
          audioRecRecorder.start(); audioRecActive = true; audioRecStartTime = Date.now();
          audioRecTimerId = setInterval(() => { if(!audioRecPaused) sEl.textContent = "ÈåÑÈü≥‰∏≠‚Ä¶ " + formatDuration((Date.now() - audioRecStartTime)/1000); }, 500);
          bStart.classList.add("recording"); bStart.classList.remove("paused-steady"); bPause.disabled = false; bStop.disabled = false;
        } catch (e) { sEl.textContent = "ÂïüÂãïÂ§±Êïó"; }
      });
      bPause?.addEventListener("click", () => {
        if (!audioRecRecorder) return;
        if (!audioRecPaused) {
          audioRecRecorder.pause(); audioRecPaused = true; bPause.classList.add("pause-active");
          bStart.classList.remove("recording"); bStart.classList.add("paused-steady");
        } else {
          audioRecRecorder.resume(); audioRecPaused = false; bPause.classList.remove("pause-active");
          bStart.classList.remove("paused-steady"); bStart.classList.add("recording");
        }
      });
      bStop?.addEventListener("click", () => {
        audioRecRecorder?.stop(); if (audioRecStream) audioRecStream.getTracks().forEach(t => t.stop());
        clearInterval(audioRecTimerId); audioRecActive = false; audioRecPaused = false;
        bStart.classList.add("hidden"); bPause.classList.add("hidden"); sEl.textContent = "ÈåÑÈü≥ÂÆåÊàê„ÄÇ";
      });
    }

    function formatDuration(sec) { const s = Math.max(0, sec | 0); const m = (s / 60) | 0; const r = s % 60; return (m < 10 ? "0" + m : m) + ":" + (r < 10 ? "0" + r : r); }

    async function handleSubmit(e) {
      e.preventDefault(); if (isSubmitting) return;
      const btn = document.getElementById("submit-btn");
      const nick = normalizeName(document.getElementById("nickname-input").value), text = document.getElementById("text-input").value.trim();
      if (!validateNameLength(nick) || !text) return;
      isSubmitting = true; btn.disabled = true; btn.textContent = "ËôïÁêÜ‰∏≠..";
      try {
        const payload = { action: (editState.active ? "edit" : "add"), nickname: nick, text: text };
        const vFile = document.getElementById("video-file-input").files[0], aFile = document.getElementById("audio-file-input").files[0], yt = document.getElementById("youtube-url-input").value.trim();
        if (yt) { payload.type = "youtube"; payload.youtubeUrl = yt; }
        else if (vFile) { payload.type = "upload"; payload.videoBase64 = await readFileAsBase64(vFile); payload.fileName = vFile.name; }
        else if (aFile || window.recordedAudioBlob) {
          const blob = aFile || window.recordedAudioBlob;
          payload.type = "audio"; payload.audioBase64 = await readFileAsBase64(blob); payload.audioFileName = aFile ? aFile.name : "recorded.webm";
        }
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        if ((await res.json()).status === "ok") { resetFormToAddMode(); await loadComments(); }
      } catch (err) { alert("Â§±Êïó"); } finally { isSubmitting = false; btn.disabled = false; btn.textContent = "ÁôºË°®"; }
    }

    function resetFormToAddMode() { 
      isFormOpen = false; editState.active = false; document.getElementById("community-form").classList.add("hidden"); 
      document.getElementById("nickname-input").value = ""; document.getElementById("text-input").value = "";
      document.getElementById("audio-rec-start").classList.remove("hidden"); document.getElementById("audio-rec-pause").classList.remove("hidden");
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadComments(); setupAdminReply(); setupReplyTargetButton(); setupAudioRecording();
      document.getElementById("btn-new").addEventListener("click", () => { if (isFormOpen) resetFormToAddMode(); else { isFormOpen = true; document.getElementById("community-form").classList.remove("hidden"); } });
      document.getElementById("btn-edit").addEventListener("click", () => { editState.waitForSelect = !editState.waitForSelect; renderCommentsTable(); });
      document.getElementById("community-form").addEventListener("submit", handleSubmit);
      document.getElementById("comments-tbody").addEventListener("click", e => {
        const tr = e.target.closest("tr"); if (tr) selectRowForReply(commentsCache.find(r => String(r.id) === tr.dataset.id), false);
      });
    });
  </script>
</body>
</html>

